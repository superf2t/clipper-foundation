<!doctype html>
<html>
<head>
  <title>{{plan.name}}</title>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="//maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular.min.js"></script>
  <script src="/static/js/ui-bootstrap-tpls-0.10.9.js"></script>
  <script src="/static/js/services.js"></script>  
  <script src="/static/js/script.js"></script>
  <link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400|Raleway:400">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="shortcut icon" href="/static/img/globe.png">
</head>
<body ng-controller="RootCtrl">
  <nav class="navbar navbar-default navbar-fixed-top" role="navigation" id="travel-clip-navbar">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" id="logo" href="#">TravelClip</a>
      </div>
      <div class="collapse navbar-collapse" id="header-navbar-collapse">
        <ul class="nav navbar-nav navbar-right" id="header-site">
          <li>
            <ul class="nav nav-pills">
              <li class="view-mode-pill">
                <a href="javascript:void(0)" ng-click="toggleAccountDropdown()">
                  <span class="glyphicon glyphicon-user" id="header-user"></span>
                </a>
              </li>
            <ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div>
    <div id="entity-container"
      tc-entity-scroll scroll-state="scrollState"
      scroll-highlight-class="one-entity-highlighted" scroll-highlight-duration="2000"
      tc-set-scroll-top set-scroll-on-changes-to="itemGroups" set-scroll-top="34">

      <div ng-include="'trip-plan-header-template'">
      </div>

      <div ng-repeat="itemGroupModel in itemGroups">
        <div ng-include="'item-group-template'">
        </div>
      </div>

      <div ng-if="planModel.isEmpty()">
        <div ng-include="'mapview-getting-started-template'">
        </div>
      </div>

      <div class="mapview-footer">
        Copyright 2014 Unicycle Labs
      </div>

    </div>

    <div id="right-panel" ng-class="{'map-view': pageStateModel.inMapView(), 'gallery-view': pageStateModel.inGalleryView()}">
      <div id="gallery-panel">
        <div ng-include="'gallery-panel-template'" class="full-height">
        </div>
      </div>
      <div id="info-panel">
        <div id="map-container">
          <div id="map">
          </div>
          <div id="page-mode-toggle-control">
            <a ng-click="showGalleryView()" ng-show="!pageStateModel.inGalleryView() && pageStateModel.selectedEntity"
              href="javascript:void(0)">
              Show Gallery View
              <span class="glyphicon glyphicon-chevron-right"></span>
            </a>
            <a ng-click="showMapView()" ng-show="!pageStateModel.inMapView()" href="javascript:void(0)">
              Show Map View
              <span class="glyphicon glyphicon-chevron-left"></span>
            </a>
          </div>
        </div>
        <div id="entity-info-box">
          <div class="description">[[pageStateModel.selectedEntity['description'] ]]</div>
        </div>
      </div>
    </div>

  </div>  {# end map view #}

  {# This is below the map in the DOM so that it appears visually on top #}
  <ul ng-show="accountDropdownOpen" class="account-dropdown" ng-controller="AccountDropdownCtrl">
    <li class="account-dropdown-login-info">
      <div ng-show="accountInfo.loggedIn && !showLoginForm">
        <span class="logged-in-email">[[accountInfo['email'] ]]</span>
        <span class="logout-link">
          <a href="javascript:void(0)" ng-click="showLoginForm = true">Logout</a>
        </span>
      </div>
      <div ng-show="showLoginForm">
        <form role="form" ng-submit="doLogin()">
          <input type="text" class="form-control email-entry-input"
            ng-model="accountInfo['email']"
            placeholder="Enter your email to login"/>
          <button type="submit()" class="btn btn-default btn-login">Login</button>
        </form>
      </div>
    </li>
    <li ng-show="allTripPlans">
      <div class="my-trip-plans-heading">
        My Trip Plans
      </div>
    </li>
    <li ng-repeat="tripPlan in allTripPlans">
      <span ng-if="tripPlan['trip_plan_id'] == currentTripPlan['trip_plan_id']">
        {# Use the name from the shared info container so it will auto update 
           if the user edits it inline. #}
        [[currentTripPlan['name'] ]]
      </span>
      <span ng-if="tripPlan['trip_plan_id'] != currentTripPlan['trip_plan_id']">
          <a href="javascript:void(0)" ng-click="loadTripPlan(tripPlan['trip_plan_id'])">
            [[tripPlan['name'] ]]
          </a>
        </span>
    </li>
    <li class="create-new-trip-dropdown-link">
      <a href="javascript:void(0)" ng-click="createNewTripPlan()">Create New Trip Plan</a>
    </li>
  </ul>

  <script type="text/ng-template" id="infowindow-template">
    <div>
      <div>
        <b>[[entity.data['name'] ]]</b>
      </div>
      <div class="infowindow-address">
        [[entity.data['address'] ]]
      </div>
      <div ng-if="!entity.isPreciseLocation()" class="text-warning infowindow-warning-text">
        Location approximate
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="reclip-confirmation-template">
    <div ng-controller="ReclipConfirmationCtrl" class="reclip-confirmation-modal">
      <div ng-show="!reclipSucceeded">
        <div>Reclip <b>[[ed['name'] ]]</b> to:</div>
        <div tc-trip-plan-select-dropdown select-trip-plan-to="selectionState.selectedTripPlan" class="reclip-confirmation-trip-plan-dropdown"></div>
        <div ng-show="showSaveButtons()">
          <button class="btn btn-primary" ng-click="reclipEntity()">
            Save
          </button>
          <button class="btn" ng-click="dismissReclipConfirmation()">
            Cancel
          </button>
        </div>
      </div>

      <div ng-show="reclipSucceeded">
        <div class="clip-success-checkmark">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="40px" height="40px" viewBox="0 0 95.453 100" enable-background="new 0 0 95.453 100" xml:space="preserve">
          <g>
            <g>
              <polygon points="94.587,27.48 31.657,86.15 31.217,85.68 18.847,72.41 0.566,52.81 14.106,40.19 32.387,59.79 81.776,13.74"/>
            </g>
          </g>
          </svg>
        </div>
        Successfully clipped <b>[[ed['name'] ]]</b> to
        <a href="/trip_plan/[[selectionState.selectedTripPlan['trip_plan_id'] ]]" target="_blank">
          [[selectionState.selectedTripPlan['name'] ]]
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="add-place-confirmation-template">
    <div ng-controller="AddPlaceConfirmationCtrl" class="add-place-confirmation">
      <div ng-show="!editingFields">
        <div class="apc-place-name">
          [[ed['name'] ]]
        </div>
        <div class="apc-address">
          [[ed['address'] ]]
        </div>

        <div class="container-fluid">
          <div class="row-fluid">
            <div class="col-md-6 flush-left">
              <div class="apc-photo-container">
                <div ng-include="'carousel-template'">
                </div>
              </div>
              <div class="apc-place-details">
                <div class="apc-rating">
                  <tc-star-rating value="[[ed['rating'] ]]">
                  </tc-star-rating>
                </div>
                <div class="apc-category">
                  Category: [[ed['category']['display_name'] ]]
                </div>
                <div class="apc-sub-category">
                  SubCategory: [[ed['sub_category']['display_name'] ]]
                </div>
              </div>
            </div>
            <div class="col-md-6 flush-right">
              <div ng-show="entityModel.hasLocation()">
                <div id="apc-static-map-container">
                  <div id="apc-static-map"></div>
                </div>
                <div ng-if="!entityModel.isPreciseLocation()" class="text-warning">
                  Location is approximate
                </div>
              </div>
              <div ng-if="!entityModel.hasLocation()" class="text-warning">
                Location unknown
              </div>                
            </div>            
          </div>
        </div>
      </div>

      <div ng-show="editingFields" class="apc-edit-mode">
        <div class="apc-place-name-edit">
          <label>Name</label>
          <input id="apc-edit-name-input" type="text" ng-model="ed['name']" class="form-control apc-edit-input"/>
        </div>
        <div class="apc-address-edit">
          <label>Address</label>
          <input id="apc-edit-address-input" type="text" ng-model="ed['address']" class="form-control apc-edit-input"/>
        </div>
        <div class="container-fluid">
          <div class="row">
            <div class="col-md-6 flush-left">
              <div class="apc-photo-container-edit" ng-controller="EditImagesCtrl">
                <label>Images</label>
                <div class="carousel">
                  <a class="left carousel-control" ng-show="hasPrevImg()" ng-click="prevImg()">
                    <span class="icon-prev"></span>
                  </a>
                  <a class="apc-img-trash-control" ng-click="removeActiveImg()" href="javascript:void(0)">
                    Delete Image<span class="glyphicon glyphicon-trash"></span>
                  </a>
                  <img ng-src="[[currentImgUrl]]" class="entity-img"/>
                  <a class="right carousel-control" ng-show="hasNextImg()" ng-click="nextImg()">
                    <span class="icon-next"></span>
                  </a>
                </div>
                <div class="apc-image-edit-container">
                  <textarea type="text" placeholder="Drag images or paste image Urls to add"
                    class="apc-image-drop-target apc-edit-input"
                    ng-model="photoUrlInputText"
                    ng-paste="photoUrlPasted()"
                    ng-change="photoUrlChanged()"
                    ng-class="{'apc-img-drag-active': imgDragActive}"
                    tc-dragenter="photoUrlDragEnter($event)"
                    tc-drop="photoUrlDropped($event)"
                    />
                  </textarea>
                </div>                
              </div>
              <div class="apc-place-details-edit">
                <div class="apc-description-edit">
                  <label>Description</label>
                  <textarea class="form-control apc-edit-input" ng-model="ed['description']">
                  </textarea>
                </div>
                <div class="apc-rating-edit">
                  <form class="form-inline" role="form">
                    <label>Rating</label>
                    <input type="number" ng-model="ed['rating']" class="form-control apc-edit-input"/>
                  </form>
                </div>
                <div class="apc-category-edit">
                  <form class="form-inline" role="form">
                    <label>Category</label>
                    <select class="form-control" ng-model="ed['category']"
                      ng-options="c['display_name'] for c in categories track by c['category_id']"
                      ng-change="categoryChanged()">
                    </select>
                  </form>
                </div>
                <div class="apc-sub-category-edit">
                  <form class="form-inline" role="form">
                    <label>SubCategory</label>
                    <select class="form-control" ng-model="entityModel.data['sub_category']"
                      ng-options="s['display_name'] for s in subCategories track by s['sub_category_id']"
                      ng-change="updateMarkerIcon()">
                    </select>
                  </form>
                </div>
              </div>
            </div>
            <div class="col-md-6 flush-right">
              <div class="apc-editable-map">
                <label>Map</label>
                <div id="apc-editable-map-container">
                  <div id="apc-editable-map"></div>
                </div>
                <div class="apc-editable-map-header" ng-show="entityModel.hasLocation()">
                  Drag the marker to change the location
                </div>
                <div ng-if="!entityModel.hasLocation()">
                  <button class="btn btn-info">Add a marker to the map</button>
                </div>
              </div>
              <div class="apc-map-precision-edit">
                <label>Location precision</label>
                <form class="form-inline" role="form">
                  <input type="radio" class="form-control" value="Precise" ng-model="ed['address_precision']" ng-change="updateMarkerIcon()" id="precise-radio"/>
                  <label for="precise-radio" class="light-label">Exact location</label>
                  <input type="radio" class="form-control" value="Imprecise" ng-model="ed['address_precision']" ng-change="updateMarkerIcon()" id="imprecise-radio"/>
                  <label for="imprecise-radio" class="light-label">Approximate location</label>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="apc-controls">
        <div class="apc-control-edit-link">
          <a ng-click="openEditFields()" ng-show="!editingFields" href="javascript:void(0)">Edit</a>
        </div>
        <div class="apc-control-buttons">
          <button class="btn btn-primary" ng-click="saveNewEntity()" ng-show="!isEditOfExistingEntity">
            Add to Trip Plan
          </button>
          <button class="btn btn-primary" ng-click="saveChangesToExistingEntity()" ng-show="isEditOfExistingEntity">
            Save Changes
          </button>          
          <button class="btn btn-default" ng-click="cancelConfirmation()">
            Cancel
          </button>
        </div>
      </div>

    </div>
  </script>

  <script type="text/ng-template" id="day-planner-template">
    <div ng-controller="DayPlannerCtrl" class="day-planner-modal">
      <div class="day-planner-header">
        <div class="day-planner-header-text">Day Planner</div>
        <div class="day-planner-persistent-controls">
          <button class="btn btn-primary" ng-click="saveOrderings()">
            Save
          </button>
          <button class="btn" ng-click="$close()">
            Cancel
          </button>
        </div>
      </div>
      <div class="container-fluid day-planner-body">
        <div class="row-fluid">
          <div class="col-md-5 day-planner-left-panel"
            ng-class="{'dragactive': showLeftPanelDragActive(), 'dragover': showLeftPanelDragover()}"
            tc-dragenter="onLeftPanelDragenter($event)"
            tc-dragleave="leftPanelDragover = false"
            tc-dragover="onLeftPanelDragover($event)"
            tc-dragend="onDragend(); leftPanelDragover = false"
            tc-drop="handleLeftPanelDrop($event)"
          >
            <h4 class="day-planner-panel-header">Unsorted</h4>
            <div ng-repeat="item in dpm.unorderedItems" class="day-planner-unsorted-item">
              <tc-draggable-entity item="item" drag-item="dragItem"
                on-dragstart="onDragstart($event, item)" on-dragend="onDragend()">
              </tc-draggable-entity>
            </div>
          </div>
          <div class="col-md-7 day-planner-right-panel">
            <div ng-repeat="dayModel in dpm.dayModels">
              <div class="day-planner-one-day" ng-controller="DayPlannerOneDayCtrl"
                ng-class="{'dragover': dayDragover && isValidDayForDrop()}"
                tc-dragenter="onDayDragenter($event)"
                tc-dragleave="dayDragover = false"
                tc-dragover="onDayDragover($event)"
                tc-dragend="onDragend(); dayDragover = false"
                tc-drop="handleDayDrop($event, dayModel); dayDrover = false;"
              >
                <h4 class="day-planner-day-heading">
                  Day [[dayModel.dayNumber]]
                  <span class="day-planner-edit-note-control" ng-show="!editingNote">
                    <a ng-click="openNoteEditor()" href="javascript:void(0)"
                      tooltip="Add a note" tooltip-placement="bottom">
                      <span class="glyphicon glyphicon-pencil"></span>
                    </a>
                  </span>
                </h4>

                <div class="day-planner-one-day-controls">
                  <a href="javascript:void(0)" class="dropdown-toggle">
                    <span class="glyphicon glyphicon-cog"></span>
                  </a>
                  <ul class="dropdown-menu right-top-dropdown-menu">
                    <li>
                      <a ng-click="dpm.clearDay(dayModel)" href="javascript:void(0)">
                        <span class="glyphicon glyphicon-remove"></span> Clear day
                      </a>
                      <a ng-click="dpm.deleteDay(dayModel)" href="javascript:void(0)">
                        <span class="glyphicon glyphicon-trash"></span> Remove day from trip
                      </a>
                    </li>
                  </ul>
                </div>

                <div ng-show="!editingNote" class="day-planner-one-day-note">[[dayModel.noteItem.data['text'] ]]</div>
                <div ng-show="editingNote">
                  <textarea class="form-control" ng-model="dayModel.noteItem.data['text']"
                    tc-focus-on="editingNote" ng-blur="closeNoteEditor()"
                    placeholder="Enter a note about this day">
                  </textarea>
                </div>
                <div ng-show="!dayModel.hasItems()" class="day-planner-day-cta">
                  Drag and drop places here to organize them
                </div>
                <div tc-item-drop-target day="dayModel.dayNumber" position="0"
                  drag-item="dragItem" on-drop="handleDrop(dayModel.dayNumber, 0)">
                </div>
                <div ng-repeat="itemModel in dayModel.getItems()">
                  <tc-draggable-entity item="itemModel" drag-item="dragItem"
                    on-dragstart="onDragstart($event, itemModel)" on-dragend="onDragend()"
                    on-clear="clearItem(itemModel)">
                  </tc-draggable-entity>
                  <div tc-item-drop-target day="dayModel.dayNumber" position="itemModel.position() + 1"
                    drag-item="dragItem" on-drop="handleDrop(dayModel.dayNumber, itemModel.position() + 1)">
                  </div>
                </div>
              </div>
            </div>

            <div class="day-planner-controls">
              <button class="btn btn-default day-planner-add-day-button" ng-click="addNewDay()">
                <span class="glyphicon glyphicon-plus"></span> Add a day
              </button>
            </div>

          </div>
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="day-planner-drop-target-template">
    <div class="day-planner-drop-target"
      ng-class="{'dragactive': isDragActive(), 'dragover': dragover}"
      tc-dragenter="onDragenter($event)"
      tc-dragleave="onDragleave($event)"
      tc-dragover="onDragover($event)"
      tc-drop="onDrop(); dropDone($event)"
    >
      <div class="day-planner-drop-target-inner"
        tc-dragenter="onInnerDragenter()"
        tc-dragleave="onInnerDragleave()">
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="day-planner-entity-item-template">
    <div draggable="true" class="day-planner-draggable-entity"
      ng-class="{'existing-item-dragactive': activeItemIsThis(item)}"
      tc-dragstart="onDragstart({$event: $event})" tc-dragend="onDragend()">
      <div class="day-planner-entity-image-container">
        <img ng-src="[[item.data['photo_urls'][0] ]]"/>
      </div>
      <div class="day-planner-entity-info">
        <div>
          [[item.data['name'] ]]
        </div>
        <div class="draggable-entity-controls">
          <a ng-click="onClear()" href="javascript:void(0)" tooltip="Remove from day">
            <span class="glyphicon glyphicon-remove"></span>
          </a>
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="item-group-template">
    <div ng-controller="ItemGroupCtrl" ng-show="itemGroupModel.hasContent()">
      <div ng-include="'item-group-header-template'">
      </div>
      <div ng-show="show">
        <div ng-repeat="item in itemGroupModel.getNonemptyNoteItems()">
          <div ng-include="'mapview-one-note-template'">
          </div>
        </div>
        <div ng-repeat="item in itemGroupModel.getEntityItems()">
          <div ng-include="'mapview-one-entity-template'">
          </div>
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="item-group-header-template">
    <h4 class="item-group-header" ng-click="toggleSection()">
      <span ng-include="'item-group-header-text-template'"></span>
      <a href="javascript:void(0)">
        <span ng-show="show" class="glyphicon glyphicon-chevron-down toggle-chevron"></span>
        <span ng-show="!show" class="glyphicon glyphicon-chevron-up toggle-chevron"></span>
      </a>
    </h4>
  </script>

  <script type="text/ng-template" id="item-group-header-text-template">
    <span ng-if="itemGroupModel.isDayGrouping()">
      <span ng-if="itemGroupModel.groupKey > 0">
        Day [[itemGroupModel.groupKey]]
      </span>
      <span ng-if="!itemGroupModel.groupKey">
        Unordered
      </span>
    </span>
    <span ng-if="itemGroupModel.isCategoryGrouping()">
      <span ng-switch on="itemGroupModel.groupKey">
        <span ng-switch-when="lodging">Lodging</span>
        <span ng-switch-when="food_and_drink">Food &amp; Drink</span>
        <span ng-switch-when="attractions">Attractions</span>
        <span ng-switch-default>Uncategorized</span>
      </span>
    </span>
  </script>

  <script type="text/ng-template" id="mapview-one-entity-template">
    <div ng-controller="EntityCtrl" class="one-entity-mapview container-fluid"
      ng-class="{'expanded': detailsExpanded, 'collapsed': !detailsExpanded}"
      tc-entity-id="[[ed['entity_id'] ]]"
      ng-click="openGalleryView(ed)"
      ng-mouseenter="openInfowindow(ed['entity_id'])">
      <div class="row main-row">
        <div class="col-md-4 img-container"
          ng-style="{'background-image': 'url(' + ed['photo_urls'][0] +')'}">
          <div class="category-info">
            <img ng-src="/static/img/[[ed['icon_url'] ]]"/>
          </div>
        </div>
        <div class="col-md-8 details-container">
          <div class="main-details">
            <div class="title">
              [[ed['name'] ]]
            </div>
            <div tc-star-rating value="[[ed['rating'] ]]" ng-if="ed['rating']">
            </div tc-star-rating>
            <div class="source">
              From
              <a ng-href="[[ed['source_url'] ]]" target="_blank"
                tooltip="[[ed['source_url'] | hostname ]]" tooltip-placement="right">
                <img class="source-icon" ng-src="http://[[ed['source_url'] | hostname ]]/favicon.ico"/>
              </a>
            </div>
            <div class="day-info" ng-show="item.day()">
              Day [[item.day()]]
            </div>
            <div class="main-controls">
              <span ng-if="!item.hasLocation()"
                tooltip="Location unavailable"
                class="glyphicon glyphicon-exclamation-sign">
              </span>
              <span ng-if="item.hasLocation() && !item.isPreciseLocation()"
                ng-click="$event.stopPropagation()"
                tooltip="Location approximate"
                class="glyphicon glyphicon-exclamation-sign">
              </span>
              <a href="javascript:void(0)" class="dropdown-toggle">
                <span class="glyphicon glyphicon-cog"></span>
              </a>
              <ul class="dropdown-menu right-bottom-dropdown-menu">
                {% if allow_editing %}
                <li>
                  <a ng-click="openEditPlaceModal()" href="javascript:void(0)">
                    <span class="glyphicon glyphicon-edit"></span> Edit this place
                  </a>
                </li>
                {% endif %}
                <li>
                  <a ng-click="reclipEntity()" href="javascript:void(0)">
                    <span class="glyphicon glyphicon-paperclip"></span> Clip this place
                  </a>
                </li>
                {% if allow_editing %}
                <li>
                  <a ng-click="deleteEntity()" href="javascript:void(0)">
                    <span class="glyphicon glyphicon-trash"></span> Delete this place
                  </a>
                </li>
                <li>
                  <select class="form-control day-select-pill"
                    ng-options="option.createNew ? 'Add a new day' : 'Day ' + option.dayNumber for option in getDaySelectOptions()"
                    {# HACK: Stupid ng/bootstrap widget closes the dropdown on all clicks,
                       so as soon as you try to click on the Select elem the whole dropdown
                       closes.  Here we stop the click event to prevent this.  But then
                       we need a corresponding hack to trigger a fake click event when
                       we need the menu to actually close.  It seems a future version
                       of the dropdown widget will support angular bindings to control
                       the open/close state. #}
                    ng-click="$event.stopPropagation(); $event.preventDefault()"
                    ng-change="organizeIntoDay()"
                    ng-model="selectedDay">
                    <option value="" ng-if="!item.day()">--Add to day--</option>
                  </select>
                </li>
                {% endif %}
              </ul>
              <a ng-click="toggleDetails($event)" href="javascript:void(0)">
                <span ng-show="!detailsExpanded" class="glyphicon glyphicon-chevron-down"></span>
                <span ng-show="detailsExpanded" class="glyphicon glyphicon-chevron-up"></span>
              </a>
            </div>
          </div>
        </div>
      </div>
      <div class="row expanded-row" ng-show="detailsExpanded">
        <div class="address">
          [[ed['address'] ]]
        </div>
        <div class="description-section" >
          <div ng-show="!editing" class="description">[[ed['description'] ]]</div>
          {% if allow_editing %}
          <div class="add-description-link" ng-show="!editing">
            <a ng-click="openEditEntity(); $event.stopPropagation()" href="javascript:void(0)">
              <span class="glyphicon glyphicon-pencil"></span>
              <span ng-show="hasDescription()">Add a comment</span>
              <span ng-show="!hasDescription()">Edit comment</span>
            </a>
          </div>
          {% endif %}
        </div>
        {% if allow_editing %}
        <div ng-show="editing">
          <textarea ng-model="ed['description']" class="form-control description-input"
            tc-focus-on="editing">
          </textarea>
          <button ng-show="editing" class="btn btn-primary" ng-click="saveEntityEdit()">Save</button>
        </div>
        {% endif %}
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="mapview-one-note-template">
    <div ng-controller="NoteCtrl" class="one-note-mapview">
      <div ng-show="!editing">
        <div class="note-text">[[nd['text'] ]]</div>
      </div>
      <div ng-show="editing">
        <textarea ng-model="nd['text']" tc-focus-on="editing" class="form-control"
          ng-blur="saveNote()">
        </textarea>
      </div>
      <div class="controls" ng-show="!editing">
        <a ng-click="openEditNote()" href="javascript:void(0)">
          <span class="glyphicon glyphicon-pencil"></span>
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="modal-carousel-template">
    <carousel interval="-1">
      <slide ng-repeat="slide in slides" active="slide.active">
        <img ng-src="[[slide.imgUrl]]"/>
      </script>
    </carousel>
  </script>
 
  <script type="text/ng-template" id="mapview-getting-started-template">
    <div class="getting-started-directions">
      <div class="welcome">
        Welcome to your new trip plan
      </div>
      <a href="javascript:(function(){c=document.createElement('script');c.type='text/javascript';c.src='{{bookmarklet_url}}'+'?'+Math.floor(Math.random()*99999999);document.body.appendChild(c);})();">
        <button class="btn btn-info" id="btn-bookmarklet">
          Travel Clipper
        </button>
      </a> <-- If you haven't already, drag me to your Bookmarks Bar
      <div class="step">
        Step 1
      </div>
      <p>
        Pick a travel destination then browse popular travel websites for hotel, restaurant, and attraction options
      </p>
      <p>
        Try these supported sites - 
        <a href="http://www.hotels.com/hotel/details.html?pa=5&pn=1&ps=5&tab=description&destinationId=504261&searchDestination=Paris&hotelId=218097&rooms[0].numberOfAdults=2&roomno=1&validate=false&previousDateful=false&reviewOrder=date_newest_first" target="_blank">Hotels.com</a>, 
        <a href="https://www.airbnb.com/rooms/2095577?s=6yRc" target="_blank">Airbnb</a>, 
        <a href="http://www.tripadvisor.com/Attraction_Review-g187147-d188150-Reviews-Musee_d_Orsay-Paris_Ile_de_France.html" target="_blank">TripAdvisor</a>, 
        <a href="http://www.yelp.com/biz/la-compagnie-des-vins-surnaturels-paris" target="_blank">Yelp</a>
      </p>
      <div class="step">
        Step 2
      </div>
      <p>
        Clip to this Trip Plan by using the clipper or by pasting the URL of the website you want to save in the URL input above
      </p>
      <div class="step">
        Step 3
      </div>
      <p>
        Come back to this Trip Plan and your bookmarked points of interest will instantly be ready for you to browse and manage
      </p>
    </div>
  </script>

  <script type="text/ng-template" id="gallery-panel-template">
    <div ng-controller="GalleryPanelCtrl" class="full-height">
      <div class="hero-container">
        <img ng-src="[[selectedHeroImg()]]"/>
      </div>
      <div tc-gallery-carousel urls="ed()['photo_urls']" on-select="selectImg($img)"
        page-size="3"
        class="gallery-carousel">
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="gallery-carousel-template">
    <div class="full-height">
      <a ng-show="hasPrevImgs()" ng-click="showPrevPage()" href="javascript:void(0)">
        <span class="glyphicon glyphicon-chevron-left"></span>
      </a>
      <a ng-repeat="img in imgsToShow()" href="javascript:void(0)"
        ng-click="onSelect({$img: img})">
        <img ng-src="[[img]]"/>
      </a>
      <a ng-show="hasNextImgs()" ng-click="showNextPage()" href="javascript:void(0)">
        <span class="glyphicon glyphicon-chevron-right"></span>
      </a>
    </div>
  </script>

  <script type="text/ng-template" id="trip-plan-header-template">
    <div id="trip-plan-header">
      <div class="title" ng-show="!editingTripPlanSettings">
        [[planModel.tripPlanName()]]
      </div>
      <div ng-show="editingTripPlanSettings" class="trip-plan-name-input-container">
        <form ng-submit="saveTripPlanSettings()">
          <input type="text" class="form-control"
            ng-model="editableTripPlanSettings.name" tc-focus-on="editingTripPlanSettings"
            ng-blur="saveTripPlanSettings()"/>
        </form>
      </div>
      <div class="settings-control" ng-show="!editingTripPlanSettings">
        <a class="dropdown-toggle" href="javascript:void(0)">
          <span class="glyphicon glyphicon-cog"></span>
        </a>
        <ul class="dropdown-menu right-top-dropdown-menu">
          {% if allow_editing %}
          <li>
            <a ng-click="editTripPlanSettings()" href="javascript:void(0)">
              <span class="glyphicon glyphicon-pencil"></span> Edit trip plan name
            </a>
          </li>
          <hr class="dropdown-separator"/>
          {% endif %}
          <li>
            <a ng-click="cloneCurrentTripPlan()" href="javascript:void(0)">
              <span class="glyphicon glyphicon-plus"></span> Clone trip plan
            </a>
          </li>
          {% if allow_editing %}
          <li>
            <a ng-click="deleteCurrentTripPlan()" href="javascript:void(0)">
              <span class="glyphicon glyphicon-trash"></span> Delete trip plan
            </a>
          </li>
          {% endif %}
        </ul>
      </div>
      <div class="control-panel"
        tc-lock-after-scroll class-when-fixed="fixed" scroll-parent-id="entity-container"
        parent-class-when-fixed="nav-fixed">
        <div class="control-buttons container-fluid">
          <div class="row">
            <div class="col-md-4 sort-button">
              <a class="dropdown-toggle" href="javascript:void(0)">
                <div class="button-content">
                  <span ng-if="pageStateModel.isGroupByCategory()">Sort by: Type</span>
                  <span ng-if="pageStateModel.isGroupByDay()">Sort by: Day</span>
                  <span class="glyphicon glyphicon-chevron-down"></span>
                </div>
              </a>
              <ul class="dropdown-menu sorting-dropdown">
                <li>
                  <a ng-click="groupByCategory()" href="javascript:void(0)">Sort by Category</a>
                </li>
                <li>
                  <a ng-click="groupByDay()" href="javascript:void(0)">Sort by Day</a>
                </li>
              </ul>
            </div>
            <div class="col-md-4 day-planner-button">
              <a ng-click="openDayPlanner('day-planner-modal-window')" href="javascript:void(0)">
                <div class="button-content">Day Planner</div>
              </a>
            </div>
            <div class="col-md-4 add-place-button">
              <a ng-click="toggleOmnibox()" href="javascript:void(0)">
                <div class="button-content">Add Place to Trip</div>
              </a>
            </div>
          </div>
        </div>
        <div ng-include="'omnibox-template'" ng-show="omniboxState.visible">
        </div>
      </div>
      <div class="nav-vertical-placeholder" ng-class="{'omnibox-open': omniboxState.visible}">
      </div>
    </div>
  </script>

  {% if allow_editing %}
  <script type="text/ng-template" id="omnibox-template">
    <div ng-controller="AddPlaceCtrl" class="omnibox-container">
      <div ng-show="!loadingData">
        <div>
          <input type="text" class="form-control" placeholder="Search for a place OR paste a website URL"
          tc-google-place-autocomplete
          tc-focus-on="omniboxState.visible"
          ng-model="rawInputText"
          on-place-change="placeChanged($newPlace)"
          ng-paste="textPasted()"/>
        </div>
      </div>
      <div ng-show="loadingData" id="search-spinner">
        <img src="/static/img/spinner-small.gif"/>
      </div>
    </div>
  </script>
  {% endif %}

  {% include 'widgets.html' %}

  <script>
    initApp(
      {{plan.to_json_str()|safe}},
      {{entities_json|safe}},
      {{notes_json|safe}},
      {{all_trip_plans_json|safe}},
      {{account_info.to_json_str()|safe}},
      {{all_datatype_values.to_json_str()|safe}},
      {{allow_editing|jsbool}});
  </script>
</body>
</html>
