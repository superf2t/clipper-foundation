<!doctype html>
<html>
<head>
  <title>{{plan.name}}</title>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="//maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>
  <script src="//cdn.jsdelivr.net/underscorejs/1.6.0/underscore-min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular-sanitize.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular-animate.min.js"></script>
  <script src="/static/js/ui-bootstrap-tpls-0.11.0.min.js"></script>
  <script src="/static/js/jquery.nanoscroller.min.js"></script>
  <script src="/static/js/services.js"></script>
  <script src="/static/js/script.js"></script>
  <link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Raleway:300">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="shortcut icon" href="/static/img/globe-bw.png">
  {% set analytics_page_type = 'own_guide' if allow_editing else 'guide' %}
  {% include 'analytics.html' %}
</head>
<body ng-controller="RootCtrl" ng-class="getHackClasses()">
  <tc-nav account-info="accountInfo" active-trip-plan="activeTripPlanState.tripPlan"
    all-trip-plans="allTripPlans" trip-plan-of-current-page="planModel.tripPlanData">
  </tc-nav>
  <tc-flashed-messages messages="flashedMessages">
  </tc-flashed-messages>

  <div id="summary-panel" ng-if="{{allow_editing | jsbool}}">
    <div ng-include="'trip-plan-header-template'">
    </div>

    <div id="entity-container" class="nano" tc-set-nano-scrollbars
      tc-link-heights="#entity-size-elem" height-watch-expr="planModel.entities()"
      ng-class="{'expanded': pageStateModel.summaryPanelExpanded}">
      <div class="nano-content scroll-container"
        tc-scroll-to-selector scroll-on-changes-to="pageStateModel.selectedEntity"
        skip-scroll-when-in-view="true"
        scroll-dest-selector=".one-entity-summary[tc-entity-id='[[pageStateModel.selectedEntity['entity_id'] ]]'] .scroll-anchor"
        tc-track-entity-drag-state>

        <div id="entity-size-elem">
          <tc-filter-bar filter-model="filterModel" tracking-location="summary-panel">
          </tc-filter-bar>

          <div ng-repeat="entity in planModel.entities()">
            <div ng-include="'one-entity-summary-template'">
            </div>
          </div>

          <div ng-if="!planModel.hasEntities()" class="no-entities-message">
            <p> 
              Click 'Add Places', then add your first place to this guide. 
            <p/>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="info-panel" ng-show="!pageStateModel.inNewTripPlanModal"
    ng-class="{'closed': !pageStateModel.infoPanelExpanded}">
    {% if allow_editing %}
    <div ng-include="'info-panel-nav-template'">
    </div>
    {% endif %}
    <div class="info-panel-content {% if allow_editing %}with-nav{% endif %}">
      <div ng-include="'details-panel-template'"
        class="nano full-height" tc-set-nano-scrollbars
        ng-show="pageStateModel.infoPanelMode == InfoPanelMode.DETAILS">
      </div>
      {% if allow_editing %}
      <div ng-include="'guides-panel-template'"
        class="nano full-height" tc-set-nano-scrollbars
        ng-if="pageStateModel.infoPanelMode == InfoPanelMode.GUIDES">
      </div>
      <div ng-include="'add-your-own-panel-template'"
        class="nano full-height" tc-set-nano-scrollbars
        ng-if="pageStateModel.infoPanelMode == InfoPanelMode.ADD_YOUR_OWN">
      </div>
      <div ng-include="'export-panel-template'"
        class="nano full-height" tc-set-nano-scrollbars
        ng-if="pageStateModel.infoPanelMode == InfoPanelMode.EXPORT">
      </div>
      <div ng-include="'sharing-panel-template'"
        class="nano full-height" tc-set-nano-scrollbars
        ng-if="pageStateModel.infoPanelMode == InfoPanelMode.SHARING">
      </div>
      <div ng-include="'import-panel-template'"
        class="nano full-height" tc-set-nano-scrollbars
        ng-if="pageStateModel.infoPanelMode == InfoPanelMode.IMPORT">
      </div>
      <div ng-include="'settings-panel-template'"
        class="nano full-height" tc-set-nano-scrollbars
        ng-if="pageStateModel.infoPanelMode == InfoPanelMode.SETTINGS">
      </div>
      {% endif %}
    </div>
    <div class="slide-control">
      <a ng-click="openDetailsPanel()" href="javascript:void(0)"
        ng-show="!pageStateModel.infoPanelExpanded"
        tc-track-click="{name:'toggle-info-panel', value: 'open'}">
        <span class="glyphicon glyphicon-chevron-right"></span>
      </a>
      <a ng-click="closeInfoPanel()" href="javascript:void(0)" class="ng-cloak"
        ng-show="pageStateModel.infoPanelExpanded"
        tc-track-click="{name:'toggle-info-panel', value: 'close'}">
        <span class="glyphicon glyphicon-chevron-left"></span>
      </a>
    </div>
  </div>

  <div id="map-panel" tc-animate-on-bool="!pageStateModel.infoPanelExpanded"
    tc-transitionend="updateMap()"
    class-when-true="info-panel-closed" after-complete="updateMap()"
    ng-class="{'full-screen': pageStateModel.isMapFullScreen()}">
    <div id="map-container">
      <div id="map">
      </div>
    </div>
    <div ng-include="'control-buttons-template'">
    </div>
  </div>

  {% if not allow_editing %}
  <tc-after-new-trip-plan-panel
    ng-if="pageStateModel.showAfterNewTripPlanPanel"
    on-close="pageStateModel.showAfterNewTripPlanPanel = false">
  </tc-after-new-trip-plan-panel>


  <script type="text/ng-template" id="entity-clipping-modal-template">
    <div class="entity-clipping-modal" ng-controller="EntityClippingModalCtrl"
      ng-show="show">
      <div>
        Add <i>[[ed['name'] ]]</i> to your guide:
      </div>
      <div>
        <tc-trip-plan-selector trip-plans="allTripPlans"
          select-trip-plan-to="activeTripPlanState.tripPlan"
          show-create-new="true" on-create-new-selected="openNewTripPlanModal()"
          on-change="logChange($newValue, $oldValue)">
        </tc-trip-plan-selector>
      </div>
      <div>
        <button class="btn btn-primary" ng-click="saveAndClose()"
          tc-track-click="{name: 'save-to-guide', location: 'entity-clipping-confirmation', value: ed['entity_id']}">
          Add to My Guide
        </button>
        <button class="btn btn-default" ng-click="$close()"
          tc-track-click="{name: 'cancel', location: 'entity-clipping-confirmation'}">
          Cancel
        </button>
      </div>
    </div>
  </script>
  {% endif %}

  <script type="text/ng-template" id="info-panel-nav-template">
    <div class="info-panel-nav">
      <span class="active-panel-header">
        <span class="my-guide">
          <span ng-if="pageStateModel.infoPanelMode == InfoPanelMode.DETAILS">
            <span tc-icon="trip-plan"></span>
            My Places
          </span>
          <span ng-if="pageStateModel.infoPanelMode == InfoPanelMode.EXPORT">
            <span class="glyphicon glyphicon-share"></span>
            Export
          </span>
          <span ng-if="pageStateModel.infoPanelMode == InfoPanelMode.SHARING">
            <span class="glyphicon glyphicon-share-alt"></span>
            Share
          </span>
          <span ng-if="pageStateModel.infoPanelMode == InfoPanelMode.SETTINGS">
            <span class="glyphicon glyphicon-cog"></span>
            Settings
          </span>
        </span>
        <span class="add-places">
          <span ng-if="pageStateModel.infoPanelMode == InfoPanelMode.GUIDES">
            <span class="glyphicon glyphicon-book"></span>
            Browse Guides
          </span>
          <span ng-if="pageStateModel.infoPanelMode == InfoPanelMode.ADD_YOUR_OWN">
            <span class="glyphicon glyphicon-plus"></span>
            Add Your Own
          </span>
          <span ng-if="pageStateModel.infoPanelMode == InfoPanelMode.IMPORT">
            <span class="glyphicon glyphicon-import"></span>
            Import
          </span>
        </span>
      </span>
      <span class="buttons">
        <span class="dropdown nav-button">
          <button class="btn btn-my-guide dropdown-toggle">
            My Guide
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu nav-dropdown">
            <li>
              <a ng-click="goToInfoPanel(InfoPanelMode.DETAILS)"
                ng-class="{'selected': pageStateModel.infoPanelMode == InfoPanelMode.DETAILS}"
                tc-track-click="{name: 'info-panel-change', location: 'info-panel-nav', value: 'details'}"
                href="javascript:void(0)">
                <span tc-icon="trip-plan"></span>
                My Places
              </a>
            </li>
            <li>
              <a ng-click="goToInfoPanel(InfoPanelMode.EXPORT)"
                ng-class="{'selected': pageStateModel.infoPanelMode == InfoPanelMode.EXPORT}"
                tc-track-click="{name: 'info-panel-change', location: 'info-panel-nav', value: 'export'}"
                href="javascript:void(0)">
                <span class="glyphicon glyphicon-share"></span>
                Export
              </a>
            </li>
            <li>
              <a ng-click="goToInfoPanel(InfoPanelMode.SHARING)"
                ng-class="{'selected': pageStateModel.infoPanelMode == InfoPanelMode.SHARING}"
                tc-track-click="{name: 'info-panel-change', location: 'info-panel-nav', value: 'share'}"
                href="javascript:void(0)">
                <span class="glyphicon glyphicon-share-alt"></span>
                Share
              </a>
            </li>
            <li>
              <a ng-click="goToInfoPanel(InfoPanelMode.SETTINGS)"
                ng-class="{'selected': pageStateModel.infoPanelMode == InfoPanelMode.SETTINGS}"
                tc-track-click="{name: 'info-panel-change', location: 'info-panel-nav', value: 'settings'}"
                href="javascript:void(0)">
                <span class="glyphicon glyphicon-cog"></span>
                Settings
              </a>
            </li>
          </ul>
        </span>
        <span class="dropdown nav-button">
          <button class="btn btn-add-places dropdown-toggle">
            Add Places
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu nav-dropdown">
            <li>
              <a ng-click="goToInfoPanel(InfoPanelMode.GUIDES)"
                ng-class="{'selected': pageStateModel.infoPanelMode == InfoPanelMode.GUIDES}"
                tc-track-click="{name: 'info-panel-change', location: 'info-panel-nav', value: 'guides'}"
                href="javascript:void(0)">
                <span class="glyphicon glyphicon-book"></span>
                Browse Guides
              </a>
            </li>
            <li>
              <a ng-click="goToInfoPanel(InfoPanelMode.ADD_YOUR_OWN)"
                ng-class="{'selected': pageStateModel.infoPanelMode == InfoPanelMode.ADD_YOUR_OWN}"
                tc-track-click="{name: 'info-panel-change', location: 'info-panel-nav', value: 'add-your-own'}"
                href="javascript:void(0)">
                <span class="glyphicon glyphicon-plus"></span>
                Add Your Own
              </a>
            </li>
            <li>
              <a ng-click="goToInfoPanel(InfoPanelMode.IMPORT)"
                ng-class="{'selected': pageStateModel.infoPanelMode == InfoPanelMode.IMPORT}"
                tc-track-click="{name: 'info-panel-change', location: 'info-panel-nav', value: 'import'}"
                href="javascript:void(0)">
                <span class="glyphicon glyphicon-import"></span>
                Import
              </a>
            </li>
          </ul>
        </span>
      </span>
    </div>
  </script>

  <script type="text/ng-template" id="filter-bar-template">
    <div ng-if="filterModel.attributeFilteringActive()" class="filter-bar">
      <span class="filter-message">
        <span ng-show="filterModel.activeTagText">
          Showing places tagged with
          <span class="tag-filter-text">[[filterModel.activeTagText]]</span>
        </span>
        <span ng-show="filterModel.activeCategory">
          Showing places with category
           <span class="tag-filter-text">[[filterModel.activeCategory['display_name'] ]]</span>
        </span>
      </span>
      <a ng-click="filterModel.clearAttributeFilters()" class="close-link black-link" href="javascript:void(0)"
        tc-track-click="{name: 'cancel-filters', location: 'filter-bar-' + trackingLocation}">
        <span class="glyphicon glyphicon-remove"></span>
      </a>
    </div>
  </script>

  <script type="text/ng-template" id="control-buttons-template">
    <div id="map-buttons" ng-class="{'info-panel-open': pageStateModel.infoPanelExpanded}">
      <div class="recenter-control">
        <button ng-click="resetMapState()" class="btn btn-default recenter-btn"
          tc-track-click="{name: 'reset-map-state', location: 'map-controls'}">
          <span class="glyphicon glyphicon-screenshot"></span>
        </button>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="infowindow-template">
    <div class="infowindow" ng-controller="InfowindowCtrl">
      <div class="infowindow-internal">
        <div class="info-section" ng-class="em.hasCategory() && 'bg-' + ed['category']['name']">
          <span class="name">
            [[ed['name'] ]]
          </span>
          <span class="metadata">
            <span ng-show="ed['address_precision'] == 'Imprecise'"
              class="glyphicon glyphicon-exclamation-sign"
              tooltip="Location is approximate">
            </span>
            <span tc-icon="comment" ng-show="em.hasComments()"
              tooltip="[[ed['comments'].length ]] comments">
            </span>
            {% if allow_editing %}
            <span="star-section">
              <a ng-click="saveStarState(true)" ng-show="!ed['starred']" class="white-link"
                href="javascript:void(0)" tooltip="Favorite"
                tc-track-click="{name: 'controls-favorite-entity', location: 'entity-infowindow'}">
                <span class="glyphicon glyphicon-star-empty"></span>
              </a>
              <a ng-click="saveStarState(false)" ng-show="ed['starred']" href="javascript:void(0)" tooltip="Un-favorite"
              tc-track-click="{name: 'controls-unfavorite-entity', location: 'entity-infowindow'}">
                <span class="glyphicon glyphicon-star favorite-star"></span>
              </a>
            </span>
            {% else %}
            <span ng-show="ed['starred']" class="glyphicon glyphicon-star favorite-star">
            </span>
            {% endif %}
          </span>
        </div>
        <div class="comments-section" ng-if="ed['comments'] && ed['comments'].length">
          <div ng-repeat="comment in ed['comments']" class="one-comment">
            <div>
              <span class="comment-sidebar">
                <span tc-user-icon user="comment['user']">
                </span>
              </span>
              <span class="comment-details">
                <div>
                  <span ng-bind-html="comment['text'] | linky:'_blank'" class="text"></span>
                </div>
                <div class="comment-timestamp">
                  [[comment['last_modified'] | date: 'short']]
                </div>
              </span>
            </div>
          </div>
        </div>
        <div class="workspace-section" ng-if="workspaceActive()">
          <div ng-if="inlineEditMode == InlineEditMode.TAGS" class="inline-tags-editor">
            <span class="inline-editor-prompt">Enter tags, separated by commas</span>
            <form ng-submit="saveTags()">
              <input type="text" class="form-control" ng-model="tagState.rawInput"
                placeholder="e.g. greek food, day 1, recommended by Bob"
                tc-focus-on="inlineEditMode"/>
            </form>
            <a ng-click="saveTags()" href="javascript:void(0)" class="cta-link"
              tc-track-click="{name: 'inline-tags-save', location: 'entity-infowindow'}">
              Save
            </a>
            <a ng-click="closeTagsEditor()" href="javascript:void(0)" class="black-link"
              tc-track-click="{name: 'inline-tags-cancel', location: 'entity-infowindow'}">
              Cancel
            </a>
          </div>
          <div ng-if="inlineEditMode == InlineEditMode.COMMENTS" class="inline-comment-editor">
            <div class="author-name">
              <span tc-user-icon user="accountInfo['user']">
              </span>
            </div>
            <textarea class="form-control" placeholder="Add a comment"
              tc-focus-on="inlineEditMode"
              ng-model="newComment['text']">
            </textarea>
            <div>
              <a ng-click="saveNewComment()" href="javascript:void(0)" class="cta-link"
                tc-track-click="{name: 'save-new-comment', location: 'entity-infowindow'}">
                Save
              </a>
              <a ng-click="closeNewComment()" href="javascript:void(0)" class="cancel-link"
                tc-track-click="{name: 'cancel-new-comment', location: 'entity-infowindow'}">
                Cancel
              </a>
            </div>
          </div>
          <div ng-if="inlineEditMode == InlineEditMode.DIRECTIONS" class="directions-planner">
            <span class="inline-editor-prompt">Get directions </span>
            <a ng-click="directionsHelper.toggleDirection()" href="javascript:void(0)"
              tc-track-click="{name: 'directions-toggle', location: 'entity-infowindow', value: directionsHelper.direction == 'to' ? 'from' : 'to'}">
              [[directionsHelper.direction == 'to' ? 'to' : 'from' ]]
            </a>
            <select class="form-control"
              ng-options="e['name'] for e in directionsHelper.entities"
              ng-model="directionsHelper.destination">
              <option value="">Select destination</option>
            </select>
            <button class="btn btn-cta go-button"
              ng-click="directionsHelper.getDirections(ed)"
              ng-disabled="!directionsHelper.destination"
              tc-track-click="{name: 'directions-go', location: 'entity-infowindow', value: directionsHelper.direction}">
              Go
            </button>
          </div>
        </div>
        <div class="tool-section" ng-include="'map-marker-tools-template'"
          ng-show="!pageStateModel.inAddPlacePanel()">
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="map-marker-tools-template">
    <div class="marker-tools">
      {% if allow_editing %}
      <span ng-show="showPrimaryControls" class="primary-controls">
        <a ng-click="toggleTagsEdit()" href="javascript:void(0)"
          class="black-link"
          tooltip="Add Tags" tooltip-placement="bottom"
          tc-track-click="{name: 'controls-open-tags-editor', location: 'entity-infowindow'}">
          <span class="glyphicon glyphicon-tag"></span>
        </a>
        <a ng-click="toggleDirectionsEdit()" href="javascript:void(0)" class="black-link"
          tooltip="Get directions" tooltip-placement="bottom"
          tc-track-click="{name: 'controls-open-directions', location: 'entity-infowindow'}">
          <span tc-icon="compass"></span>
        </a>
        <a ng-click="toggleCommentsEdit()" href="javascript:void(0)" class="black-link"
          tooltip="Comment" tooltip-placement="bottom"
          tc-track-click="{name: 'controls-open-new-comment', location: 'entity-infowindow'}">
          <span tc-icon="comment"></span>
        </a>
      </span>
      <span ng-show="showSecondaryControls" class="secondary-controls">
        <a ng-click="openEditPlaceModal()" href="javascript:void(0)" class="black-link"
          tooltip="Edit" tooltip-placement="bottom"
          tc-track-click="{name: 'controls-open-entity-editor', location: 'entity-infowindow'}">
          <span class="glyphicon glyphicon-pencil"></span>
        </a>
        <a ng-click="deleteEntity()" href="javascript:void(0)" class="black-link"
          tooltip="Delete" tooltip-placement="bottom"
          tc-track-click="{name: 'controls-delete-entity', location: 'entity-infowindow'}">
          <span class="glyphicon glyphicon-trash"></span>
        </a>
      </span>
      <span class="control-toggle">
        <a ng-click="toggleControls()" href="javascript:void(0)" class="black-link"
          tooltip="More controls" tooltip-placement="bottom"
           tc-track-click="{name: 'entity-extended-controls-toggle', location: 'entity-infowindow', value: showSecondaryControls ? 'showing-primary' : 'showing-extended'}">
          &hellip;
        </a>
      </span>
      {% else %}
      <a ng-show="!isAlreadySaved()" ng-click="clipEntity()"
        class="add-to-trip-link" href="javascript:void(0)"
        tc-track-click="{name: 'add-to-trip', location: 'entity-infowindow'}">
        Add to My Guide
      </a>
      <span ng-show="isAlreadySaved()" class="already-saved">
        Saved
      </span>
      {% endif %}
    </div>
  </script>

  {% if allow_editing %}
  <script type="text/ng-template" id="results-infowindow-template">
    <div class="infowindow results-infowindow">
      <div class="infowindow-internal">
        <div class="info-section" ng-class="em.hasCategory() && 'bg-' + ed['category']['name']">
          <div class="name">
            [[ed['name'] ]]
          </div>
        </div>
        <div class="marker-tools">
          <a ng-click="clipEntity()" href="javascript:void(0)"
            class="add-to-trip-link" ng-show="!resultAlreadySaved()"
            tc-track-click="{name: 'add-to-trip', location: 'results-infowindow'}">
            Add to My Guide
          </a>
          <div class="save-confirmation" ng-show="resultAlreadySaved()">
            Saved
          </div>
        </div>
      </div>
    </div>
  </script>
  {% endif %}

  <script type="text/ng-template" id="edit-place-modal-template">
    <div class="edit-place" ng-controller="EditPlaceCtrl">
      <div class="edit-header">
        <div class="editor-title">[[originalEntity['name'] ]]</div>
        <div class="button-panel">
          <button class="btn btn-cta" ng-click="saveEntity()"
            tc-track-click="{name: 'editor-save', location: trackingLocation}">
            Save
          </button>
          <button class="btn btn-default" ng-click="$close()"
            tc-track-click="{name: 'editor-cancel', location: trackingLocation}">
            Cancel
          </button>
        </div>
      </div>

      <div class="tab-header">
        <span class="one-editor-tab-header">
          <a class="black-link"
            href="javascript:void(0)"
            ng-click="selectTab(EditorTab.NAME_AND_DESCRIPTION)"
            ng-class="{'selected': editorTab == EditorTab.NAME_AND_DESCRIPTION}"
            tc-track-click="{name: 'editor-tab-change', location: trackingLocation, value: 'name'}">
            Name and Description
          </a>
        </span>
        <span class="one-editor-tab-header">
          <a class="black-link"
            href="javascript:void(0)"
            ng-click="selectTab(EditorTab.DETAILS)"
            ng-class="{'selected': editorTab == EditorTab.DETAILS}"
            tc-track-click="{name: 'editor-tab-change', location: trackingLocation, value: 'details'}">
            Details
          </a>
        </span>
        <span class="one-editor-tab-header">
          <a class="black-link"
            href="javascript:void(0)"
            ng-click="selectTab(EditorTab.ADDRESS_AND_LOCATION)"
            ng-class="{'selected': editorTab == EditorTab.ADDRESS_AND_LOCATION}"
            tc-track-click="{name: 'editor-tab-change', location: trackingLocation, value: 'location'}">
            Location
          </a>
        </span>
        <span class="one-editor-tab-header">
          <a class="black-link"
            href="javascript:void(0)"
            ng-click="selectTab(EditorTab.PHOTOS)"
            ng-class="{'selected': editorTab == EditorTab.PHOTOS}"
            tc-track-click="{name: 'editor-tab-change', location: trackingLocation, value: 'photos'}">
            Photos
          </a>
        </span>
      </div>

      <div class="editor-body">
        <div class="one-editor-tab" ng-if="editorTab == EditorTab.NAME_AND_DESCRIPTION">
          <label>Name</label>
          <input type="text" class="form-control" ng-model="ed['name']" placeholder="e.g. Eiffel Tower"/>
          <label>Description</label>
          <textarea class="form-control description-input" ng-model="ed['description']"
            placeholder="e.g. A great place to visit"></textarea>
          <form class="form-inline" role="form">
            <label class="category-label">Category</label>
            <select class="form-control category-input" ng-model="ed['category']"
              ng-options="c['display_name'] for c in categories track by c['category_id']"
              ng-change="categoryChanged();
                et.track({name: 'category-changed', location: trackingLocation, value: ed['category']['name']})">
            </select>
            <select class="form-control category-input" ng-model="ed['sub_category']"
              ng-options="s['display_name'] for s in getSubCategories(ed['category']['category_id']) track by s['sub_category_id']"
              ng-change="et.track({name: 'sub-category-changed', location: trackingLocation, value: ed['sub_category']['name']})">
            </select>
          </form>
          <label>Tags</label>
          <input type="text" class="form-control" ng-model="tagState.rawInput"
            ng-change="tagsChanged()"
            placeholder="e.g. Day 1, Chinese food, Recommended by Bob"/>
        </div>
        <div class="one-editor-tab" ng-if="editorTab == EditorTab.DETAILS">
          <label>Phone number</label>
          <input type="text" class="form-control" ng-model="ed['phone_number']"/>
          <label>Website</label>
          <input type="text" class="form-control" ng-model="ed['website']"/>
          <label>Opening Hours</label>
          <textarea class="form-control" ng-model="ed['opening_hours']['source_text']"/>
        </div>
        <div class="one-editor-tab" ng-if="editorTab == EditorTab.ADDRESS_AND_LOCATION">
          <label>Address</label>
          <input type="text" class="form-control" ng-model="ed['address']" placeholder="Search for an address"
            tc-google-place-autocomplete search-bounds-json="locationBounds"
            location-types="geocode" on-place-change="addressChanged($newPlace)"/>
          <div class="map-container">
            <div tc-google-map class="map" map="mapState.map" map-options="mapOptions" after-creation="setupMap($map)">
            </div>
          </div>
          <tc-entity-marker map="mapState.map" marker="markerState.marker"
            position="markerState.position"
            category-name="ed['category'] && ed['category']['name']"
            icon-template-name="em.iconTemplateName()"
            precise="ed['address_precision'] == 'Precise'"
            draggable="true" on-drag-end="markerDragged($position)">
          </tc-entity-marker>
          <form class="form-inline" role="form">
            <input type="radio" class="form-control" value="Precise" ng-model="ed['address_precision']" id="precise-radio"/>
            <label for="precise-radio" class="precision-label">Exact location</label>
            <input type="radio" class="form-control" value="Imprecise" ng-model="ed['address_precision']" id="imprecise-radio"/>
            <label for="imprecise-radio" class="precision-label">Approximate location</label>
          </form>
        </div>
        <div class="one-editor-tab" ng-if="editorTab == EditorTab.PHOTOS">
          <div class="photo-drop-target" ng-class="{'dragactive': photoEditState.dragActive}"
            tc-dragenter="photoDropTargetDragenter($event)"
            tc-dragover="photoDropTargetDragenter($event)"
            tc-dragleave="photoDropTargetDragleave()"
            tc-drop="photoDropped($event)">
            <div class="editable-carousel" ng-if="ed['photo_urls'] && ed['photo_urls'].length">
              <div tc-image-carousel urls="ed['photo_urls']" current-index="selectedPhoto.index">
              </div>
              <div class="photo-top-control">
                <a ng-click="setPhotoAsPrimary()" href="javascript:void(0)"
                  tc-track-click="{name: 'primary-photo-changed', location: trackingLocation, value: ed['photo_urls'][selectedPhoto.index]}">
                  Set as Primary <span class="glyphicon glyphicon-picture"></span>
                </a>
              </div>
              <div class="photo-bottom-control">
                <a ng-click="deletePhoto()" href="javascript:void(0)"
                  tc-track-click="{name: 'photo-removed', location: trackingLocation}">
                  Delete Photo <span class="glyphicon glyphicon-trash"></span>
                </a>
              </div>
            </div>
            <textarea class="form-control photo-drop-input" ng-model="photoEditState.rawInput"
              ng-paste="photoUrlPasted()"
              placeholder="Drag and drop photos or paste a URL">
            </textarea>
          </div>
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="one-entity-summary-template">
    <div ng-controller="EntitySummaryCtrl" class="one-entity-summary"
      tc-entity-id="[[ed['entity_id'] ]]"
      ng-class="{
        'selected': pageStateModel.entityIsSelected(ed['entity_id']),
        'controls-open': controlState.open,
        'being-dragged': isBeingDragged(),
        'inactive': !isActive()
      }"
      ng-click="selectEntity()"
      tc-draggable="isDraggable" tc-draggable-entity-summary>
      <a class="scroll-anchor"></a>
      <span class="entity-circle-img">
        <img ng-src="[[em.getBackgroundImageUrl(planModel.locationLatlng())]]" draggable="false"/>
      </span>
      <span class="entity-info" ng-show="!controlState.open">
        <div class="name">
          [[ed['name'] ]]
        </div>
        <div class="details">
          <span ng-show="em.hasCategory()" ng-class="'text-' + ed['category']['name']">
            <a ng-click="filterToCategory($event)" class="category-filter-link"
              tc-track-click="{name: 'category-filter', location: 'entity-summary', value: ed['category']['name']}"
              href="javascript:void(0)">
              [[em.categoryDisplayText()]]
            </a>
          </span>
          <span ng-show="ed['comments'] && ed['comments'].length" class="quickinfo-icon" tc-icon="comment">
          </span>
          </span>
          <span class="glyphicon glyphicon-star favorite-star quickinfo-icon" ng-show="ed['starred']">
          </span>
        </div>
      </span>
      <span class="controls" ng-show="controlState.open" ng-click="$event.stopPropagation()">
        <span ng-show="!controlState.showSecondaryControls">
          <a class="black-link" ng-click="openInlineEdit(InlineEditMode.TAGS)" href="javascript:void(0)"
            tooltip="Add Tags" tooltip-placement="bottom" tooltip-append-to-body="true"
            tc-track-click="{name: 'controls-open-tags-editor', location: 'entity-summary'}">
            <span class="glyphicon glyphicon-tag"></span>
          </a>
          <a class="black-link" ng-click="openInlineEdit(InlineEditMode.DIRECTIONS); closeControls()"
            href="javascript:void(0)"
            tooltip="Get directions" tooltip-placement="bottom" tooltip-append-to-body="true"
             tc-track-click="{name: 'controls-open-directions', location: 'entity-summary'}">
            <span tc-icon="compass"></span>
          </a>
          <a class="black-link" ng-click="openInlineEdit(InlineEditMode.COMMENTS); closeControls()"
            href="javascript:void(0)"
            tooltip="Comment" tooltip-placement="bottom" tooltip-append-to-body="true"
             tc-track-click="{name: 'controls-open-new-comment', location: 'entity-summary'}">
            <span tc-icon="comment"></span>
          </a>
        </span>
        <span ng-show="controlState.showSecondaryControls">
          <a class="black-link" ng-click="saveStarState(true)"
            ng-show="!ed['starred']" href="javascript:void(0)"
            tooltip="Favorite" tooltip-placement="bottom" tooltip-append-to-body="true"
            tc-track-click="{name: 'controls-favorite-entity', location: 'entity-summary'}">
            <span class="glyphicon glyphicon-star-empty"></span>
          </a>
          <a class="black-link" ng-click="saveStarState(false)"
            ng-show="ed['starred']" href="javascript:void(0)"
            tooltip="Un-favorite" tooltip-placement="bottom" tooltip-append-to-body="true"
            tc-track-click="{name: 'controls-unfavorite-entity', location: 'entity-summary'}">
            <span class="glyphicon glyphicon-star favorite-star"></span>
          </a>
          <a class="black-link" ng-click="openEditPlaceModal(); closeControls()"
            href="javascript:void(0)"
            tooltip="Edit" tooltip-placement="bottom" tooltip-append-to-body="true"
            tc-track-click="{name: 'controls-open-entity-editor', location: 'entity-summary'}">
            <span class="glyphicon glyphicon-pencil"></span>
          </a>
          <a class="black-link" ng-click="deleteEntity()"
            href="javascript:void(0)"
            tooltip="Delete" tooltip-placement="bottom" tooltip-append-to-body="true"
            tc-track-click="{name: 'controls-delete-entity', location: 'entity-summary'}">
            <span class="glyphicon glyphicon-trash"></span>
          </a>
        </span>
        <span class="control-toggle">
          <a class="black-link" ng-click="controlState.showSecondaryControls = !controlState.showSecondaryControls"
            href="javascript:void(0)"
            tooltip="More controls" tooltip-placement="bottom" tooltip-append-to-body="true"
            tc-track-click="{name: 'entity-extended-controls-toggle', location: 'entity-summary', value: controlState.showSecondaryControls ? 'showing-primary' : 'showing-extended'}">
            &hellip;
          </a>
        </span>
      </span>
      {% if allow_editing %}
      <div class="control-cog-section" ng-click="$event.stopPropagation()">
        <span class="control-cog">
          <a class="black-link" ng-click="openControls()" ng-show="!controlState.open"
            tc-track-click="{name: 'open-entity-controls', location: 'entity-summary'}"
            href="javascript:void(0)">
            <span class="glyphicon glyphicon-cog"></span>
          </a>
          <a ng-click="closeControls()" class="white-link" ng-show="controlState.open"
            tc-track-click="{name: 'close-entity-controls', location: 'entity-summary'}"
            href="javascript:void(0)" >
            <span class="glyphicon glyphicon-remove"></span>
          </a>
        </span>
      </div>
      {% endif %}
    </div>
  </script>

  <script type="text/ng-template" id="details-panel-template">
    <div class="details-panel one-info-panel nano-content" ng-controller="DetailsPanelCtrl"
      tc-scroll-to-selector scroll-on-changes-to="pageStateModel.selectedEntity"
      scroll-dest-selector=".one-entity-details[tc-entity-id='[[pageStateModel.selectedEntity['entity_id'] ]]']">
      <tc-filter-bar filter-model="filterModel" tracking-location="details-panel">
      </tc-filter-bar>

      {% if allow_editing %}
      <div class="add-cover-image-cta" ng-if="!planModel.hasCoverImage() && planModel.hasEntities()">
        <a ng-click="goToInfoPanel(InfoPanelMode.SETTINGS)" href="javascript:void(0)" class="white-link">
          <span class="cta-inner">Add a cover photo</a>
        </a>
      </div>
      {% endif %}

      <tc-trip-plan-details-header trip-plan="planModel.tripPlanData"
        num-entities="planModel.numEntities()" full-bleed="true" hidden-mode="!planModel.hasEntities()"
        include-details="true" include-creator="true">
      </tc-trip-plan-details-header>
      <tc-entity-details ng-repeat="entity in planModel.entities()" 
        entity="entity" is-editable="{{allow_editing | jsbool}}" for-results="false"
        for-guide="planModel.isGuide()" trip-plan-id="planModel.tripPlanId()">
      </tc-entity-details>

      <div ng-if="relatedGuides && relatedGuides.length">
        <div class="related-guides-header">Related Guides</div>
        <div ng-repeat="guide in relatedGuides">
          <a ng-href="/guide/[[guide['trip_plan_id'] ]]">
            <tc-trip-plan-details-header trip-plan="guide"
              num-entities="guide['num_entities']" include-creator="true"
              show-border="true">
            </tc-trip-plan-details-header>
          </a>
        </div>
      </div>

      {% if plan.is_guide() and guide_config_for_destination %}
      <div class="more-guides-for-destination">
        <a href="/guides/{{guide_config_for_destination.city_name_url_token}}">
          More guides for {{guide_config_for_destination.city_name}}
        </a>
      </div>
      {% endif %}

      <div class="back-to-top" ng-show="planModel.hasEntities()">
        <a tc-scroll-on-click scroll-parent=".details-panel" scroll-target=".details-panel"
          tc-track-click="{name: 'back-to-top', location: 'details-panel'}"
          href="javascript:void(0)">
          Back to top
          <span class="glyphicon glyphicon-chevron-up back-to-top-chevron"></span>
        </a>
      </div>
      {% if allow_editing %}
      <div ng-if="!planModel.hasEntities()" class="no-entities-message">
          Welcome! Quickly create your personal guide of places to see for [[planModel.tripPlanData['location_name'] ]]. 
          <br/>
          <br/>
          Get started and click on 'Add Places' to browse guides from top travel websites and bloggers, or to add your own places of interest.
        </p>
      </div>
      {% endif %}
    </div>
  </script>

  <script type="text/ng-template" id="trip-plan-header-template">
    <div class="trip-plan-header">
      <span class="trip-plan-name">
        [[planModel.tripPlanData['name'] ]]
      </span>
      <span class="place-count">
        [[planModel.numEntities()]]
      </span>
      <span class="minimize-link">
        <a class="black-link" ng-click="pageStateModel.summaryPanelExpanded = false"
          ng-show="pageStateModel.summaryPanelExpanded"
          tc-track-click="{name: 'summary-panel-collapse', location: 'summary-panel-header'}"
          href="javascript:void(0)">
          <span class="glyphicon glyphicon-minus"></span>
        </a>
        <a class="black-link" ng-click="pageStateModel.summaryPanelExpanded = true"
          ng-show="!pageStateModel.summaryPanelExpanded"
          tc-track-click="{name: 'summary-panel-expand', location: 'summary-panel-header'}"
          href="javascript:void(0)">
          <span class="glyphicon glyphicon-plus"></span>
        </a>
      </span>
    </div>
  </script>

  <script type="text/ng-template" id="one-entity-details-template">
    <div class="one-entity-details"
      tc-entity-id="[[forResults ? null : ed['entity_id'] ]]"
      tc-entity-result-id="[[forResults ? resultIndex : null]]"
      ng-mouseenter="highlightMarker()"
      ng-mouseleave="unhighlightMarker()"
      ng-class="{'inactive': !isActive()}">
      <div class="name-and-photos">
        <div ng-if="ed['photo_urls'] && ed['photo_urls'].length" class="photo-carousel">
          <div tc-image-carousel urls="ed['photo_urls']" full-bleed="true"
            track-change="et.track({name: 'img-carousel-change', location: trackingLocation })"
            class="carousel-content">
          </div>
        </div>
        <div ng-if="!ed['photo_urls'] || !ed['photo_urls'].length" class="default-img">
        </div>
        <div class="name-section">
          <span class="entity-icon">
            <tc-entity-icon precise="ed['address_precision'] == 'Precise'"
              category-name="ed['category'] && ed['category']['name']"
              icon-template-name="em.iconTemplateName()"
              for-results="forResults" result-letter="resultLetter()">
            </tc-entity-icon>
          </span>
          <span class="entity-name">
            [[ed['name'] ]]
          </span>
          <span class="star-section">
            <span ng-if="isEditable">
              <a class="white-link" ng-click="saveStarState(true)"
                ng-show="!ed['starred']" href="javascript:void(0)" tooltip="Favorite" tooltip-placement="left"
                tc-track-click="{name: 'controls-favorite-entity', location: trackingLocation}">
                <span class="glyphicon glyphicon-star-empty"></span>
              </a>
              <a ng-click="saveStarState(false)"
                ng-show="ed['starred']" href="javascript:void(0)" tooltip="Un-favorite" tooltip-placement="left"
                tc-track-click="{name: 'controls-unfavorite-entity', location: trackingLocation}">
                <span class="glyphicon glyphicon-star favorite-star"></span>
              </a>
            </span>
            <span ng-if="!isEditable">
              <span class="glyphicon glyphicon-star favorite-star"
                ng-show="ed['starred']">
              </span>
            </span>
          </span>
        </div>
      </div>
      <div class="one-entity-content">
        <div class="info-tabs">
          <span class="info-tab" ng-class="{'selected': infoTab == InfoTab.ABOUT}"
            ng-show="showAboutTab()">
            <a class="black-link" ng-click="selectInfoTab(InfoTab.ABOUT)"
              tc-track-click="{name: 'info-tab-click', location: trackingLocation, value: 'about'}"
              href="javascript:void(0)">
              About
            </a>
          </span>
          <span class="info-tab" ng-class="{'selected': infoTab == InfoTab.DETAILS}">
            <a class="black-link" ng-click="selectInfoTab(InfoTab.DETAILS)"
              tc-track-click="{name: 'info-tab-click', location: trackingLocation, value: 'details'}"
              href="javascript:void(0)">
              Details
            </a>
          </span>
          <span class="info-tab" ng-class="{'selected': infoTab == InfoTab.COMMENTS}"
            ng-show="showCommentsTab()">
            <a class="black-link" ng-click="selectInfoTab(InfoTab.COMMENTS)"
              tc-track-click="{name: 'info-tab-click', location: trackingLocation, value: 'comments'}"
              href="javascript:void(0)">
              Comments
              <span ng-show="em.hasComments()">([[em.numComments()]])<span>
            </a>
          </span>
          <span class="add-to-trip-cta" ng-show="!isEditable">
            <a ng-click="clipEntity()" ng-show="!isAlreadySaved()" class="add-to-trip-link"
              tc-track-click="{name: 'add-to-trip', location: trackingLocation}"
              href="javascript:void(0)">
              Add to My Guide
            </a>
            <span ng-show="isAlreadySaved()" class="saved-status">
              Saved
            </span>
          </span>
        </div>
        <div class="tab-content">
          <div ng-show="infoTab == InfoTab.ABOUT">
            <div ng-show="ed['origin_trip_plan_name']" class="origin-trip-name">
              Originally from
              <a ng-href="/guide/[[ed['origin_trip_plan_id'] ]]" target="_blank"
                tc-track-click="{name: 'view-entity-origin-trip', location: trackingLocation, value: ed['origin_trip_plan_id']}">
                [[ed['origin_trip_plan_name'] ]]
              </a>
            </div>
            <div class="description" ng-if="ed['description']">
              <tc-expandable-content text-content="ed['description']"
                expand-link-text="Read more" collapse-link-text="Read less"
                max-lines="5"
                track-expand="{name: 'toggle-read-more-text', location: trackingLocation, value: 'open'}"
                track-collapse="{name: 'toggle-read-more-text', location: trackingLocation, value: 'close'}">
              </tc-expandable-content>
            </div>
            <div ng-show="showAddDescriptionPrompt()" class="description">
              <a ng-click="openDescriptionEditor()" class="cta-link"
                tc-track-click="{name: 'add-description-prompt', location: trackingLocation}"
                href="javascript:void(0)">
                Add a description
              </a>
            </div>
            <div ng-if="inlineEditMode == InlineEditMode.DESCRIPTION" class="inline-editor">
              <textarea class="form-control" ng-model="descriptionState.rawInput"
                placeholder="Description" tc-focus-on="inlineEditMode">
              </textarea>
              <a ng-click="saveDescription()"
                tc-track-click="{name: 'inline-description-save', location: trackingLocation}"
                href="javascript:void(0)" class="cta-link">
                Save
              </a>
              <a ng-click="closeDescriptionEditor()"
                tc-track-click="{name: 'inline-description-cancel', location: trackingLocation}"
                href="javascript:void(0)">
                Cancel
              </a>
            </div>
            <div ng-show="em.hasCategory()"
              ng-class="'text-' + ed['category']['name']">
              <span ng-if="forResults">
                [[ed['category']['display_name'] ]]
                <span ng-show="em.hasSubCategory()">
                  &gt; [[ed['sub_category']['display_name'] ]]
                </span>
              </span>
              <span ng-if="!forResults">
                <a ng-click="filterToCategory()" class="category-filter-link"
                  tc-track-click="{name: 'category-filter', location: trackingLocation, value: ed['category']['name']}"
                  href="javascript:void(0)">
                  [[ed['category']['display_name'] ]]
                  <span ng-show="em.hasSubCategory()">
                    &gt; [[ed['sub_category']['display_name'] ]]
                  </span>
                </a>
              </span>
            </div>
            <div class="tags" ng-show="showTags()">
              Tags:
              <span ng-if="forResults">
               <span ng-repeat="tag in ed['tags']" class="one-tag">
                  [[tag['text'] ]]
                </span>
              </span>
              <span ng-if="!forResults">
                <a ng-repeat="tag in ed['tags']" ng-click="makeTagActive(tag)"
                  tc-track-click="{name: 'tag-filter', location: trackingLocation, value: tag['text']}"
                  href="javascript:void(0)">
                  <span class="one-tag">
                    [[tag['text'] ]]
                  </span>
                </a>
              </span>
              <a ng-show="!em.hasTags()" ng-click="openTagsEditor()"
                tc-track-click="{name: 'add-tags-prompt', location: trackingLocation}"
                class="cta-link" href="javascript:void(0)">
                Add tags
              </a>
            </div>
            <div class="inline-editor tags-editor" ng-show="inlineEditMode == InlineEditMode.TAGS">
              <span class="inline-editor-prompt">Enter tags, separated by commas</span>
              <form class="tag-input-form" ng-submit="saveTags()">
                <input type="text" class="form-control" ng-model="tagState.rawInput"
                  placeholder="e.g. greek food, day 1, recommended by Bob"
                  tc-focus-on="inlineEditMode"/>
              </form>
              <a ng-click="saveTags()" href="javascript:void(0)" class="cta-link"
                tc-track-click="{name: 'inline-tags-save', location: trackingLocation}">
                Save
              </a>
              <a ng-click="closeTagsEditor()" href="javascript:void(0)"
                tc-track-click="{name: 'inline-tags-cancel', location: trackingLocation}">
                Cancel
              </a>
            </div>
          </div>
          <div ng-show="infoTab == InfoTab.DETAILS">
            <div class="source-attribution" ng-show="ed['source_url']">
              Place info from
              <a class="underline-link" ng-href="[[ed['source_url'] ]]" target="_blank"
                tc-track-click="{name: 'place-info-source-click', location: trackingLocation, value: ed['source_display_name']}">
                [[ed['source_display_name'] ]]
              </a>
            </div>
            <div ng-show="ed['address']" class="detail-item">
              Address: [[ed['address'] ]]
            </div>
            <div ng-show="em.hasOpeningHours()" class="detail-item">
              Hours: <span class="opening-hours">[[em.openingHoursStr()]]</span>
            </div>
            <div ng-show="ed['phone_number']" class="detail-item">
              Phone: [[ed['phone_number'] ]]
            </div>
            <div ng-show="ed['website']" class="detail-item">
              Website:
              <a class="underline-link" ng-href="[[ed['website'] ]]" target="_blank">
                [[ed['website'] ]]
              </a>
            </div>
            <div class="reputation-section"
              ng-show="em.hasReputationInfo() && ed['source_is_trusted_for_reputation']">
              <div ng-show="ed['source_url']">
                Ratings and Reviews from
                <a ng-href="[[ed['source_url'] ]]" target="_blank" class="underline-link"
                  tc-track-click="{name: 'reputation-source-click', location: trackingLocation, value: ed['source_display_name']}">
                  [[ed['source_display_name'] ]]
                </a>
              </div>
              <div>
                <span class="star-rating" ng-if="ed['rating']">
                  <tc-star-rating value="ed['rating']" max="ed['rating_max'] || 5">
                  </tc-star-rating>
                </span>
                <span class="num-reviews" ng-if="ed['review_count']">
                  [[ed['review_count'] ]] reviews
                </span>
              </div>
            </div>
            <div ng-if="inlineEditMode == InlineEditMode.DIRECTIONS" class="inline-editor">
              <span class="inline-editor-prompt">Get directions </span>
              <a ng-click="directionsHelper.toggleDirection()"
                tc-track-click="{name: 'directions-toggle', location: trackingLocation, value: directionsHelper.direction == 'to' ? 'from' : 'to'}"
                href="javascript:void(0)" class="cta-link">
                [[directionsHelper.direction == 'to' ? 'to' : 'from' ]]
              </a>
              <select class="form-control directions-select"
                ng-options="e['name'] for e in directionsHelper.entities"
                ng-model="directionsHelper.destination">
                <option value="">Select destination</option>
              </select>
              <button class="btn btn-cta"
                ng-click="directionsHelper.getDirections(ed)"
                ng-disabled="!directionsHelper.destination"
                tc-track-click="{name: 'directions-go', location: trackingLocation, value: directionsHelper.direction}">
                Go
              </button>
              <a ng-click="closeDirections()" href="javascript:void(0)"
                tc-track-click="{name: 'directions-cancel', location: trackingLocation}">
                Cancel
              </a>
            </div>
          </div>
          <div ng-show="infoTab == InfoTab.COMMENTS">
            <div ng-repeat="comment in ed['comments']" class="one-comment">
              <div>
                <span class="comment-sidebar">
                  <span tc-user-icon user="comment['user']">
                  </span>
                </span>
                <span class="comment-details">
                  <div ng-show="!editingComment || editingComment['comment_id'] != comment['comment_id']">
                    <div>
                      <span ng-bind-html="comment['text'] | linky:'_blank'" class="text"></span>
                      <a ng-click="openCommentEdit(comment)" ng-if="comment['user']['public_id'] == accountInfo['user']['public_id']"
                        tc-track-click="{name: 'open-edit-existing-comment', location: trackingLocation}"
                        href="javascript:void(0)" class="cta-link comment-edit-link">
                        <span class="glyphicon glyphicon-pencil"></span>
                      </a>
                      <a ng-click="deleteComment(comment)" ng-if="comment['user']['public_id'] == accountInfo['user']['public_id']"
                        tc-track-click="{name: 'delete-existing-comment', location: trackingLocation}"
                        href="javascript:void(0)" class="cta-link comment-edit-link">
                        <span class="glyphicon glyphicon-trash"></span>
                      </a>
                    </div>
                    <div class="comment-timestamp">
                      [[comment['last_modified'] | date: 'short']]
                    </div>
                  </div>
                  <div ng-show="editingComment && editingComment['comment_id'] == comment['comment_id']">
                    <textarea class="form-control" ng-model="editingComment['text']"
                      tc-focus-on="editingComment">
                    </textarea>
                    <div>
                      <a ng-click="saveCommentEdit()" href="javascript:void(0)" class="cta-link"
                        tc-track-click="{name: 'save-edit-existing-comment', location: trackingLocation}">
                        Save
                      </a>
                      <a ng-click="closeCommentEdit()" href="javascript:void(0)"
                        tc-track-click="{name: 'cancel-edit-existing-comment', location: trackingLocation}">
                        Cancel
                      </a>
                    </div>
                  </div>
                </span>
              </div>
            </div>
            <div ng-show="isEditable && !em.hasComments() && !inlineEditMode == InlineEditMode.COMMENTS">
              <a ng-click="openNewComment()" class="cta-link" href="javascript:void(0)"
                tc-track-click="{name: 'add-comment-prompt', location: trackingLocation}">
                Add a comment
              </a>
            </div>
            <div ng-if="inlineEditMode == InlineEditMode.COMMENTS"
              class="inline-editor comment-editor">
              <div class="author-name">
                <span tc-user-icon user="accountInfo['user']">
                </span>
              </div>
              <div class="comment-input-form">
                <textarea class="form-control" placeholder="Add a comment"
                  tc-focus-on="inlineEditMode"
                  ng-model="newComment['text']">
                </textarea>
              </div>
              <div>
                <a ng-click="saveNewComment()" href="javascript:void(0)" class="cta-link"
                  tc-track-click="{name: 'save-new-comment', location: trackingLocation}">
                  Save
                </a>
                <a ng-click="closeNewComment()" href="javascript:void(0)"
                  tc-track-click="{name: 'cancel-new-comment', location: trackingLocation}">
                  Cancel
                </a>
              </div>
            </div>
          </div>
        </div>
        <div class="editing-controls" ng-if="isEditable">
          <span class="left-controls">
            <a class="black-link" ng-click="openTagsEditor()" href="javascript:void(0)"
              tc-track-click="{name: 'controls-open-tags-editor', location: trackingLocation}">
              <span class="glyphicon glyphicon-tag"></span>
            </a>
            <a class="black-link" ng-click="openDirections()" href="javascript:void(0)"
              tc-track-click="{name: 'controls-open-directions', location: trackingLocation}">
              <span tc-icon="compass"></span>
            </a>
            <a class="black-link" ng-click="openNewComment()" href="javascript:void(0)"
              tc-track-click="{name: 'controls-open-new-comment', location: trackingLocation}">
              <span tc-icon="comment"></span>
            </a>
          </span>
          <span class="right-controls">
            <a class="black-link" ng-click="openEditPlaceModal()" href="javascript:void(0)"
              tc-track-click="{name: 'controls-open-entity-editor', location: trackingLocation}">
              <span class="glyphicon glyphicon-pencil"></span>
            </a>
            <a class="black-link" ng-click="deleteEntity()" href="javascript:void(0)"
              tc-track-click="{name: 'controls-delete-entity', location: trackingLocation}">
              <span class="glyphicon glyphicon-trash"></span>
            </a>
          </span>
        </div>
      </div>
      <tc-entity-marker ng-if="markerState.position"
        map="markerState.map" marker="markerState.marker" position="markerState.position"
        category-name="ed['category'] && ed['category']['name']"
        icon-template-name="em.iconTemplateName()"
        selected="entityIsSelected()"
        precise="ed['address_precision'] == 'Precise'"
        starred="ed['starred']" has-comments="em.hasComments()"
        emphasized="markerState.emphasized" deemphasized="markerState.deemphasized" 
        for-results="forResults" result-letter="resultLetter()"
        on-click="markerClicked($event);
          et.track({name: 'map-marker-clicked', location: trackingLocation})">
      </tc-entity-marker>
    </div>
  </script>

  {% if allow_editing %}
  <script type="text/ng-template" id="guides-panel-template">
    <div class="guides-panel one-info-panel nano-content"
      ng-controller="GuidesPanelCtrl"
      tc-scroll-to-selector scroll-on-changes-to="searchResultState.selectedIndex"
      scroll-dest-selector=".one-entity-details[tc-entity-result-id='[[searchResultState.selectedIndex]]']"
      tc-reset-scroll-top-on="selectedGuide">
      <div ng-show="!selectedGuide">
        <div class="header">
          Browse popular guides for <i>[[planModel.tripPlanData['location_name'] ]]</i>
        </div>
        <div ng-show="loading">
          Loading... <img ng-src="/static/img/spinner-small.gif"/>
        </div>
        <div ng-show="!loading && (!guides || !guides.length)" class="no-guides-msg">
          There aren't any featured guides for this area yet.
        </div>
        <div ng-show="guides && guides.length">
          <tc-trip-plan-details-header ng-repeat="guide in guides" trip-plan="guide"
            num-entities="guide['entities'].length" include-creator="true"
            clickable="true" show-border="true"
            on-click="selectGuide(guide); et.track({name: 'guide-selected', location: 'guides-panel-index-' + $index, value: guide['trip_plan_id']})">
          </tc-trip-plan-details-header>
        </div>
      </div>
      <div ng-show="selectedGuide">
        <div class="guide-breadcrumb">
          <a ng-click="backToListings()" href="javascript:void(0)"
            tc-track-click="{name: 'back-to-listings', location: 'guides-panel-breadcrumb'}">
            [[planModel.tripPlanData['location_name'] ]] Guides
          </a>
          &gt;
          [[selectedGuide['name'] ]]
        </div>
        <tc-trip-plan-details-header trip-plan="selectedGuide"
          num-entities="selectedGuide['entities'].length" full-bleed="true" include-details="true" include-creator="true">
        </tc-trip-plan-details-header>
        <tc-entity-details ng-repeat="entity in selectedGuide['entities']"
          entity="entity" is-editable="false" for-results="true" for-guide="true"
          trip-plan-id="selectedGuide['trip_plan_id']" result-index="$index">
        </tc-entity-details>

        <div ng-if="relatedGuides && relatedGuides.length">
          <div class="related-guides-header">Related Guides</div>
          <div ng-repeat="guide in relatedGuides">
            <tc-trip-plan-details-header trip-plan="guide"
              num-entities="guide['entities'].length" include-creator="true"
              clickable="true" show-border="true"
              on-click="selectGuide(guide); et.track({
                name: 'related-guide-selected',
                location: 'guides-panel-related-guides-index-' + $index,
                value: guide['trip_plan_id']
                })">
            </tc-trip-plan-details-header>
          </div>
        </div>

        <div class="back-to-top">
          <a tc-scroll-on-click scroll-parent=".guides-panel" scroll-target=".guides-panel"
            tc-track-click="{name: 'back-to-top', location: 'guides-panel'}"
            href="javascript:void(0)">
            Back to top
            <span class="glyphicon glyphicon-chevron-up back-to-top-chevron"></span>
          </a>
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="add-your-own-panel-template">
    <div class="add-your-own-panel one-info-panel nano-content"
      ng-controller="AddYourOwnPanelCtrl">
      <div class="sub-nav btn-group">
        <button type="button" class="btn btn-default"
          ng-class="{'active': tab == AddYourOwnTab.SEARCH}"
          ng-click="selectTab(AddYourOwnTab.SEARCH)"
          tc-track-click="{name: 'add-your-own-sub-nav-change', location: 'add-your-own-panel', value: 'search'}">
          <span class="glyphicon glyphicon-search"></span>
        </button>
        <button type="button" class="btn btn-default"
          ng-class="{'active': tab == AddYourOwnTab.CLIPPER}"
          ng-click="selectTab(AddYourOwnTab.CLIPPER)"
          tc-track-click="{name: 'add-your-own-sub-nav-change', location: 'add-your-own-panel', value: 'clipper'}">
          <span class="glyphicon glyphicon-paperclip"></span>
        </button>
        <button type="button" class="btn btn-default"
          ng-class="{'active': tab == AddYourOwnTab.PASTE_LINK}"
          ng-click="selectTab(AddYourOwnTab.PASTE_LINK)"
          tc-track-click="{name: 'add-your-own-sub-nav-change', location: 'add-your-own-panel', value: 'paste-link'}">
          <span class="glyphicon glyphicon-link"></span>
        </button>
      </div>

      <div ng-if="tab == AddYourOwnTab.SEARCH" class="search-panel">
        <div class="header">
          Search for places by name, address, or category in
          <i>[[planModel.tripPlanData['location_name'] ]]</i>
        </div>
        <div class="search-input">
          <input type="text" class="form-control" ng-model="searchState.rawInput"
            tc-focus-on="tab"
            tc-google-place-autocomplete
            search-bounds-json="planModel.tripPlanData['location_bounds']"
            on-place-change="googlePlaceSelected($newPlace)"
            placeholder="e.g. 'cafe', '123 Main St', or 'Eiffel Tower'"/>
          <div class="search-spinner" ng-show="searchState.searching">
            <img src="/static/img/spinner-small.gif"/>
          </div>
        </div>
        <div ng-show="hasNoSearchResults()" class="no-search-results">
          No results found
        </div>

        <div class="search-results">
          <div ng-show="searchState.resultType == ResultType.SEARCH"
            class="results-header">
            Results from Google for <span class="results-query">[[searchState.rawInput]]</span>
            near <i>[[planModel.tripPlanData['location_name'] ]]</i>
          </div>
          <div ng-show="searchState.resultType == ResultType.ENTITY_LOOKUP"
            class="results-header">
            Place details from Google
          </div>
          <tc-entity-details ng-repeat="entity in searchState.results"
            entity="entity" is-editable="false" for-results="true"
            result-index="$index">
          </tc-entity-details>
        </div>
      </div>

      <div ng-if="tab == AddYourOwnTab.CLIPPER" class="clipper-panel">
        <div class="header">
          Clip places from travel websites to your guide
        </div>

        <div class="bookmarklet-section">
          <span class="bookmarklet">
            <a href="javascript:(function(){c=document.createElement('script');c.type='text/javascript';c.src='{{bookmarklet_url}}'+'?'+Math.floor(Math.random()*99999999);document.body.appendChild(c);})();"
            onclick="event.stopPropagation(); event.preventDefault()"
            tc-track-mousedown="{name: 'clipper-bookmark-drag', location: 'add-your-own-clipper-panel'}">
              <span class="bookmarklet-link">
                <span class="glyphicon glyphicon-paperclip"></span> WhereFare Clipper
              </span>
            </a>
          </span>
          <span>
            Drag the Clipper to your bookmarks bar
          </span>
        </div>

        <div class="help-section info-text">
          <a ng-click="toggleHelp()" href="javascript:void(0)"
            tc-track-click="{name: 'toggle-clipper-help', location: 'add-your-own-clipper-panel', value: showClipperHelp ? 'hiding' : 'showing'}">
            Help with installing the Clipper
          </a>
          <div ng-show="showClipperHelp" ng-include="'clipper-help-template'">
          </div>
        </div>

        <div class="info-text">
          After adding the Clipper to your bookmarks bar, try it out on
          these sites by clicking the Clipper whenever you want to add a place
          to your guide.
        </div>

        <div class="sample-sites container-fluid">
          <div class="row">
            <div ng-repeat="site in sampleSupportedSites" class="col-md-6 sample-site">
              <img ng-src="[[site.iconUrl]]" class="site-icon"/>
              <span>
                <a ng-href="[[site.url]]" target="_blank"
                  tc-track-click="{name: 'sample-site-click', location: 'add-your-own-clipper-panel', value: site.name}">
                  [[site.name]]
                </a>
              </span>
            </div>
          </div>
        </div>
      </div>

      <div ng-if="tab == AddYourOwnTab.PASTE_LINK" class="paste-link-panel">
        <div class="header">
          Copy and paste URLs from select websites to add places
        </div>
        <div class="paste-input">
          <form ng-submit="linkPasted()">
            <input type="text" class="form-control" ng-model="linkState.rawInput"
              placeholder="http://..." tc-focus-on="tab"
              ng-paste="linkPasted()"/>
            </form>
          <div class="search-spinner" ng-show="linkState.loading">
            <img src="/static/img/spinner-small.gif"/>
          </div>
        </div>

        <div ng-show="!(linkState.loading || linkState.loadingComplete)">
          <div class="info-text">
            Try it out by pasting place pages from these websites:
          </div>

          <div class="sample-sites container-fluid">
            <div class="row">
              <div ng-repeat="site in sampleSupportedSites" class="col-md-6 sample-site">
                <img ng-src="[[site.iconUrl]]" class="site-icon"/>
                <span>
                  <a ng-href="[[site.url]]" target="_blank"
                    tc-track-click="{name: 'sample-site-click', location: 'add-your-own-paste-link-panel', value: site.name}">
                    [[site.name]]
                  </a>
                </span>
              </div>
            </div>
          </div>
        </div>

        <div ng-show="noLinkResults()">
          <div class="no-search-results">No results found</div>
          <div class="info-text no-places">
            WhereFare couldn't automatically find places on that page.
            <br/>
            <br/>
            Try installing the
            <a ng-click="selectTab(AddYourOwnTab.CLIPPER)"
              class="cta-link" href="javascript:void(0)">clipper bookmark</a>,
            then
            <a ng-href="[[linkState.formattedUrl]]" target="_blank" class="cta-link">
              visit the website
            </a>
             to quickly clip information and images.
           </div>
        </div>

        <div class="text-danger info-text" ng-show="linkState.invalidUrl">
          Oops, that doesn't look like a valid url
        </div>

        <div class="link-results" ng-if="linkState.results && linkState.results.length">
          <div class="results-header">
            Results from [[linkState.siteDomain]]
          </div>
          <tc-entity-details ng-repeat="entity in linkState.results"
            entity="entity" is-editable="false" for-results="true"
            result-index="$index">
          </tc-entity-details>
        </div>

      </div>

    </div>
  </script>

  <script type="text/ng-template" id="clipper-help-template">
    <div class="clipper-help-details">
      <div ng-if="browserInfo.platform == BrowserPlatform.WINDOWS">
        <div ng-if="browserInfo.app == BrowserApp.CHROME">
          For Chrome/Windows: First make sure your bookmarks bar is shown, by pressing
          Control-Shift-B. Or click the Settings icon -> Bookmarks -> Show Bookmarks Bar,
          as in the screenshot.
          Then click and drag the clipper bookmark above into the bookmarks bar
          and release it to create a new bookmark item.
          <div class="help-screenshot">
            <img ng-src="/static/img/clipper-help-chrome-windows.png"/>
          </div>
        </div>
        <div ng-if="browserInfo.app == BrowserApp.FIREFOX">
          For Firefox/Windows: First make sure your bookmarks bar is shown, clicking
          the Bookmarks icon -> Bookmarks Toolbar -> View Bookmarks Toolbar, 
          as in the screenshot.
          Then click and drag the clipper bookmark above into the bookmarks bar
          and release it to create a new bookmark item.
          <div class="help-screenshot">
            <img ng-src="/static/img/clipper-help-firefox-windows.png"/>
          </div>
        </div>
        <div ng-if="browserInfo.app == BrowserApp.SAFARI">
          For Safari/Windows: First make sure your bookmarks bar is shown, by pressing
          Control-Shift-B or View -> Show Favorites Bar.
          Then click and drag the clipper bookmark above into the bookmarks bar
          and release it to create a new bookmark item.
        </div>
        <div ng-if="browserInfo.app == BrowserApp.IE">
          For Internet Explorer/Windows: Press Alt-C or click the Star icon to open the Favorites menu. Then click the icon for Pin the Favorites Center.
          Then click and drag the clipper bookmark above into the Favorites section
          and release it to create a new bookmark item.
          <div class="help-screenshot">
            <img ng-src="/static/img/clipper-help-ie-windows.png"/>
          </div>
        </div>
      </div>
      <div ng-if="browserInfo.platform == BrowserPlatform.MAC">
        <div ng-if="browserInfo.app == BrowserApp.CHROME">
          For Chrome/Mac: First make sure your bookmarks bar is shown, by pressing
          command-shift-B or View -> Always Show Bookmarks Bar.
          Then click and drag the clipper bookmark above into the bookmarks bar
          and release it to create a new bookmark item.
        </div>
        <div ng-if="browserInfo.app == BrowserApp.FIREFOX">
          For Firefox/Mac: First make sure your bookmarks bar is shown, clicking
          View -> Toolbars -> Bookmarks Toolbar.
          Then click and drag the clipper bookmark above into the bookmarks bar
          and release it to create a new bookmark item.
        </div>
        <div ng-if="browserInfo.app == BrowserApp.SAFARI">
          For Safari/Mac: First make sure your bookmarks bar is shown, by pressing
          command-shift-B or View -> Show Favorites Bar.
          Then click and drag the clipper bookmark above into the bookmarks bar
          and release it to create a new bookmark item.
        </div>
      </div>
      <div ng-if="!browserInfo.platform || !browserInfo.app">
        First make sure your browser's bookmarks bar is shown.
        This is typically done by going to the 'View' menu in your
        browser and looking for an option like 'Show bookmarks bar'.
        Then click and drag the clipper bookmark above into the bookmarks
        bar and release the mouse, which should create a new item in the bookmarks bar.
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="export-panel-template">
    <div class="export-panel one-info-panel nano-content">
      <div class="header">
        Take your guide with you on the road
      </div>

      <div class="explanation-text">
        Export your guide in your preferred format. Offline mobile support for iOS and Android coming soon!
      </div>
      <div class="export-buttons">
        <a class="export-button" target="_blank"
            ng-href="/guide/[[planModel.tripPlanId()]]/print"
            tc-track-click="{name: 'export-print', location: 'export-panel', value: planModel.tripPlanId()}">
          <btn class="btn btn-export btn-default">
            Print
          </btn>
        </a>
        <a class="export-button" ng-href="/guide/[[planModel.tripPlanId()]]/csv"
          tc-track-mousedown="{name: 'export-csv', location: 'export-panel', value: planModel.tripPlanId()}">
          <btn class="btn btn-export btn-default">
            Spreadsheet
          </btn>
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="sharing-panel-template">
    <div class="sharing-panel one-info-panel nano-content"
      ng-controller="SharingSettingsCtrl">
      <div class="header">
        Share your guide with collaborators and viewers
      </div>

      <div class="section">
        <div class="section-header">
          Collaborators
        </div>
        <div class="info-text">
          Collaborators can edit and comment on this guide and invite other collaborators.
        </div>
        <p class="collaborator">
          <span tc-user-icon user="creator" no-tooltip="true"></span>
          [[creator['display_name'] ]]
          <span ng-show="isCurrentUser(creator)">(you)</span>
          - creator
        </p>
        <p ng-repeat="editor in editors()" class="collaborator">
          <span tc-user-icon user="editor" no-tooltip="true"></span>
          [[editor['display_name'] ]]
          <span ng-show="isCurrentUser(editor)">
            (you)
          </span>
          <a ng-click="removeEditor(editor)"
            ng-show="!isCurrentUser(editor)"
            href="javascript:void(0)" class="remove-link cta-link"
            tc-track-click="{name: 'remove-collaborator', location: 'sharing-panel'}">
            <span class="glyphicon glyphicon-trash"></span>
          </a>
        </p>
        <p ng-repeat="inviteeEmail in inviteeEmails()" class="collaborator">
          <span>
            [[inviteeEmail]] (invited)
            <a ng-click="removeInvitee(inviteeEmail)"
              href="javascript:void(0)" class="remove-link cta-link"
              tc-track-click="{name: 'remove-invitee', location: 'sharing-panel'}">
              <span class="glyphicon glyphicon-trash"></span>
            </a>
          </span>
        </p>

        <form class="form-inline" role="form"
          ng-submit="addCollaborator(); et.track({name: 'add-collaborator', location: 'sharing-panel'})">
          <div class="form-group full-width">
            <input type="text" class="form-control email-input"
              placeholder="Enter an email address"
              ng-model="formState.email"
              ng-disabled="!accountInfo['logged_in']"/>
            <button class="btn btn-cta add-btn">
              Add
            </button>
          </div>
          <div ng-if="!accountInfo['logged_in']" class="not-logged-in-msg text-danger">
            Please log in before adding collaborators.
          </div>
        </form>
      </div>

      <div class="section">
        <div class="section-header">
          Viewers
        </div>
        <div>
          Viewers who are not collaborators cannot edit and comment on the guide or invite collaborators.
          Anyone with the following link can view your guide.
        </div>
        <input type="text" class="form-control share-url" disabled="true" ng-model="shareUrl"/>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="import-panel-template">
    <div class="import-panel one-info-panel nano-content"
      ng-controller="GmapsImporterCtrl">
      <div class="header">
        Import a Google custom map
      </div>

      <div>
        <div class="explanation-text">
          Paste a Google Maps Engine or My Maps URL to import to WhereFare. The sharing settings for the Google map must be set to "Public" or "Anyone with the link".
        </div>
        <div class="paste-input">
          <input type="text" class="form-control" placeholder="Paste a URL"
            ng-model="url" ng-paste="urlPasted()" ng-disabled="importing"
            tc-focus-on="ready"/>
          <div ng-show="importing" class="search-spinner">
            <img src="/static/img/spinner-small.gif"/>
          </div>
        </div>
        <div ng-show="urlInvalid" class="url-invalid text-danger">
          That's not a vaid Google custom maps url.
        </div>
      </div>

      <div ng-if="importedTripPlan">
        <div class="results-header">
          [[importedTripPlan['entities'].length]] places from the map
          <i>[[importedTripPlan['name'] ]]</i>
        </div>
        <div class="add-all-link">
          <a ng-click="saveAllPendingPlacesToTrip()" ng-show="!allSaved"
            class="add-to-trip-link" href="javascript:void(0)"
            tc-track-click="{name: 'add-all-from-gmaps', location: 'import-panel', value: url}">
            Add All To Guide
          </a>
          <span class="saved-status" ng-show="allSaved">
            Saved
          </span>
        </div>
        <tc-entity-details ng-repeat="entity in importedTripPlan['entities']"
          entity="entity" is-editable="false" for-results="true"
          result-index="$index">
        </tc-entity-details>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="settings-panel-template">
    <div class="settings-panel one-info-panel nano-content"
      ng-controller="TripPlanSettingsEditorCtrl">
      <div class="header">
        Settings
      </div>

      <div class="settings-panel-body">

        <div class="delete-trip-link">
          <a ng-click="deleteTripPlan()" href="javascript:void(0)" class="warning-link"
            tc-track-click="{name: 'trip-deleted', location: 'settings-panel'}">
            <span class="glyphicon glyphicon-trash"></span>
            Delete Guide
          </a>
        </div>

        <div class="input-section">
          <label>Trip Name</label>
          <input type="text" class="form-control" ng-model="tpd['name']"
            placeholder="e.g. April in Paris"/>
        </div>

        <div class="input-section">
          <label>Cover Photo</label>
          <div ng-if="editingImage">
            <textarea class="cover-img-drop-target"
              placeholder="Drag and drop an image from your browser or paste an image URL"
              ng-model="coverImgUrlInput.text" ng-change="coverImgUrlChanged()" ng-paste="coverImgUrlPasted()"
              tc-dragenter="coverImgDragenter()" tc-dragover="$event.preventDefault()" tc-drop="coverImgUrlDropped($event)"
              ng-class="{'dragactive': coverImgDragActive}">
            </textarea>
          </div>
          <div class="cover-img-container"
            ng-if="tpd['cover_image_url'] && !editingImage">
            <img ng-src="[[tpd['cover_image_url'] ]]"/>
            <div class="img-control top-control">
              <a ng-click="changeImage()" href="javascript:void(0)"
                tc-track-click="{name: 'cover-image-changed', location: 'settings-panel'}">
                Change image
                <span class="glyphicon glyphicon-picture"></span>
              </a>
            </div>
            <div class="img-control bottom-control">
              <a ng-click="removeImage()" href="javascript:void(0)",
                tc-track-click="{name: 'cover-image-removed', location: 'settings-panel'}">
                Remove image
                <span class="glyphicon glyphicon-trash"></span>
              </a>
            </div>
          </div>
        </div>

        <div class="input-section">
          <label>Description</label>
          <textarea class="form-control description-input" ng-model="tpd['description']">
          </textarea>
        </div>

        <div class="input-section">
          <label>Tags</label> (separated by commas)
          <input type="text" class="form-control" ng-model="tagState.rawInput"
            ng-change="tagsChanged()"
            placeholder="e.g. fine dining, history, adventure"/>
        </div>

        <div class="save-confirmation" ng-show="saveComplete">
          Settings saved          
        </div>

        <div class="buttons">
          <button ng-click="saveSettings()" class="btn btn-cta",
            tc-track-click="{name: 'settings-saved', location: 'settings-panel'}">
            Save
          </button>
        </div>
      </div>
    </div>
  </script>
  {% endif %}

  <script type="text/ng-template" id="user-icon-template">
    <a href="javascript:void(0)" tooltip="[[noTooltip ? null : user['display_name'] ]]"
      tooltip-append-to-body="true">
      <span class="user-icon"
        ng-class="'user-' + userStyleIdentifier()">
        [[user['display_name'].substring(0, 1) ]]
      </span>
    </a>
  </script>

  <script type="text/ng-template" id="after-new-trip-plan-panel-template">
    <div class="after-new-trip-plan-panel" id="after-new-trip-plan-panel">
      <div class="panel-body">
        <div class="close-button">
        <a ng-click="onClose()" href="javascript:void(0)"
          tc-track-click="{name: 'x-button-clicked', location: 'after-new-trip-plan-panel'}">
            <span class="glyphicon glyphicon-remove"></span>
          </a>
        </div>
        <div class="header">Created a new guide!</div>
        <div>
          <p>
            <i>[[activeTripPlanState.lastClippedEntity['name'] ]]</i> was added to this guide.
          </p>
          <p ng-show="activeTripPlanState.numEntities == 1">
            You have 1 place in this guide.
          </p>
          <p ng-show="activeTripPlanState.numEntities > 1">
            You have [[activeTripPlanState.numEntities]] places in this guide.
          </p>
        </div>
        <div>
          Go to your guide or add more places while browsing guides.
        </div>
        <div class="button-panel">
          <button ng-click="goToTripPlan()" class="btn btn-primary"
            tc-track-click="{name: 'open-own-new-guide', location: 'after-new-trip-plan-panel'}">
            View Your Guide
          </button>
          <span class="button-separator"></span>
          <button class="btn btn-cta" ng-click="onClose()"
            tc-track-click="{name: 'keep-browsing', location: 'after-new-trip-plan-panel'}">
            Keep Browsing
          </button>
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="register-and-save-panel-template">
    <div class="register-and-save-panel" ng-controller="RegisterAndSavePanelCtrl">
      <p>Looks like you're making great progress on your guide!</p>
      <p>Consider registering to save your work so you can get back to it later.</p>
      <div class="buttons">
        <button class="btn btn-cta" ng-click="loginOpener.openLoginModal('{{register_iframe_url}}', 'login-modal-window'); dismiss()"
          tc-track-click="{name: 'open-register-modal', location: 'register-and-save-prompt'}">
          Register
        </button>
        <button class="btn btn-default" ng-click="dismiss()"
          tc-track-click="{name: 'dismiss-register-prompt', location: 'register-and-save-prompt'}">
          Not now
        </button>
      </div>
    </div>
  </script>

  <div ng-include="'register-and-save-panel-template'"
    ng-if="pageStateModel.showRegisterAndSavePrompt">
  </div>

  {% include 'nav.html' %}
  {% include 'widgets.html' %}
  {% include 'map_markers.html' %}
  {% include 'icons.html' %}
  {% include 'trip_plan_common.html' %}


  <script>
    initApp(
      {{plan.to_json_str()|safe}},
      {{entities_json|safe}},
      {{to_json_str(all_trip_plans)|safe}},
      {{to_json_str(active_trip_plan)|safe}},
      {{account_info.to_json_str()|safe}},
      {{all_datatype_values.to_json_str()|safe}},
      {{allow_editing|jsbool}},
      {{sample_sites_json|safe}},
      {{has_guides|jsbool}},
      {{to_json_str(flashed_messages)|safe}});
  </script>
</body>
</html>
