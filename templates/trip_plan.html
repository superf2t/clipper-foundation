<!doctype html>
<html>
<head>
  <title>{{plan.name}}</title>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="//maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>
  <!--<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>-->
  <script src="//cdn.jsdelivr.net/underscorejs/1.6.0/underscore-min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular-sanitize.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular-animate.min.js"></script>
  <script src="/static/js/ui-bootstrap-tpls-0.10.9.js"></script>
  <script src="/static/js/sprintf.js"></script>
  <script src="/static/js/services.js"></script>
  <script src="/static/js/script.js"></script>
  <link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Raleway:300|Nunito:300">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/shared.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="shortcut icon" href="/static/img/globe.png">
</head>
<body ng-controller="RootCtrl">
  <nav class="navbar navbar-default navbar-fixed-top" role="navigation" id="travel-clip-navbar">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" id="logo" href="#">TravelClipper</a>
      </div>
      <div class="collapse navbar-collapse" id="header-navbar-collapse">
        <ul class="nav navbar-nav navbar-right" id="header-site">
          <li>
            <ul class="nav nav-pills">
              <li class="view-mode-pill">
                <a href="javascript:void(0)" ng-click="toggleAccountDropdown()">
                  <span class="glyphicon glyphicon-user" id="header-user"></span>
                </a>
              </li>
            <ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div id="left-panel" ng-show="!inNewTripPlanModal">
    <div id="entity-container" class="entity-container"
      ng-show="pageStateModel.inEntityPanel()"
      tc-entity-scroll scroll-state="scrollState"
      tc-save-scroll-position scroll-position-watch="itemGroups">

      <div ng-include="'trip-plan-header-template'">
      </div>

      <div ng-repeat="itemGroupModel in itemGroups">
        <div ng-include="'item-group-template'">
        </div>
      </div>

      <div ng-if="planModel.isEmpty()">
        <div ng-include="'getting-started-template'">
        </div>
      </div>

      <div class="mapview-footer">
        Copyright 2014 Unicycle Labs
      </div>
    </div>

    <div ng-include="'add-place-panel-template'" class="full-width full-height">
    </div>
  </div>

  <div id="mid-panel" ng-show="!inNewTripPlanModal"
    ng-class="{'closed': !pageStateModel.midPanelExpanded}"
    {% if not initial_state.mid_panel_expanded %}class="closed"{% endif %}>
    <div ng-include="'guide-panel-template'" class="full-width full-height"
      ng-show="pageStateModel.inEntityPanel()">
    </div>
    <div ng-include="'results-details-panel-template'" class="full-width full-height"
      ng-if="pageStateModel.inAddPlacePanel()">
    </div>
    <div class="toggle-handle" ng-click="toggleMidPanel()">
    </div>
  </div>

  <div id="map-panel" tc-animate-on-bool="!pageStateModel.midPanelExpanded"
    class-when-true="mid-panel-closed" after-complete="updateMap()"
    ng-class="{'full-screen': inNewTripPlanModal}"
    {% if not initial_state.mid_panel_expanded %}class="mid-panel-closed"{% endif %}>
    <div id="map-container">
      <div id="map">
      </div>
    </div>
    {% if allow_editing %}
    <div ng-include="'editor-controls-template'">
    </div>
    {% endif %}
  </div>

  {# This is below the map in the DOM so that it appears visually on top #}
  <ul ng-show="accountDropdownOpen" class="account-dropdown" ng-controller="AccountDropdownCtrl">
    <li class="account-dropdown-login-info">
      <div ng-show="accountInfo.loggedIn && !showLoginForm">
        <span class="logged-in-email">[[accountInfo['email'] ]]</span>
        <span class="logout-link">
          <a href="javascript:void(0)" ng-click="showLoginForm = true">Logout</a>
        </span>
      </div>
      <div ng-show="showLoginForm">
        <form role="form" ng-submit="doLogin()">
          <input type="text" class="form-control email-entry-input"
            ng-model="accountInfo['email']"
            placeholder="Enter your email to login"/>
          <button type="submit()" class="btn btn-default btn-login">Login</button>
        </form>
      </div>
    </li>
    <li ng-show="allTripPlans">
      <div class="my-trip-plans-heading">
        My Trip Plans
      </div>
    </li>
    <li ng-repeat="tripPlan in allTripPlans">
      <span ng-if="tripPlan['trip_plan_id'] == currentTripPlan['trip_plan_id']">
        {# Use the name from the shared info container so it will auto update 
           if the user edits it inline. #}
        [[currentTripPlan['name'] ]]
      </span>
      <span ng-if="tripPlan['trip_plan_id'] != currentTripPlan['trip_plan_id']">
          <a href="javascript:void(0)" ng-click="loadTripPlan(tripPlan['trip_plan_id'])">
            [[tripPlan['name'] ]]
          </a>
        </span>
    </li>
    <li class="create-new-trip-dropdown-link">
      <a href="javascript:void(0)" ng-click="createNewTripPlan()">Create New Trip Plan</a>
    </li>
  </ul>

  {% if allow_editing %}
  <script type="text/ng-template" id="editor-controls-template">
    <div id="main-control-buttons">
      <div class="left-buttons">
        <button class="btn"
          ng-click="showOmnibox(pageStateModel.midPanelExpanded ? 'omnibox-modal-window mid-panel-expanded' : 'omnibox-modal-window')"
          ng-show="!pageStateModel.omniboxOpen && !pageStateModel.inAddPlacePanel()
            && !inNewTripPlanModal">
          Add Place
        </button>
        <button class="btn" ng-show="pageStateModel.inAddPlacePanel()"
          ng-click="closeAddPlacePanel()">
          Close
        </button>
      </div>
      <div class="right-buttons">
        <button class="btn settings-btn dropdown-toggle">
          <span class="glyphicon glyphicon-cog"></span>
        </button>
        <ul class="dropdown-menu right-top-dropdown-menu">
          <li>
            <a ng-click="openTripPlanEditor('trip-plan-settings-editor-modal')" href="javascript:void(0)">Edit trip name and settings</a>
          </li>
          <li>
            <a href="javascript:void(0)">Advanced Places Editor</a>
          </li>
          <li>
            <a ng-click="openDayPlanner('day-planner-modal-window')" href="javascript:void(0)">Advanced Planner</a>
          </li>
          <li>
            <a ng-click="startGmapsImport()" href="javascript:void(0)">Import Google Custom Map</a>
          </li>
          <li>
            <a ng-click="deleteCurrentTripPlan()" href="javascript:void(0)">Delete Trip</a>
          </li>
        </ul>
      </div>
    </div>
  </script>
  {% endif %}

  <script type="text/ng-template" id="infowindow-template">
    <div class="infowindow" ng-controller="InfowindowCtrl"
      ng-click="suppressEvent($event)" ng-dblclick="suppressEvent($event)">
      <div class="infowindow-internal">
        <div class="info-section">
          <div class="name">
            [[ed['name'] ]]
          </div>
          <div class="day-and-star" ng-show="showInfoSection()">
            <span ng-show="ed['day']" class="day">Day [[ed['day'] ]]</span>
            <span ng-show="ed['starred']" class="glyphicon glyphicon-star favorite-star"></span>
            <span ng-show="ed['address_precision'] == 'Imprecise'" class="glyphicon glyphicon-exclamation-sign"
              tooltip="Location is approximate"><span>
          </div>
        </div>
        <div class="workspace-section" ng-if="workspaceActive()">
          <div ng-if="dayPlannerActive">
            <tc-day-select-dropdown entity-data="ed" on-select="closeDayPlanner()">
            </tc-day-select-dropdown>
          </div>
          <div ng-if="directionsPlannerActive" class="directions-planner">
            Get directions
            <a ng-click="toggleDirectionsDirection()" href="javascript:void(0)">
              [[directionsState.direction == 'to' ? 'to' : 'from' ]]
            </a>
            <select class="form-control"
              ng-options="e['name'] for e in allEntities"
              ng-model="directionsState.destination">
              <option value="">Select destination</option>
            </select>
            <button class="btn btn-primary go-button" ng-click="getDirections()"
              ng-disabled="!directionsState.destination">
              Go
            </button>
          </div>
        </div>
        <div class="tool-section" ng-include="'map-marker-tools-template'"
          ng-show="!pageStateModel.inAddPlacePanel()">
        </div>
      </div>
    </div>
  </script>

  {% if allow_editing %}
  <script type="text/ng-template" id="results-infowindow-template">
    <div class="infowindow results-infowindow"
      ng-click="suppressEvent($event)" ng-dblclick="suppressEvent($event)">
      <div class="infowindow-internal">
        <div class="info-section">
          <div class="name">
            [[ed['name'] ]]
          </div>
        </div>
        <div class="tools-section">
          <a ng-click="saveResult()" href="javascript:void(0)"
            ng-show="!searchResultState.savedResultIndices[index]">
            <span class="glyphicon glyphicon-plus"></span> Add to trip
          </a>
          <div class="save-confirmation" ng-show="searchResultState.savedResultIndices[index]">
            saved
          </div>
        </div>
      </div>
    </div>
  </script>
  {% endif %}

  <script type="text/ng-template" id="map-marker-tools-template">
    <div class="marker-tools">
      {% if allow_editing %}
      <span class="editor-controls">
        <a ng-click="openEditPlaceModal('edit-place-modal')" href="javascript:void(0)" tooltip="Edit" tooltip-placement="bottom">
          <span class="glyphicon glyphicon-pencil"></span>
        </a>
        <a ng-click="toggleDayPlanner()" href="javascript:void(0)" tooltip="Add to day" tooltip-placement="bottom">
          <span class="glyphicon glyphicon-calendar"></span>
        </a>
        <a ng-click="deleteEntity()" href="javascript:void(0)"
          tooltip="Delete" tooltip-placement="bottom">
          <span class="glyphicon glyphicon-trash"></span>
        </a>
        <a ng-click="saveStarState(true)" ng-show="!ed['starred']" href="javascript:void(0)" tooltip="Favorite" tooltip-placement="bottom">
          <span class="glyphicon glyphicon-star-empty"></span>
        </a>
        <a ng-click="saveStarState(false)" ng-show="ed['starred']" href="javascript:void(0)" tooltip="Un-favorite" tooltip-placement="bottom">
          <span class="glyphicon glyphicon-star favorite-star"></span>
        </a>
      </span>
      {% else %}
      <a ng-click="reclipEntity()" href="javascript:void(0)" tooltip="Clip this place" tooltip-placement="bottom">
        <span class="glyphicon glyphicon-paperclip"></span>
      </a>
      {% endif %}
      <a ng-click="toggleDirections()" href="javascript:void(0)" tooltip="Get directions"
        tooltip-placement="bottom">
        <span ng-include="'compass-icon-template'" class="compass-icon"></span>
      </a>
    </div>
  </script>

  <script type="text/ng-template" id="map-marker-annotations-template">
    <div class="marker-annotations" ng-show="!infowindowOpen">
      <div class="star-annotation" ng-show="ed['starred']">
        <span class="glyphicon glyphicon-star favorite-star"></span>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="day-select-dropdown-template">
    <select class="form-control"
      ng-options="option.createNew ? 'Add a new day' : 'Day ' + option.dayNumber for option in getDaySelectOptions()"
      ng-model="selectedDayState.dayModel"
      ng-change="organizeIntoDay()">
      <option value="" ng-if="!ed['day']">--Add to day--</option>
    </select>
  </script>

  <script type="text/ng-template" id="reclip-confirmation-template">
    <div ng-controller="ReclipConfirmationCtrl" class="reclip-confirmation-modal">
      <div ng-show="!reclipSucceeded">
        <div>Reclip <b>[[ed['name'] ]]</b> to:</div>
        <div tc-trip-plan-select-dropdown select-trip-plan-to="selectionState.selectedTripPlan" class="reclip-confirmation-trip-plan-dropdown"></div>
        <div ng-show="showSaveButtons()">
          <button class="btn btn-primary" ng-click="reclipEntity()">
            Save
          </button>
          <button class="btn" ng-click="dismissReclipConfirmation()">
            Cancel
          </button>
        </div>
      </div>

      <div ng-show="reclipSucceeded">
        <div class="clip-success-checkmark">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="40px" height="40px" viewBox="0 0 95.453 100" enable-background="new 0 0 95.453 100" xml:space="preserve">
          <g>
            <g>
              <polygon points="94.587,27.48 31.657,86.15 31.217,85.68 18.847,72.41 0.566,52.81 14.106,40.19 32.387,59.79 81.776,13.74"/>
            </g>
          </g>
          </svg>
        </div>
        Successfully clipped <b>[[ed['name'] ]]</b> to
        <a href="/trip_plan/[[selectionState.selectedTripPlan['trip_plan_id'] ]]" target="_blank">
          [[selectionState.selectedTripPlan['name'] ]]
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="edit-place-modal-template">
    <div class="edit-place" ng-controller="EditPlaceCtrl">
      <div class="edit-header">
        <span class="editor-title">Editor</span>
        <select ng-options="e['name'] for e in allEntities track by e['entity_id']"
          ng-model="selectedEntity" ng-change="selectedEntityChanged()">
        </select>
        <div class="button-panel">
          <button class="btn btn-primary" ng-click="saveEntity()">
            Save
          </button>
          <button class="btn btn-default" ng-click="$close()">
            Cancel
          </button>
        </div>
      </div>
      <div class="container-fluid editor-body">
        <div class="row">
          <div class="col-sm-6">
            <input type="text" class="form-control" ng-model="ed['name']" placeholder="Place name"/>
            <textarea class="form-control description-input" ng-model="ed['description']"
              placeholder="Description"></textarea>
            <div class="editable-carousel" ng-if="ed['photo_urls'] && ed['photo_urls'].length">
              <div tc-image-carousel urls="ed['photo_urls']" current-index="selectedPhoto.index">
              </div>
              <div class="photo-top-control">
                <a ng-click="setPhotoAsPrimary()" href="javascript:void(0)">
                  Set as Primary <span class="glyphicon glyphicon-picture"></span>
                </a>
              </div>
              <div class="photo-bottom-control">
                <a ng-click="deletePhoto()" href="javascript:void(0)">
                  Delete Photo <span class="glyphicon glyphicon-trash"></span>
                </a>
              </div>
            </div>
          </div>
          <div class="col-sm-6">
            <input type="text" class="form-control" ng-model="ed['address']" placeholder="Search for an address"
              tc-google-place-autocomplete search-bounds-json="locationBounds"
              location-types="geocode" on-place-change="addressChanged($newPlace)"/>
            <div class="map-container">
              <div tc-google-map class="map" map="map" map-options="mapOptions" after-creation="setupMap($map)">
              </div>
            </div>
            <form class="form-inline precision-and-star-strip" role="form">
              <input type="radio" class="form-control" value="Precise" ng-model="ed['address_precision']" ng-change="updateMarkerIcon()" id="precise-radio"/>
              <label for="precise-radio">Exact location</label>
              <input type="radio" class="form-control" value="Imprecise" ng-model="ed['address_precision']" ng-change="updateMarkerIcon()" id="imprecise-radio"/>
              <label for="imprecise-radio">Approximate location</label>
              <a ng-click="ed['starred'] = !ed['starred']" href="javascript:void(0)" class="star-control">
                <span class="glyphicon glyphicon-star"
                  ng-class="{'glyphicon-star': ed['starred'], 'glyphicon-star-empty': !ed['starred'], 'favorite-star': ed['starred']}">
                </span>
              </a>
            </form>
            <select class="form-control" ng-model="ed['category']"
              ng-options="c['display_name'] for c in categories track by c['category_id']"
              ng-change="categoryChanged()">
            </select>
            <select class="form-control" ng-model="ed['sub_category']"
              ng-options="s['display_name'] for s in getSubCategories(ed['category']['category_id']) track by s['sub_category_id']"
              ng-change="updateMarkerIcon()">
            </select>
          </div>
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="day-planner-template">
    <div ng-controller="DayPlannerCtrl" class="day-planner-modal">
      <div class="day-planner-header">
        <div class="day-planner-header-text">Plan Itinerary</div>
        <div class="day-planner-persistent-controls">
          <button class="btn btn-primary" ng-click="saveOrderings()">
            Save
          </button>
          <button class="btn" ng-click="$close()">
            Cancel
          </button>
        </div>
      </div>
      <div class="container-fluid day-planner-body">
        <div class="row-fluid">
          <div class="col-md-5 day-planner-left-panel">
            <div class="day-planner-left-panel-drag-area"
              ng-class="{'dragactive': showLeftPanelDragActive(), 'dragover': showLeftPanelDragover()}"
              tc-dragenter="onLeftPanelDragenter($event)"
              tc-dragleave="leftPanelDragover = false"
              tc-dragover="onLeftPanelDragover($event)"
              tc-dragend="onDragend(); leftPanelDragover = false"
              tc-drop="handleLeftPanelDrop($event)"
            >
              <h4 class="day-planner-panel-header">Not Planned By Day</h4>
              <div ng-repeat="item in dpm.unorderedItems" class="day-planner-unsorted-item">
                <tc-draggable-entity item="item" drag-item="dragItem"
                on-dragstart="onDragstart($event, item)" on-dragend="onDragend()">
                </tc-draggable-entity>
              </div>
            </div>
          </div>
          <div class="col-md-7 day-planner-right-panel">
            <div ng-repeat="dayModel in dpm.dayModels">
              <div class="day-planner-one-day" ng-controller="DayPlannerOneDayCtrl"
                ng-class="{'dragover': dayDragover && isValidDayForDrop()}"
                tc-dragenter="onDayDragenter($event)"
                tc-dragleave="dayDragover = false"
                tc-dragover="onDayDragover($event)"
                tc-dragend="onDragend(); dayDragover = false"
                tc-drop="handleDayDrop($event, dayModel); dayDrover = false;"
              >
                <h4 class="day-planner-day-heading">
                  Day [[dayModel.dayNumber]]
                  <span class="day-planner-edit-note-control" ng-show="!editingNote">
                    <a ng-click="openNoteEditor()" href="javascript:void(0)"
                      tooltip="Add a note" tooltip-placement="bottom">
                      <span class="glyphicon glyphicon-pencil"></span>
                    </a>
                  </span>
                </h4>

                <div class="day-planner-one-day-controls">
                  <a href="javascript:void(0)" class="dropdown-toggle">
                    <span class="glyphicon glyphicon-cog"></span>
                  </a>
                  <ul class="dropdown-menu right-top-dropdown-menu">
                    <li>
                      <a ng-click="dpm.clearDay(dayModel)" href="javascript:void(0)">
                        <span class="glyphicon glyphicon-remove"></span> Clear day
                      </a>
                      <a ng-click="dpm.deleteDay(dayModel)" href="javascript:void(0)">
                        <span class="glyphicon glyphicon-trash"></span> Remove day from trip
                      </a>
                    </li>
                  </ul>
                </div>

                <div ng-show="!editingNote" class="day-planner-one-day-note">[[dayModel.noteItem.data['text'] ]]</div>
                <div ng-show="editingNote">
                  <textarea class="form-control" ng-model="dayModel.noteItem.data['text']"
                    tc-focus-on="editingNote" ng-blur="closeNoteEditor()"
                    placeholder="Enter a note about this day">
                  </textarea>
                </div>
                <div ng-show="!dayModel.hasItems()" class="day-planner-day-cta">
                  Drag and drop places here to plan by day
                </div>
                <div tc-item-drop-target day="dayModel.dayNumber" position="0"
                  drag-item="dragItem" on-drop="handleDrop(dayModel.dayNumber, 0)">
                </div>
                <div ng-repeat="itemModel in dayModel.getItems()">
                  <tc-draggable-entity item="itemModel" drag-item="dragItem"
                    on-dragstart="onDragstart($event, itemModel)" on-dragend="onDragend()"
                    on-clear="clearItem(itemModel)">
                  </tc-draggable-entity>
                  <div tc-item-drop-target day="dayModel.dayNumber" position="itemModel.position() + 1"
                    drag-item="dragItem" on-drop="handleDrop(dayModel.dayNumber, itemModel.position() + 1)">
                  </div>
                </div>
              </div>
            </div>

            <div class="day-planner-controls">
              <button class="btn btn-default day-planner-add-day-button" ng-click="addNewDay()">
                <span class="glyphicon glyphicon-plus"></span> Add a day
              </button>
            </div>

          </div>
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="day-planner-drop-target-template">
    <div class="day-planner-drop-target"
      ng-class="{'dragactive': isDragActive(), 'dragover': dragover}"
      tc-dragenter="onDragenter($event)"
      tc-dragleave="onDragleave($event)"
      tc-dragover="onDragover($event)"
      tc-drop="onDrop(); dropDone($event)"
    >
      <div class="day-planner-drop-target-inner"
        tc-dragenter="onInnerDragenter()"
        tc-dragleave="onInnerDragleave()">
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="day-planner-entity-item-template">
    <div draggable="true" class="day-planner-draggable-entity"
      ng-class="{'existing-item-dragactive': activeItemIsThis(item)}"
      tc-dragstart="onDragstart({$event: $event})" tc-dragend="onDragend()">
      <tc-entity-listing entity-data="item.data">
      </tc-entity-listing>
      <div class="draggable-entity-controls">
        <a ng-click="onClear()" href="javascript:void(0)" tooltip="Remove from day">
          <span class="glyphicon glyphicon-remove"></span>
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="item-group-template">
    <div ng-controller="ItemGroupCtrl" ng-show="itemGroupModel.hasContent()" ng-if="itemGroupModel.getEntityItems().length != 0">
      <div ng-include="'item-group-header-template'">
      </div>
      <div ng-show="show">
        <div ng-repeat="item in itemGroupModel.getNonemptyNoteItems()">
          <div ng-include="'mapview-one-note-template'">
          </div>
        </div>
        <div ng-repeat="item in itemGroupModel.getEntityItems()">
          <div ng-include="'one-entity-leftnav-template'">
          </div>
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="item-group-header-template">
    <div class="item-group-header">
      <h4>
        <span ng-include="'item-group-header-text-template'"></span>
      </h4>
      <div class="item-group-controls" ng-show="pageStateModel.isGroupByDay()">
        <a ng-click="centerMapOnGroup()" href="javascript:void(0)">
          <span class="glyphicon glyphicon-screenshot"></span>
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="item-group-header-text-template">
    <span ng-if="itemGroupModel.isDayGrouping()">
      <span ng-if="itemGroupModel.groupKey > 0">
        Day [[itemGroupModel.groupKey]]
      </span>
      <span ng-if="!itemGroupModel.groupKey">
        Not Planned By Day
      </span>
    </span>
    <span ng-if="itemGroupModel.isCategoryGrouping()">
      <span ng-switch on="itemGroupModel.groupKey">
        {# TODO: Put the taxonomy here and just get the display name
           given the category id. #}
        <span ng-switch-when="lodging">Lodging</span>
        <span ng-switch-when="food_and_drink">Food &amp; Drink</span>
        <span ng-switch-when="attractions">Attractions</span>
        <span ng-switch-when="activities">Activities</span>
        <span ng-switch-when="entertainment">Entertainment</span>
        <span ng-switch-when="shopping">Shopping</span>
        <span ng-switch-default>Not Categorized</span>
      </span>
    </span>
  </script>

  <script type="text/ng-template" id="one-entity-leftnav-template">
    <div ng-controller="EntityCtrl" class="one-entity-leftnav"
      tc-entity-id="[[ed['entity_id'] ]]"
      ng-class="{'selected': pageStateModel.entityIsSelected(ed['entity_id'])}"
      ng-click="selectEntity(ed); openInfowindow()">
      <span class="entity-circle-img">
        <img ng-src="[[item.getBackgroundImageUrl(planModel.locationLatlng())]]"/>
      </span>
      <span class="entity-info">
        <div class="name">
          [[ed['name'] ]]
        </div>
        <div class="details">
          <span ng-show="item.hasCategory()"
            ng-class="'text-' + ed['category']['name']">
            [[item.categoryDisplayText()]]
          </span>
          <span ng-show="item.day() && pageStateModel.isGroupByCategory()" ng-class="day">
            Day [[item.day()]]
          </span>
          <span class="glyphicon glyphicon-star favorite-star" ng-show="ed['starred']">
          </span>
        </div>
      </span>
    </div>
  </script>

  <script type="text/ng-template" id="one-entity-listing-template">
    <div class="one-entity-listing"
      tc-entity-id="[[ed['entity_id'] ]]"
      ng-class="{'selected': isSelected({$entityData: ed})}"
      ng-click="onSelect({$entityData: ed})">
      <span class="entity-circle-img">
        <img ng-src="[[im.getBackgroundImageUrl()]]" draggable="false"/>
      </span>
      <span class="entity-info">
        <div class="name">
          [[ed['name'] ]]
        </div>
        <div class="details">
          <span ng-show="im.hasCategory()"
            ng-class="'text-' + ed['category']['name']">
            [[im.categoryDisplayText()]]
          </span>
          <span ng-show="im.day() && shouldShowDay" ng-class="day">
            Day [[im.day()]]
          </span>
          <span class="glyphicon glyphicon-star favorite-star" ng-show="ed['starred']">
          </span>
        </div>
      </span>
    </div>
  </script>

  <script type="text/ng-template" id="mapview-one-note-template">
    <div ng-controller="NoteCtrl" class="one-note-mapview">
      <div ng-show="!editing">
        <div class="note-text">[[nd['text'] ]]</div>
      </div>
      <div ng-show="editing">
        <textarea ng-model="nd['text']" tc-focus-on="editing" class="form-control"
          ng-blur="saveNote()">
        </textarea>
      </div>
      <div class="controls" ng-show="!editing">
        <a ng-click="openEditNote()" href="javascript:void(0)">
          <span class="glyphicon glyphicon-pencil"></span>
        </a>
      </div>
    </div>
  </script>
 
  <script type="text/ng-template" id="getting-started-template">
    <div class="getting-started-directions">
      <div class="welcome">
        Welcome to your new trip plan
      </div>
      <div class="section">
        Click the <b>Add Place</b> button to start adding places to your trip.
      </div>
      <div class="section">
        You can also also add places while browsing other websites.
      </div>
      <div class="bookmarklet-section">
        <a href="javascript:(function(){c=document.createElement('script');c.type='text/javascript';c.src='{{bookmarklet_url}}'+'?'+Math.floor(Math.random()*99999999);document.body.appendChild(c);})();"
          ng-click="$event.stopPropagation(); $event.preventDefault()">
          <span class="bookmarklet">
            <span class="glyphicon glyphicon-paperclip"></span> Travel Clipper
          </span>
        </a>
      </div>
      <div class="section">
        Drag the clipper to your bookmarks bar and then try searching these supported sites for places in
        [[planModel.tripPlanData['location_name'] ]].
      </div>
      <div class="section sample-sites">
        <a ng-href="http://www.hotels.com/search.do?destination=[[planModel.demoQueryString()]]"
          target="_blank" class="site-link">
          <img src="http://www.hotels.com/favicon.ico" class="favicon"/> Hotels.com
        </a>
        <br/>
        <a ng-href="https://www.airbnb.com/s/[[planModel.demoQueryString()]]" target="_blank" class="site-link">
          <img src="http://www.airbnb.com/favicon.ico" class="favicon"/> Airbnb
        </a>
        <br/>
        <a ng-href="http://www.tripadvisor.com/Search?q=[[planModel.demoQueryString()]]"
          target="_blank" class="site-link">
          <img src="http://www.tripadvisor.com/favicon.ico" class="favicon"/> TripAdvisor
        </a>
        <br/>
        <a ng-href="http://www.yelp.com/search?find_loc=[[planModel.demoQueryString()]]"
          target="_blank" class="site-link">
          <img src="http://www.yelp.com/favicon.ico" class="favicon"/> Yelp
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="guide-panel-template">
    <div class="guide-panel"
      tc-scroll-to-selector scroll-on-changes-to="pageStateModel.selectedEntity"
      scroll-dest-selector=".one-entity-guideview[tc-entity-id='[[pageStateModel.selectedEntity['entity_id'] ]]']">
      <div class="overview">
        <div class="guide-panel-hero-img" ng-if="planModel.hasCoverImage()"
          ng-style="{'background-image': 'url(&quot;' + planModel.tripPlanData['cover_image_url'] + '&quot;)'}">
          <div class="title-floater">
            [[planModel.tripPlanName()]]
          </div>
        </div>
        <div class="default-hero-img" ng-if="!planModel.hasCoverImage()">
          <div class="title-floater">
            [[planModel.tripPlanName()]]
          </div>
        </div>
        <div class="description" ng-if="planModel.hasDescription()"><span ng-bind-html="planModel.tripPlanData['description'] | linky:'_blank'"></span></div>
        {% if not allow_editing %}
        <div class="clip-cta">
          <a href="javascript:void(0)">            
            Like what you see? Copy places to your own trip.
            <span class="clip-control">
              <span class="glyphicon glyphicon-new-window"></span>
            </span>
          </a>
        </div>
        {% endif %}
      </div>
      <div ng-repeat="itemGroupModel in itemGroups" ng-include="'guideview-item-group-template'">
      </div>
      <div class="mapview-footer">
        Copyright 2014 Unicycle Labs
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="guideview-item-group-template">
    <div ng-controller="GuideviewItemGroupCtrl" ng-show="itemGroupModel.hasContent()" ng-if="itemGroupModel.getEntityItems().length != 0">
<!--       <div class="guideview-item-group-header">
        <h3 ng-include="'item-group-header-text-template'"></h3>
      </div> -->
      <div ng-repeat="item in itemGroupModel.getEntityItems()">
        <div ng-include="'guideview-one-entity-template'">
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="guideview-one-entity-template">
    <div ng-controller="GuideviewEntityCtrl"
      class="one-entity-guideview"
      ng-show="show"
      tc-entity-id="[[ed['entity_id'] ]]">
      <hr class="entity-separator"/>
      <div class="name">
        <h4>[[ed['name'] ]]</h4>
        <div class="star">
          {% if allow_editing %}
          <a ng-click="saveStarState(false)" href="javascript:void(0)">
            <span class="glyphicon glyphicon-star favorite-star" ng-show="ed['starred']"></span>
          </a>
          <a ng-click="saveStarState(true)" href="javascript:void(0)">
            <span class="glyphicon glyphicon-star-empty" ng-show="!ed['starred']"></span>
          </a>
          {% else %}
          <span class="glyphicon glyphicon-star favorite-star" ng-show="ed['starred']"></span>
          {% endif %}
        </div>
      </div>
      <div ng-if="item.hasPhotos()" class="photo-carousel">
        <span class="vertical-spacer"></span><!--
        --><span tc-image-carousel urls="ed['photo_urls']" class="carousel-content">
        </span>
      </div>
       <div class="metadata">
        <div class="address">
          [[ed['address'] ]]
        </div>
        <div class="source-info" ng-show="ed['source_url']">
          <a ng-href="[[ed['source_url'] ]]" target="_blank">
            From <span class="source-text">[[ed['source_url'] | hostname ]]</span>
          </a>
        </div>
      </div>
      <div class="description"><span ng-bind-html="ed['description'] | linky:'_blank'"></span></div>
      <div class="controls">
        {% if allow_editing %}
        <span class="editor-controls">
          <a ng-click="openEditPlaceModal('edit-place-modal')" href="javascript:void(0)">
            Edit <span class="glyphicon glyphicon-pencil"><span>
          </a>
          <a ng-click="openDayPlanner()" href="javascript:void(0)">
            Plan <span class="glyphicon glyphicon-calendar"><span>
          </a>
          <a ng-click="deleteEntity()" href="javascript:void(0)">
            Delete <span class="glyphicon glyphicon-trash"><span>
          </a>
        </span>
        {% endif %}
        {% if not allow_editing %}
        <span class="clip-cta">
          <a ng-click="reclipEntity()" href="javascript:void(0)">
            Clip to My Trip
            <span class="glyphicon glyphicon-paperclip"></span>
          </a>
        </span>
        {% endif %}
      </div>
      <div class="inline-day-planner" ng-if="dayPlannerActive">
        <tc-day-select-dropdown entity-data="ed" on-select="closeDayPlanner()">
        </tc-day-select-dropdown>
        <a ng-click="closeDayPlanner()" href="javascript:void(0)">
          Close <span class="caret caret-up"></span>
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="trip-plan-header-template">
    <div id="trip-plan-header" ng-show="!planModel.isEmpty()">
      <div class="trip-plan-info">
        <div class="title" ng-show="!editingTripPlanSettings">
          [[planModel.tripPlanName()]]
        </div>
        <div class="creator-info">
          <span ng-if="planModel.hasSource()">
            Inspired by: [[planModel.tripPlanData['source_url'] | hostNoSuffix ]]
          </span>
          <span ng-if="!planModel.hasSource() && planModel.creatorIsUser()">
            Created by: [[planModel.tripPlanData['creator'] | emailPrefix ]]
          </span>
        </div>
      </div>
      <div class="controls" tc-lock-after-scroll scroll-parent="#entity-container"
        class-when-fixed="fixed" recompute-spread-on="planModel.tripPlanName()">
        <a class="dropdown-toggle" href="javascript:void(0)">
          Organize <span class="caret"></span>
        </a>
        <ul class="dropdown-menu organize-dropdown" ng-controller="OrganizeMenuCtrl">
          Sort
          <li>
            <a ng-click="groupByCategory()" href="javascript:void(0)">
              by Type
              <span ng-if="pageStateModel.isGroupByCategory()" class="glyphicon glyphicon-ok"></span>
            </a>
          </li>
          <li>
            <a ng-click="groupByDay()" href="javascript:void(0)">
              by Day
              <span ng-if="pageStateModel.isGroupByDay()" class="glyphicon glyphicon-ok"></span>
            </a>
          </li>
          <hr class="dropdown-separator"/>
          Filter
          <li ng-click="suppress($event)">
            <a ng-click="typesExpanded = !typesExpanded" href="javascript:void(0)">
              by Type
              <span class="glyphicon"
                ng-class="{'glyphicon-collapse-down': !typesExpanded, 'glyphicon-collapse-up': typesExpanded}">
              </span>
            </a>
            <ul ng-show="typesExpanded">
              <li ng-repeat="category in categories">
                <a ng-click="filterModel.toggleCategory(category); broadcastFilters(filterModel)" href="javascript:void(0)">
                  [[category['display_name'] ]]
                  <span ng-show="filterModel.isCategorySelected(category)" class="glyphicon glyphicon-ok"></span>
                </a>
              </li>
            </ul>
          </li>
          <li ng-click="suppress($event)">
            <a ng-click="daysExpanded = !daysExpanded" href="javascript:void(0)">
              by Day
              <span class="glyphicon"
                ng-class="{'glyphicon-collapse-down': !daysExpanded, 'glyphicon-collapse-up': daysExpanded}">
              </span>
            </a>
            <ul ng-show="daysExpanded">
              <li ng-repeat="dayNumber in dayNumbers">
                <a ng-click="filterModel.toggleDay(dayNumber); broadcastFilters(filterModel)" href="javascript:void(0)">
                  Day [[dayNumber]]
                  <span ng-show="filterModel.isDaySelected(dayNumber)" class="glyphicon glyphicon-ok"></span>
                </a>
              </li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </script>

  {% if allow_editing and not plan.location_bounds %}
  <script type="text/ng-template" id="start-new-trip-modal-template">
    <div class="start-new-trip-modal">
      <div tc-start-new-trip-input on-select-place="selectTripLocation($tripPlanDetails)">
      </div>
    </div>
  </script>
  {% endif %}

  {% if allow_editing %}
  <script type="text/ng-template" id="gmaps-importer-template">
    <div class="gmaps-importer-modal" ng-controller="GmapsImporterCtrl">
      <h3>Import a Google custom map</h3>
      <div ng-show="!pendingTripPlan && !newTripPlan">
        <div class="paste-prompt-text">
          Paste a Google Maps Engine or My Maps url
        </div>
        <input type="text" class="form-control" placeholder="Paste a url"
          ng-model="url" ng-paste="urlPasted()" ng-disabled="importing"
          tc-focus-on="ready"/>
        <div ng-show="importing" class="search-spinner">
          <img src="/static/img/spinner-small.gif"/>
        </div>
        <div ng-show="urlInvalid" class="text-danger">
          That's not a vaid Google custom maps url.
        </div>
      </div>
      <div ng-if="saving" class="save-spinner">
        <img src="/static/img/spinner2.gif"/>
      </div>
      <div ng-show="pendingTripPlan && !newTripPlan && !saving">
        <div class="import-success-text">
          Successfully imported [[pendingTripPlan['entities'].length ]] places
          from the map
          <span class="map-name">[[pendingTripPlan['name'] ]]</span>
        </div>
        <form class="form-inline" role="form">
          <input type="radio" class="form-control" value="new" ng-model="importAction" id="new-action"/>
          <label for="new-action">
            Create a new trip plan
          </label>
          <br/>
          <input type="radio" class="form-control" value="import" ng-model="importAction" id="import-action"/>
          <label for="import-action">
            Add all [[pendingTripPlan['entities'].length ]] places to the current trip plan (<span class="map-name">[[currentTripPlanName]]</span>)
          </label>
        </form>
        <div class="buttons">
          <button class="btn btn-primary" ng-click="save()">
            Save
          </button>
          <button class="btn" ng-click="$close()">
            Cancel
          </button>
        </div>
      </div>
      <div ng-show="newTripPlan">
        <div class="import-success-text" ng-show="importAction == 'new'">
          Successfully created the new trip plan
          <a ng-href="/trip_plan/[[newTripPlan['trip_plan_id'] ]]">
            [[newTripPlan['name'] ]]
          </a>
        </div>
        <div class="buttons">
          <button class="btn" ng-click="$close()">
            Close
          </button>
        </div>
      </div>
    </div>
  </script>
  {% endif %}

  {% if allow_editing %}
  <script type="text/ng-template" id="omnibox-template">
    <div class="omnibox-container">
      <div class="omnibox-content">
          <input type="text" class="form-control"
            placeholder="Search for a place or address"
            tc-google-place-autocomplete search-bounds-json="planModel.tripPlanData['location_bounds']"
            tc-focus-on="omniboxFocus"
            on-place-change="googlePlaceSelected($newPlace)"
            ng-model="queryState.rawQuery"
            ng-disabled="loadingData"
            ng-paste="textPasted()"/>
          <div ng-show="loadingData" class="search-spinner">
            <img src="/static/img/spinner-small.gif"/>
          </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="add-place-panel-template">
    <div class="add-place-panel" ng-controller="AddPlacePanelCtrl"
      tc-scroll-to-selector scroll-on-changes-to="searchResultState.selectedIndex"
      scroll-dest-selector=".one-entity-search-result[tc-entity-result-id='[[searchResultState.selectedIndex]]']">
      <div ng-if="pageStateModel.inAddPlacePanel()" class="panel-content">
        <div class="search-results-panel">
          <div class="search-results" ng-show="searchResults && searchResults.length">
            <h4 ng-show="resultsAreFromSearch">Results from Google Places</h4>
            <h4 ng-show="!resultsAreFromSearch">Results</h4>
            <div class="search-again">
              <a ng-click="openOmnibox(pageStateModel.midPanelExpanded ? 'omnibox-modal-window mid-panel-expanded' : 'omnibox-modal-window')"
                href="javascript:void(0)">
                <span class="glyphicon glyphicon-search"></span> Search again
              </a>
            </div>
            <div ng-repeat="result in searchResults" tc-entity-search-result
              entity-data="result" index="$index"
              search-result-state="searchResultState">
            </div>
          </div>
          <div ng-show="!searchResults || !searchResults.length">
            <h4>No places found</h4>
          </div>
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="one-entity-search-result-template">
    <div class="one-entity-search-result"
      tc-entity-result-id="[[index]]"
      ng-class="{'selected': searchResultState.selectedIndex == index}"
      ng-click="selectResult()">
      <span class="entity-circle-img">
        <img ng-src="[[im.getBackgroundImageUrl(planModel.locationLatlng())]]"/>
      </span>
      <span class="result-letter">
        [[resultLetter()]]
      </span>
      <span class="entity-info">
        <div class="name">
          [[ed['name'] ]]
        </div>
        <div class="details">
          <span ng-show="im.hasCategory()"
            ng-class="'text-' + ed['category']['name']">
            [[im.categoryDisplayText()]]
          </span>
          <span ng-show="searchResultState.savedResultIndices[index]" class="save-confirmation">
            saved
          </span>
        </div>
      </span>
    </div>
  </script>

  <script type="text/ng-template" id="results-details-panel-template">
    <div class="results-details-panel"
      tc-scroll-to-selector scroll-on-changes-to="searchResultState.selectedIndex"
      scroll-dest-selector=".one-entity-search-result-details[tc-entity-result-id='[[searchResultState.selectedIndex]]']">
      <div ng-repeat="result in searchResultState.results"
        tc-entity-search-result-details index="$index" entity-data="result"
        search-result-state="searchResultState">
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="one-entity-search-result-details-template">
    <div class="one-entity-search-result-details" tc-entity-result-id="[[index]]">
      <hr class="entity-separator" ng-show="index > 0"/>
      <div class="name">
        <h4>[[ed['name'] ]]</h4>
      </div>
      <div ng-if="ed['photo_urls'] && ed['photo_urls'].length" class="photo-carousel">
        <span class="vertical-spacer"></span><!--
        --><span tc-image-carousel urls="ed['photo_urls']" class="carousel-content">
        </span>
      </div>
       <div class="metadata">
        <div class="address">
          [[ed['address'] ]]
        </div>
        <div class="source-info" ng-show="ed['source_url']">
          <a ng-href="[[ed['source_url'] ]]" target="_blank">
            From <span class="source-text">[[ed['source_url'] | hostname ]]</span>
          </a>
        </div>
      </div>
      <div class="description"><span ng-bind-html="ed['description'] | linky:'_blank'"></span></div>
      <div class="controls">
        <span class="save-cta" ng-show="!searchResultState.savedResultIndices[index]">
          <a ng-click="saveResult()" href="javascript:void(0)">
            <span class="glyphicon glyphicon-plus"></span>
            Add to trip
          </a>
        </span>
        <span class="save-confirmation" ng-show="searchResultState.savedResultIndices[index]">
          saved
        </span>
      </div>
    </div>
  </script>
  {% endif %}

  {% if allow_editing %}
  <script type="text/ng-template" id="trip-plan-settings-editor-template">
    <div class="trip-plan-settings-editor" ng-controller="TripPlanSettingsEditorCtrl">
      <div class="header">
        <div class="title">Trip Plan Settings</div>
        <div class="button-panel">
          <button class="btn btn-primary" ng-click="saveSettings()">
            Save
          </button>
          <button class="btn btn-default" ng-click="$close()">
            Cancel
          </button>
        </div>
      </div>
      <div class="editor-body container-fluid">
        <div class="row">
          <div class="col-sm-6">
            <h4>Name</h4>
            <input type="text" class="form-control" ng-model="tpd['name']"/>
            <h4>Description</h4>
            <textarea class="form-control description-input" ng-model="tpd['description']"></textarea>
          </div>
          <div class="col-sm-6">
            <h4>Cover Image</h4>
            <div class="cover-img-container" ng-if="tpd['cover_image_url'] && !editingImage">
              <img ng-src="[[tpd['cover_image_url'] ]]"/>
              <div class="img-control top-control">
                <a ng-click="changeImage()" href="javascript:void(0)">
                  Change image
                  <span class="glyphicon glyphicon-picture"></span>
                </a>
              </div>
              <div class="img-control bottom-control">
                <a ng-click="removeImage()" href="javascript:void(0)">
                  Remove image
                  <span class="glyphicon glyphicon-trash"></span>
                </a>
              </div>
            </div>
            <div class="cover-img-editor" ng-if="editingImage">
              <textarea class="cover-img-drop-target" placeholder="Drag and drop an image or paste an image url"
                ng-model="coverImgUrlInput.text" ng-change="coverImgUrlChanged()" ng-paste="coverImgUrlPasted()"
                tc-dragenter="coverImgDragenter()" tc-dragover="$event.preventDefault()" tc-drop="coverImgUrlDropped($event)"
                ng-class="{'dragactive': coverImgDragActive}">
              </textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
  </script>
  {% endif %}

  <script type="text/ng-template" id="compass-icon-template">
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" width="100.5px" height="93.846px" viewBox="0 0 100.5 93.846" enable-background="new 0 0 100.5 93.846" xml:space="preserve">
      <g id="BLOCK_x5F_RECORD">
        <g id="ARC_3_">
          <g id="XMLID_1_">
            <g>
              <path d="M63.67,39.313c2.28,3.92,2.28,10.29,0,14.209L49.75,80.793L35.83,53.523c-2.28-3.92-2.28-10.29,0-14.209l13.92-27.27      L63.67,39.313z M56,46.423c0-3.45-2.8-6.25-6.25-6.25s-6.25,2.8-6.25,6.25s2.8,6.25,6.25,6.25S56,49.873,56,46.423z"/>
              <path d="M49.75-3.577c27.61,0,50,22.38,50,50c0,27.61-22.39,50-50,50c-27.62,0-50-22.39-50-50      C-0.25,18.803,22.13-3.577,49.75-3.577z M93.5,46.423c0-24.16-19.59-43.75-43.75-43.75S6,22.263,6,46.423      s19.59,43.75,43.75,43.75S93.5,70.583,93.5,46.423z"/>
            </g>
            <g>
            </g>
          </g>
        </g>
      </g>
    </svg>
  </script>

  {% if allow_editing %}
  {% include 'entity-result.html' %}
  {% endif %}

  {% include 'widgets.html' %}

  <script>
    initApp(
      {{plan.to_json_str()|safe}},
      {{entities_json|safe}},
      {{notes_json|safe}},
      {{all_trip_plans_json|safe}},
      {{account_info.to_json_str()|safe}},
      {{all_datatype_values.to_json_str()|safe}},
      {{allow_editing|jsbool}},
      {{sample_sites_json|safe}},
      {{initial_state.to_json_str()|safe}});
  </script>
</body>
</html>
