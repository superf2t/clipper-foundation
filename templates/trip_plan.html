<!doctype html>
<html>
<head>
  <title>{{plan.name}}</title>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="//maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>
  <script src="//cdn.jsdelivr.net/underscorejs/1.6.0/underscore-min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular-sanitize.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular-animate.min.js"></script>
  <script src="/static/js/ui-bootstrap-tpls-0.11.0.min.js"></script>
  <script src="/static/js/sprintf.js"></script>
  <script src="/static/js/services.js"></script>
  <script src="/static/js/script.js"></script>
  <link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Raleway:300|Nunito:300">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="shortcut icon" href="/static/img/globe.png">
</head>
<body ng-controller="RootCtrl">
  <nav class="navbar navbar-default navbar-fixed-top" role="navigation" id="travel-clip-navbar">
    <div class="container-fluid">
      <div class="navbar-header">
        <a class="navbar-brand" id="logo" href="#">TravelClipper</a>
      </div>
      <div class="collapse navbar-collapse" id="header-navbar-collapse">
        <ul class="nav navbar-nav navbar-right" id="header-site">
          <li>
            <ul class="nav nav-pills">
              <li class="view-mode-pill dropdown">
                <a href="javascript:void(0)" class="dropdown-toggle">
                  <span class="glyphicon glyphicon-user" id="header-user"></span>
                </a>
                <div tc-include-and-replace="account-dropdown-template">
                </div>
              </li>
            <ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div id="left-panel" ng-show="pageStateModel.shouldShowLeftPanel()">
    <div id="entity-container" class="entity-container"
      tc-entity-scroll scroll-state="scrollState"
      tc-save-scroll-position scroll-position-watch="itemGroups">

      <div ng-include="'trip-plan-header-template'">
      </div>

      <div ng-repeat="itemGroupModel in itemGroups">
        <div ng-include="'item-group-template'">
        </div>
      </div>

      {% if needs_tutorial %}
      <div ng-include="'tutorial-left-panel-template'" ng-if="pageStateModel.shouldShowTutorialLeftPanel()">
      </div>
      {% endif %}
    </div>
  </div>

  <div id="mid-panel" ng-show="pageStateModel.shouldShowMidPanel()"
    ng-class="{'closed': !pageStateModel.midPanelExpanded}"
    class="closed">
    <div ng-include="'guide-panel-template'" class="full-width full-height"
      ng-show="!pageStateModel.inAddPlacePanel()">
    </div>
    {% if allow_editing %}
    <div ng-include="'add-place-panel-template'" class="full-width full-height"
      ng-if="pageStateModel.inAddPlacePanel()">
    </div>
    {% endif %}
  </div>

  <div id="map-panel" tc-animate-on-bool="!pageStateModel.midPanelExpanded"
    tc-transitionend="updateMap()"
    class-when-true="mid-panel-closed" after-complete="updateMap()"
    ng-class="{'full-screen': pageStateModel.isMapFullScreen()}"
    class="mid-panel-closed
      {% if needs_tutorial %}full-screen{% endif %}
      ">
    <div id="map-container">
      <div id="map">
      </div>
    </div>
    <div ng-include="'control-buttons-template'">
    </div>
    {% if needs_tutorial %}
    <div ng-include="'tutorial-map-panel-template'" ng-show="pageStateModel.inTutorial()">
    </div>
    {% endif %}
  </div>

  <script type="text/ng-template" id="account-dropdown-template">
    <ul class="account-dropdown dropdown-menu" ng-controller="AccountDropdownCtrl">
      <li class="account-dropdown-login-info" ng-click="$event.stopPropagation()">
        <div ng-show="accountInfo.loggedIn && !showLoginForm">
          <span class="logged-in-email">[[accountInfo['email'] ]]</span>
          <span class="logout-link">
            <a href="javascript:void(0)" ng-click="showLoginForm = true">Logout</a>
          </span>
        </div>
        <div ng-show="showLoginForm">
          <form role="form" ng-submit="doLogin()">
            <input type="text" class="form-control email-entry-input"
              ng-model="accountInfo['email']"
              placeholder="Enter your email to login"/>
            <button type="submit()" class="btn btn-default btn-login">Login</button>
          </form>
        </div>
      </li>
      <li ng-show="allTripPlans">
        <div class="my-trip-plans-heading">
          My Trip Plans
        </div>
      </li>
      <li ng-repeat="tripPlan in allTripPlans">
        <span ng-if="tripPlan['trip_plan_id'] == currentTripPlan['trip_plan_id']">
          {# Use the name from the shared info container so it will auto update 
             if the user edits it inline. #}
          [[currentTripPlan['name'] ]]
        </span>
        <span ng-if="tripPlan['trip_plan_id'] != currentTripPlan['trip_plan_id']">
            <a href="javascript:void(0)" ng-click="loadTripPlan(tripPlan['trip_plan_id'])">
              [[tripPlan['name'] ]]
            </a>
          </span>
      </li>
      <li class="create-new-trip-dropdown-link">
        <span>
          <a href="javascript:void(0)" ng-click="createNewTripPlan()">Create New Trip Plan</a>
        </span>
      </li>
    </ul>
  </script>

  <script type="text/ng-template" id="control-buttons-template">
    <div id="main-control-buttons">
      <div class="left-buttons">
        <button class="btn btn-primary view-guide-btn" ng-click="openGuide()">
          <span class="glyphicon glyphicon-picture"></span>
          View Guide
        </button>
        {% if allow_editing %}
        <span class="add-place-button-container dropdown">
          <button class="btn btn-primary add-place-btn dropdown-toggle">
            <span class="glyphicon glyphicon-plus"></span>
            Add Places
          </button>
          <div tc-include-and-replace="add-place-mode-dropdown-template">
          </div>
        </span>
        {% endif %}
      </div>
      {% if allow_editing %}
      <div class="right-buttons dropdown">
        <button class="btn settings-btn dropdown-toggle">
          <span class="glyphicon glyphicon-cog"></span>
        </button>
        <ul class="dropdown-menu right-top-dropdown-menu">
          <li>
            <a ng-click="openTripPlanEditor('trip-plan-settings-editor-modal')" href="javascript:void(0)">Edit trip name and settings</a>
          </li>
          <li>
            <a href="javascript:void(0)">Advanced Places Editor</a>
          </li>
          <li>
            <a ng-click="openDayPlanner('day-planner-modal-window')" href="javascript:void(0)">Advanced Planner</a>
          </li>
          <li>
            <a ng-click="startGmapsImport()" href="javascript:void(0)">Import Google Custom Map</a>
          </li>
          <li>
            <a ng-click="deleteCurrentTripPlan()" href="javascript:void(0)">Delete Trip</a>
          </li>
        </ul>
      </div>
      {% endif %}
    </div>
  </script>

  <script type="text/ng-template" id="add-place-mode-dropdown-template">
    <ul class="dropdown-menu add-place-options-dropdown"
      ng-controller="AddPlaceOptionsDropdownCtrl">
      <li ng-repeat="option in options">
        <a ng-click="setOption(option)" href="javascript:void(0)">
          [[option.name]]
        </a>
      </li>
    </ul>
  </script>

  <script type="text/ng-template" id="infowindow-template">
    <div class="infowindow" ng-controller="InfowindowCtrl"
      ng-click="suppressEvent($event)" ng-dblclick="suppressEvent($event)">
      <div class="infowindow-internal">
        <div class="info-section">
          <div class="name">
            [[ed['name'] ]]
          </div>
          <div class="day-and-star" ng-show="showInfoSection()">
            <span ng-show="ed['day']" class="day">Day [[ed['day'] ]]</span>
            <span ng-show="ed['starred']" class="glyphicon glyphicon-star favorite-star"></span>
            <span ng-show="ed['address_precision'] == 'Imprecise'" class="glyphicon glyphicon-exclamation-sign"
              tooltip="Location is approximate"><span>
          </div>
        </div>
        <div class="workspace-section" ng-if="workspaceActive()">
          <div ng-if="dayPlannerActive">
            <tc-day-select-dropdown entity-data="ed" on-select="closeDayPlanner()">
            </tc-day-select-dropdown>
          </div>
          <div ng-if="directionsPlannerActive" class="directions-planner">
            Get directions
            <a ng-click="toggleDirectionsDirection()" href="javascript:void(0)">
              [[directionsState.direction == 'to' ? 'to' : 'from' ]]
            </a>
            <select class="form-control"
              ng-options="e['name'] for e in allEntities"
              ng-model="directionsState.destination">
              <option value="">Select destination</option>
            </select>
            <button class="btn btn-primary go-button" ng-click="getDirections()"
              ng-disabled="!directionsState.destination">
              Go
            </button>
          </div>
        </div>
        <div class="tool-section" ng-include="'map-marker-tools-template'"
          ng-show="!pageStateModel.inAddPlacePanel()">
        </div>
      </div>
    </div>
  </script>

  {% if allow_editing %}
  <script type="text/ng-template" id="results-infowindow-template">
    <div class="infowindow results-infowindow"
      ng-click="suppressEvent($event)" ng-dblclick="suppressEvent($event)">
      <div class="infowindow-internal">
        <div class="info-section">
          <div class="name">
            [[ed['name'] ]]
          </div>
        </div>
        <div class="tools-section">
          <a ng-click="saveResult()" href="javascript:void(0)"
            ng-show="!searchResultState.savedResultIndices[index]">
            <span class="glyphicon glyphicon-plus"></span> Add to trip
          </a>
          <div class="save-confirmation" ng-show="searchResultState.savedResultIndices[index]">
            saved
          </div>
        </div>
      </div>
    </div>
  </script>
  {% endif %}

  <script type="text/ng-template" id="map-marker-tools-template">
    <div class="marker-tools">
      {% if allow_editing %}
      <span class="editor-controls">
        <a ng-click="openEditPlaceModal('edit-place-modal')" href="javascript:void(0)" tooltip="Edit" tooltip-placement="bottom">
          <span class="glyphicon glyphicon-pencil"></span>
        </a>
        <a ng-click="toggleDayPlanner()" href="javascript:void(0)" tooltip="Add to day" tooltip-placement="bottom">
          <span class="glyphicon glyphicon-calendar"></span>
        </a>
        <a ng-click="deleteEntity()" href="javascript:void(0)"
          tooltip="Delete" tooltip-placement="bottom">
          <span class="glyphicon glyphicon-trash"></span>
        </a>
        <a ng-click="saveStarState(true)" ng-show="!ed['starred']" href="javascript:void(0)" tooltip="Favorite" tooltip-placement="bottom">
          <span class="glyphicon glyphicon-star-empty"></span>
        </a>
        <a ng-click="saveStarState(false)" ng-show="ed['starred']" href="javascript:void(0)" tooltip="Un-favorite" tooltip-placement="bottom">
          <span class="glyphicon glyphicon-star favorite-star"></span>
        </a>
      </span>
      {% else %}
      <a ng-click="reclipEntity()" href="javascript:void(0)" tooltip="Clip this place" tooltip-placement="bottom">
        <span class="glyphicon glyphicon-paperclip"></span>
      </a>
      {% endif %}
      <a ng-click="toggleDirections()" href="javascript:void(0)" tooltip="Get directions"
        tooltip-placement="bottom">
        <span ng-include="'compass-icon-template'" class="compass-icon"></span>
      </a>
    </div>
  </script>

  <script type="text/ng-template" id="map-marker-annotations-template">
    <div class="marker-annotations" ng-show="!infowindowOpen">
      <div class="star-annotation" ng-show="ed['starred']">
        <span class="glyphicon glyphicon-star favorite-star"></span>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="day-select-dropdown-template">
    <select class="form-control"
      ng-options="option.createNew ? 'Add a new day' : 'Day ' + option.dayNumber for option in getDaySelectOptions()"
      ng-model="selectedDayState.dayModel"
      ng-change="organizeIntoDay()">
      <option value="" ng-if="!ed['day']">--Add to day--</option>
    </select>
  </script>

  <script type="text/ng-template" id="reclip-confirmation-template">
    <div ng-controller="ReclipConfirmationCtrl" class="reclip-confirmation-modal">
      <div ng-show="!reclipSucceeded">
        <div>Reclip <b>[[ed['name'] ]]</b> to:</div>
        <div tc-trip-plan-select-dropdown select-trip-plan-to="selectionState.selectedTripPlan" class="reclip-confirmation-trip-plan-dropdown"></div>
        <div ng-show="showSaveButtons()">
          <button class="btn btn-primary" ng-click="reclipEntity()">
            Save
          </button>
          <button class="btn" ng-click="dismissReclipConfirmation()">
            Cancel
          </button>
        </div>
      </div>

      <div ng-show="reclipSucceeded">
        <div class="clip-success-checkmark">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="40px" height="40px" viewBox="0 0 95.453 100" enable-background="new 0 0 95.453 100" xml:space="preserve">
          <g>
            <g>
              <polygon points="94.587,27.48 31.657,86.15 31.217,85.68 18.847,72.41 0.566,52.81 14.106,40.19 32.387,59.79 81.776,13.74"/>
            </g>
          </g>
          </svg>
        </div>
        Successfully clipped <b>[[ed['name'] ]]</b> to
        <a href="/trip_plan/[[selectionState.selectedTripPlan['trip_plan_id'] ]]" target="_blank">
          [[selectionState.selectedTripPlan['name'] ]]
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="edit-place-modal-template">
    <div class="edit-place" ng-controller="EditPlaceCtrl">
      <div class="edit-header">
        <span class="editor-title">Editor</span>
        <select ng-options="e['name'] for e in allEntities track by e['entity_id']"
          ng-model="selectedEntity" ng-change="selectedEntityChanged()">
        </select>
        <div class="button-panel">
          <button class="btn btn-primary" ng-click="saveEntity()">
            Save
          </button>
          <button class="btn btn-default" ng-click="$close()">
            Cancel
          </button>
        </div>
      </div>
      <div class="container-fluid editor-body">
        <div class="row">
          <div class="col-sm-6">
            <input type="text" class="form-control" ng-model="ed['name']" placeholder="Place name"/>
            <textarea class="form-control description-input" ng-model="ed['description']"
              placeholder="Description"></textarea>
            <div class="editable-carousel" ng-if="ed['photo_urls'] && ed['photo_urls'].length">
              <div tc-image-carousel urls="ed['photo_urls']" current-index="selectedPhoto.index">
              </div>
              <div class="photo-top-control">
                <a ng-click="setPhotoAsPrimary()" href="javascript:void(0)">
                  Set as Primary <span class="glyphicon glyphicon-picture"></span>
                </a>
              </div>
              <div class="photo-bottom-control">
                <a ng-click="deletePhoto()" href="javascript:void(0)">
                  Delete Photo <span class="glyphicon glyphicon-trash"></span>
                </a>
              </div>
            </div>
          </div>
          <div class="col-sm-6">
            <input type="text" class="form-control" ng-model="ed['address']" placeholder="Search for an address"
              tc-google-place-autocomplete search-bounds-json="locationBounds"
              location-types="geocode" on-place-change="addressChanged($newPlace)"/>
            <div class="map-container">
              <div tc-google-map class="map" map="map" map-options="mapOptions" after-creation="setupMap($map)">
              </div>
            </div>
            <form class="form-inline precision-and-star-strip" role="form">
              <input type="radio" class="form-control" value="Precise" ng-model="ed['address_precision']" ng-change="updateMarkerIcon()" id="precise-radio"/>
              <label for="precise-radio">Exact location</label>
              <input type="radio" class="form-control" value="Imprecise" ng-model="ed['address_precision']" ng-change="updateMarkerIcon()" id="imprecise-radio"/>
              <label for="imprecise-radio">Approximate location</label>
              <a ng-click="ed['starred'] = !ed['starred']" href="javascript:void(0)" class="star-control">
                <span class="glyphicon glyphicon-star"
                  ng-class="{'glyphicon-star': ed['starred'], 'glyphicon-star-empty': !ed['starred'], 'favorite-star': ed['starred']}">
                </span>
              </a>
            </form>
            <select class="form-control" ng-model="ed['category']"
              ng-options="c['display_name'] for c in categories track by c['category_id']"
              ng-change="categoryChanged()">
            </select>
            <select class="form-control" ng-model="ed['sub_category']"
              ng-options="s['display_name'] for s in getSubCategories(ed['category']['category_id']) track by s['sub_category_id']"
              ng-change="updateMarkerIcon()">
            </select>
          </div>
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="day-planner-template">
    <div ng-controller="DayPlannerCtrl" class="day-planner-modal">
      <div class="day-planner-header">
        <div class="day-planner-header-text">Plan Itinerary</div>
        <div class="day-planner-persistent-controls">
          <button class="btn btn-primary" ng-click="saveOrderings()">
            Save
          </button>
          <button class="btn" ng-click="$close()">
            Cancel
          </button>
        </div>
      </div>
      <div class="container-fluid day-planner-body">
        <div class="row-fluid">
          <div class="col-md-5 day-planner-left-panel">
            <div class="day-planner-left-panel-drag-area"
              ng-class="{'dragactive': showLeftPanelDragActive(), 'dragover': showLeftPanelDragover()}"
              tc-dragenter="onLeftPanelDragenter($event)"
              tc-dragleave="leftPanelDragover = false"
              tc-dragover="onLeftPanelDragover($event)"
              tc-dragend="onDragend(); leftPanelDragover = false"
              tc-drop="handleLeftPanelDrop($event)"
            >
              <h4 class="day-planner-panel-header">Not Planned By Day</h4>
              <div ng-repeat="item in dpm.unorderedItems" class="day-planner-unsorted-item">
                <tc-draggable-entity item="item" drag-item="dragItem"
                on-dragstart="onDragstart($event, item)" on-dragend="onDragend()">
                </tc-draggable-entity>
              </div>
            </div>
          </div>
          <div class="col-md-7 day-planner-right-panel">
            <div ng-repeat="dayModel in dpm.dayModels">
              <div class="day-planner-one-day" ng-controller="DayPlannerOneDayCtrl"
                ng-class="{'dragover': dayDragover && isValidDayForDrop()}"
                tc-dragenter="onDayDragenter($event)"
                tc-dragleave="dayDragover = false"
                tc-dragover="onDayDragover($event)"
                tc-dragend="onDragend(); dayDragover = false"
                tc-drop="handleDayDrop($event, dayModel); dayDrover = false;"
              >
                <h4 class="day-planner-day-heading">
                  Day [[dayModel.dayNumber]]
                  <span class="day-planner-edit-note-control" ng-show="!editingNote">
                    <a ng-click="openNoteEditor()" href="javascript:void(0)"
                      tooltip="Add a note" tooltip-placement="bottom">
                      <span class="glyphicon glyphicon-pencil"></span>
                    </a>
                  </span>
                </h4>

                <div class="day-planner-one-day-controls dropdown">
                  <a href="javascript:void(0)" class="dropdown-toggle">
                    <span class="glyphicon glyphicon-cog"></span>
                  </a>
                  <ul class="dropdown-menu right-top-dropdown-menu">
                    <li>
                      <a ng-click="dpm.clearDay(dayModel)" href="javascript:void(0)">
                        <span class="glyphicon glyphicon-remove"></span> Clear day
                      </a>
                      <a ng-click="dpm.deleteDay(dayModel)" href="javascript:void(0)">
                        <span class="glyphicon glyphicon-trash"></span> Remove day from trip
                      </a>
                    </li>
                  </ul>
                </div>

                <div ng-show="!editingNote" class="day-planner-one-day-note">[[dayModel.noteItem.data['text'] ]]</div>
                <div ng-show="editingNote">
                  <textarea class="form-control" ng-model="dayModel.noteItem.data['text']"
                    tc-focus-on="editingNote" ng-blur="closeNoteEditor()"
                    placeholder="Enter a note about this day">
                  </textarea>
                </div>
                <div ng-show="!dayModel.hasItems()" class="day-planner-day-cta">
                  Drag and drop places here to plan by day
                </div>
                <div tc-item-drop-target day="dayModel.dayNumber" position="0"
                  drag-item="dragItem" on-drop="handleDrop(dayModel.dayNumber, 0)">
                </div>
                <div ng-repeat="itemModel in dayModel.getItems()">
                  <tc-draggable-entity item="itemModel" drag-item="dragItem"
                    on-dragstart="onDragstart($event, itemModel)" on-dragend="onDragend()"
                    on-clear="clearItem(itemModel)">
                  </tc-draggable-entity>
                  <div tc-item-drop-target day="dayModel.dayNumber" position="itemModel.position() + 1"
                    drag-item="dragItem" on-drop="handleDrop(dayModel.dayNumber, itemModel.position() + 1)">
                  </div>
                </div>
              </div>
            </div>

            <div class="day-planner-controls">
              <button class="btn btn-default day-planner-add-day-button" ng-click="addNewDay()">
                <span class="glyphicon glyphicon-plus"></span> Add a day
              </button>
            </div>

          </div>
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="day-planner-drop-target-template">
    <div class="day-planner-drop-target"
      ng-class="{'dragactive': isDragActive(), 'dragover': dragover}"
      tc-dragenter="onDragenter($event)"
      tc-dragleave="onDragleave($event)"
      tc-dragover="onDragover($event)"
      tc-drop="onDrop(); dropDone($event)"
    >
      <div class="day-planner-drop-target-inner"
        tc-dragenter="onInnerDragenter()"
        tc-dragleave="onInnerDragleave()">
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="day-planner-entity-item-template">
    <div draggable="true" class="day-planner-draggable-entity"
      ng-class="{'existing-item-dragactive': activeItemIsThis(item)}"
      tc-dragstart="onDragstart({$event: $event})" tc-dragend="onDragend()">
      <tc-entity-listing entity-data="item.data">
      </tc-entity-listing>
      <div class="draggable-entity-controls">
        <a ng-click="onClear()" href="javascript:void(0)" tooltip="Remove from day">
          <span class="glyphicon glyphicon-remove"></span>
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="item-group-template">
    <div ng-controller="ItemGroupCtrl" ng-show="itemGroupModel.hasContent()" ng-if="itemGroupModel.getEntityItems().length != 0">
      <div ng-include="'item-group-header-template'">
      </div>
      <div ng-show="show()">
        <div ng-repeat="item in itemGroupModel.getNonemptyNoteItems()">
          <div ng-include="'mapview-one-note-template'">
          </div>
        </div>
        <div ng-repeat="item in itemGroupModel.getEntityItems()">
          <div ng-include="'one-entity-leftnav-template'">
          </div>
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="item-group-header-template">
    <div class="item-group-header">
      <h4>
        <span ng-include="'item-group-header-text-template'"></span>
      </h4>
      <div class="item-group-controls" ng-show="pageStateModel.isGroupByDay()">
        <a ng-click="emphasizeDay(itemGroupModel.groupKey); centerMapOnGroup()" href="javascript:void(0)">
          <span class="glyphicon glyphicon-screenshot"></span>
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="item-group-header-text-template">
    <span ng-if="itemGroupModel.isDayGrouping()">
      <span ng-if="itemGroupModel.groupKey > 0">
        Day [[itemGroupModel.groupKey]]
      </span>
      <span ng-if="!itemGroupModel.groupKey">
        Not Planned By Day
      </span>
    </span>
    <span ng-if="itemGroupModel.isCategoryGrouping()">
      <span ng-switch on="itemGroupModel.groupKey">
        {# TODO: Put the taxonomy here and just get the display name
           given the category id. #}
        <span ng-switch-when="lodging">Lodging</span>
        <span ng-switch-when="food_and_drink">Food &amp; Drink</span>
        <span ng-switch-when="attractions">Attractions</span>
        <span ng-switch-when="activities">Activities</span>
        <span ng-switch-when="entertainment">Entertainment</span>
        <span ng-switch-when="shopping">Shopping</span>
        <span ng-switch-default>Not Categorized</span>
      </span>
    </span>
  </script>

  <script type="text/ng-template" id="one-entity-leftnav-template">
    <div ng-controller="EntityCtrl" class="one-entity-leftnav"
      tc-entity-id="[[ed['entity_id'] ]]"
      ng-class="{'selected': pageStateModel.entityIsSelected(ed['entity_id'])}"
      ng-click="selectEntity(ed); openInfowindow()">
      <span class="entity-circle-img">
        <img ng-src="[[item.getBackgroundImageUrl(planModel.locationLatlng())]]"/>
      </span>
      <span class="entity-info">
        <div class="name">
          [[ed['name'] ]]
        </div>
        <div class="details">
          <span ng-show="item.hasCategory()"
            ng-class="'text-' + ed['category']['name']">
            [[item.categoryDisplayText()]]
          </span>
          <span ng-show="item.day() && pageStateModel.isGroupByCategory()" ng-class="day">
            Day [[item.day()]]
          </span>
          <span class="glyphicon glyphicon-star favorite-star" ng-show="ed['starred']">
          </span>
        </div>
      </span>
      <tc-entity-marker map="map" marker="markerState.marker" position="position"
        category-name="ed['category'] && ed['category']['name']"
        icon-template-name="markerState.iconTemplateName"
        selected="pageStateModel.entityIsSelected(ed['entity_id'])"
        precise="ed['address_precision'] == 'Precise'"
        starred="ed['starred']"
        emphasized="markerState.emphasized" deemphasized="markerState.deemphasized"
        on-click="markerClicked($event)">
      </tc-entity-marker>
    </div>
  </script>

  <script type="text/ng-template" id="one-entity-listing-template">
    <div class="one-entity-listing"
      tc-entity-id="[[ed['entity_id'] ]]"
      ng-class="{'selected': isSelected({$entityData: ed})}"
      ng-click="onSelect({$entityData: ed})">
      <span class="entity-circle-img">
        <img ng-src="[[im.getBackgroundImageUrl()]]" draggable="false"/>
      </span>
      <span class="entity-info">
        <div class="name">
          [[ed['name'] ]]
        </div>
        <div class="details">
          <span ng-show="im.hasCategory()"
            ng-class="'text-' + ed['category']['name']">
            [[im.categoryDisplayText()]]
          </span>
          <span ng-show="im.day() && shouldShowDay" ng-class="day">
            Day [[im.day()]]
          </span>
          <span class="glyphicon glyphicon-star favorite-star" ng-show="ed['starred']">
          </span>
        </div>
      </span>
    </div>
  </script>

  <script type="text/ng-template" id="mapview-one-note-template">
    <div ng-controller="NoteCtrl" class="one-note-mapview">
      <div ng-show="!editing">
        <div class="note-text">[[nd['text'] ]]</div>
      </div>
      <div ng-show="editing">
        <textarea ng-model="nd['text']" tc-focus-on="editing" class="form-control"
          ng-blur="saveNote()">
        </textarea>
      </div>
      <div class="controls" ng-show="!editing">
        <a ng-click="openEditNote()" href="javascript:void(0)">
          <span class="glyphicon glyphicon-pencil"></span>
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="guide-panel-template">
    <div class="guide-panel"
      tc-scroll-to-selector scroll-on-changes-to="pageStateModel.selectedEntity"
      scroll-dest-selector=".one-entity-guideview[tc-entity-id='[[pageStateModel.selectedEntity['entity_id'] ]]']">
      <div class="overview">
        <div class="guide-panel-hero-img" ng-if="planModel.hasCoverImage()"
          ng-style="{'background-image': 'url(&quot;' + planModel.tripPlanData['cover_image_url'] + '&quot;)'}">
          <div class="title-floater">
            [[planModel.tripPlanName()]]
          </div>
        </div>
        <div class="default-hero-img" ng-if="!planModel.hasCoverImage()">
          <div class="title-floater">
            [[planModel.tripPlanName()]]
          </div>
        </div>
        <div class="description" ng-if="planModel.hasDescription()"><span ng-bind-html="planModel.tripPlanData['description'] | linky:'_blank'"></span></div>
        {% if not allow_editing %}
        <div class="clip-cta">
          <a ng-click="openBulkClipModal('bulk-clip-modal-window')" href="javascript:void(0)">            
            Like what you see? Copy places to your own trip.
            <span class="clip-control">
              <span class="glyphicon glyphicon-new-window"></span>
            </span>
          </a>
        </div>
        {% endif %}
        <div class="close-control">
          <a ng-click="closeMidPanel()" href="javascript:void(0)" class="white-link">
            <span class="glyphicon glyphicon-remove-circle"></span>
          </a>
        </div>
      </div>
      <div ng-repeat="itemGroupModel in itemGroups" ng-include="'guideview-item-group-template'">
      </div>
      <div class="mapview-footer">
        Copyright 2014 Unicycle Labs
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="guideview-item-group-template">
    <div ng-controller="GuideviewItemGroupCtrl" ng-show="itemGroupModel.hasContent()" ng-if="itemGroupModel.getEntityItems().length != 0">
<!--       <div class="guideview-item-group-header">
        <h3 ng-include="'item-group-header-text-template'"></h3>
      </div> -->
      <div ng-repeat="item in itemGroupModel.getEntityItems()">
        <div ng-include="'guideview-one-entity-template'">
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="guideview-one-entity-template">
    <div ng-controller="GuideviewEntityCtrl"
      class="one-entity-guideview"
      ng-show="show()"
      tc-entity-id="[[ed['entity_id'] ]]">
      <hr class="entity-separator"/>
      <div class="name">
        <h4>[[ed['name'] ]]</h4>
        <div class="star">
          {% if allow_editing %}
          <a ng-click="saveStarState(false)" href="javascript:void(0)">
            <span class="glyphicon glyphicon-star favorite-star" ng-show="ed['starred']"></span>
          </a>
          <a ng-click="saveStarState(true)" href="javascript:void(0)">
            <span class="glyphicon glyphicon-star-empty" ng-show="!ed['starred']"></span>
          </a>
          {% else %}
          <span class="glyphicon glyphicon-star favorite-star" ng-show="ed['starred']"></span>
          {% endif %}
        </div>
      </div>
      <div ng-if="item.hasPhotos()" class="photo-carousel">
        <span class="vertical-spacer"></span><!--
        --><span tc-image-carousel urls="ed['photo_urls']" class="carousel-content">
        </span>
      </div>
       <div class="metadata">
        <div class="address">
          [[ed['address'] ]]
        </div>
        <div class="source-info" ng-show="ed['source_url']">
          <a ng-href="[[ed['source_url'] ]]" target="_blank">
            From <span class="source-text">[[ed['source_url'] | hostname ]]</span>
          </a>
        </div>
      </div>
      <div class="description"><span ng-bind-html="ed['description'] | linky:'_blank'"></span></div>
      <div class="controls">
        {% if allow_editing %}
        <span class="editor-controls">
          <a ng-click="openEditPlaceModal('edit-place-modal')" href="javascript:void(0)">
            Edit <span class="glyphicon glyphicon-pencil"><span>
          </a>
          <a ng-click="openDayPlanner()" href="javascript:void(0)">
            Plan <span class="glyphicon glyphicon-calendar"><span>
          </a>
          <a ng-click="deleteEntity()" href="javascript:void(0)">
            Delete <span class="glyphicon glyphicon-trash"><span>
          </a>
        </span>
        {% endif %}
        {% if not allow_editing %}
        <span class="clip-cta">
          <a ng-click="reclipEntity()" href="javascript:void(0)">
            Clip to My Trip
            <span class="glyphicon glyphicon-paperclip"></span>
          </a>
        </span>
        {% endif %}
      </div>
      <div class="inline-day-planner" ng-if="dayPlannerActive">
        <tc-day-select-dropdown entity-data="ed" on-select="closeDayPlanner()">
        </tc-day-select-dropdown>
        <a ng-click="closeDayPlanner()" href="javascript:void(0)">
          Close <span class="caret caret-up"></span>
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="trip-plan-header-template">
    <div id="trip-plan-header">
      <div class="trip-plan-info">
        <div class="title">
          [[planModel.tripPlanName()]]
        </div>
        <div class="creator-info">
          <span ng-if="planModel.hasSource()">
            Inspired by: [[planModel.tripPlanData['source_url'] | hostNoSuffix ]]
          </span>
          <span ng-if="!planModel.hasSource() && planModel.creatorIsUser()">
            Created by: [[planModel.tripPlanData['creator'] | emailPrefix ]]
          </span>
        </div>
      </div>
      <div class="controls dropdown" tc-lock-after-scroll scroll-parent="#entity-container"
        class-when-fixed="fixed" recompute-spread-on="planModel.tripPlanName()">
        <a class="dropdown-toggle" href="javascript:void(0)">
          Organize <span class="caret"></span>
        </a>
        <ul class="dropdown-menu organize-dropdown" ng-controller="OrganizeMenuCtrl">
          Sort
          <li>
            <a ng-click="groupByCategory()" href="javascript:void(0)">
              by Type
              <span ng-if="pageStateModel.isGroupByCategory()" class="glyphicon glyphicon-ok"></span>
            </a>
          </li>
          <li>
            <a ng-click="groupByDay()" href="javascript:void(0)">
              by Day
              <span ng-if="pageStateModel.isGroupByDay()" class="glyphicon glyphicon-ok"></span>
            </a>
          </li>
          <hr class="dropdown-separator"/>
          Filter
          <li ng-click="suppress($event)">
            <a ng-click="typesExpanded = !typesExpanded" href="javascript:void(0)">
              by Type
              <span class="glyphicon"
                ng-class="{'glyphicon-collapse-down': !typesExpanded, 'glyphicon-collapse-up': typesExpanded}">
              </span>
            </a>
            <ul ng-show="typesExpanded">
              <li ng-repeat="category in categories">
                <a ng-click="filterModel.toggleCategory(category); broadcastFilters()" href="javascript:void(0)">
                  [[category['display_name'] ]]
                  <span ng-show="filterModel.isCategorySelected(category)" class="glyphicon glyphicon-ok"></span>
                </a>
              </li>
            </ul>
          </li>
          <li ng-click="suppress($event)">
            <a ng-click="daysExpanded = !daysExpanded" href="javascript:void(0)">
              by Day
              <span class="glyphicon"
                ng-class="{'glyphicon-collapse-down': !daysExpanded, 'glyphicon-collapse-up': daysExpanded}">
              </span>
            </a>
            <ul ng-show="daysExpanded">
              <li ng-repeat="dayNumber in dayNumbers">
                <a ng-click="filterModel.toggleDay(dayNumber); broadcastFilters()" href="javascript:void(0)">
                  Day [[dayNumber]]
                  <span ng-show="filterModel.isDaySelected(dayNumber)" class="glyphicon glyphicon-ok"></span>
                </a>
              </li>
            </ul>
          </li>
        </ul>
        <div class="reset-control">
          <a ng-click="resetMapState()" href="javascript:void(0)">
            <span class="glyphicon glyphicon-screenshot"></span>
          </a>
        </div>
      </div>
    </div>
  </script>

  {% if allow_editing and not plan.location_bounds %}
  <script type="text/ng-template" id="start-new-trip-modal-template">
    <div class="start-new-trip-modal">
      <div tc-start-new-trip-input on-select-place="selectTripLocation($tripPlanDetails)">
      </div>
    </div>
  </script>
  {% endif %}

  {% if allow_editing %}
  <script type="text/ng-template" id="gmaps-importer-template">
    <div class="gmaps-importer-modal" ng-controller="GmapsImporterCtrl">
      <h3>Import a Google custom map</h3>
      <div ng-show="!pendingTripPlan && !newTripPlan">
        <div class="paste-prompt-text">
          Paste a Google Maps Engine or My Maps url
        </div>
        <input type="text" class="form-control" placeholder="Paste a url"
          ng-model="url" ng-paste="urlPasted()" ng-disabled="importing"
          tc-focus-on="ready"/>
        <div ng-show="importing" class="search-spinner">
          <img src="/static/img/spinner-small.gif"/>
        </div>
        <div ng-show="urlInvalid" class="text-danger">
          That's not a vaid Google custom maps url.
        </div>
      </div>
      <div ng-if="saving" class="save-spinner">
        <img src="/static/img/spinner2.gif"/>
      </div>
      <div ng-show="pendingTripPlan && !newTripPlan && !saving">
        <div class="import-success-text">
          Successfully imported [[pendingTripPlan['entities'].length ]] places
          from the map
          <span class="map-name">[[pendingTripPlan['name'] ]]</span>
        </div>
        <form class="form-inline" role="form">
          <input type="radio" class="form-control" value="new" ng-model="importAction" id="new-action"/>
          <label for="new-action">
            Create a new trip plan
          </label>
          <br/>
          <input type="radio" class="form-control" value="import" ng-model="importAction" id="import-action"/>
          <label for="import-action">
            Add all [[pendingTripPlan['entities'].length ]] places to the current trip plan (<span class="map-name">[[currentTripPlanName]]</span>)
          </label>
        </form>
        <div class="buttons">
          <button class="btn btn-primary" ng-click="save()">
            Save
          </button>
          <button class="btn" ng-click="$close()">
            Cancel
          </button>
        </div>
      </div>
      <div ng-show="newTripPlan">
        <div class="import-success-text" ng-show="importAction == 'new'">
          Successfully created the new trip plan
          <a ng-href="/trip_plan/[[newTripPlan['trip_plan_id'] ]]">
            [[newTripPlan['name'] ]]
          </a>
        </div>
        <div class="buttons">
          <button class="btn" ng-click="$close()">
            Close
          </button>
        </div>
      </div>
    </div>
  </script>
  {% endif %}

  {% if allow_editing %}
  <script type="text/ng-template" id="add-place-panel-template">
    <div class="add-place-panel" ng-controller="AddPlacePanelCtrl">
      <div ng-include="'add-place-panel-header-template'">
      </div>
      <div class="panel-body">
        <div ng-if="pageStateModel.midPanelMode == MidPanelMode.SEARCH_PLACES"
          ng-include="'search-panel-template'"
          class="full-width full-height">
        </div>
        <div ng-if="pageStateModel.midPanelMode == MidPanelMode.WEB_SEARCH_PLACES"
          ng-include="'web-search-panel-template'"
          class="full-width full-height">
        </div>
        <div ng-if="pageStateModel.midPanelMode == MidPanelMode.TRAVEL_GUIDES"
          ng-include="'travel-guides-panel-template'"
          class="full-width full-height">
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="add-place-panel-header-template">
    <div class="header">
      Add Places
      <span class="glyphicon glyphicon-chevron-right breadcrumb-separator"></span>
      <span class="header-mode-control dropdown">
        <span class="dropdown-toggle mode-dropdown-control">
          [[pageStateModel.midPanelModeName]]
          <span class="caret"></span>
        </span>
        <div tc-include-and-replace="add-place-mode-dropdown-template">
        </div>
      </span>
      <div class="close-control">
        <a ng-click="closeMidPanel()" href="javascript:void(0)" class="white-link">
          <span class="glyphicon glyphicon-remove-circle"></span>
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="search-panel-template">
    <div class="search-panel" ng-controller="SearchPanelCtrl"
      tc-scroll-to-selector scroll-on-changes-to="searchResultState.selectedIndex"
      scroll-dest-selector=".one-entity-search-result[tc-entity-result-id='[[searchResultState.selectedIndex]]']">
      <span class="glyphicon glyphicon-search"></span>
        Search for place names, addresses, or categories to add to your trip
      <div class="search-box-container">
        <input type="text" class="form-control"
          placeholder="e.g. 'Eiffel Tower', '123 Main St', or 'Cafes'"
          tc-google-place-autocomplete search-bounds-json="planModel.tripPlanData['location_bounds']"
          tc-focus-on="pageStateModel.midPanelMode"
          on-place-change="googlePlaceSelected($newPlace)"
          ng-model="queryState.rawQuery"
          ng-disabled="loadingData"/>
        <div ng-show="loadingData" class="search-spinner">
          <img src="/static/img/spinner-small.gif"/>
        </div>
      </div>
      <div ng-include="'results-details-panel-template'">
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="results-details-panel-template">
    <div class="results-details-panel">
      <div ng-show="searchComplete && searchResults && searchResults.length">
        <h4>Results from Google Maps</h4>
      </div>
      <div ng-repeat="result in searchResultState.results"
        tc-entity-search-result index="$index" entity-data="result"
        search-result-state="searchResultState">
      </div>
      <div ng-show="searchComplete && (!searchResults || !searchResults.length)">
        <h4>No places found</h4>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="one-entity-search-result-template">
    <div class="one-entity-search-result" tc-entity-result-id="[[index]]"
      ng-controller="EntitySearchResultCtrl"
      ng-mouseenter="highlightResult()">
      <hr class="entity-separator" ng-show="index > 0"/>
      <div class="header-bar">
        <span class="result-letter-icon" tc-search-result-icon
          precise="ed['address_precision'] == 'Precise'" result-letter="resultLetter()">
        </span>
        <span class="name">[[ed['name'] ]]</span>
        <div class="controls">
          <span ng-show="!searchResultState.savedResultIndices[index]">
            <a ng-click="saveResult()" href="javascript:void(0)" class="color-link">
              <span class="glyphicon glyphicon-plus"></span>
              Add to trip
            </a>
          </span>
          <span class="save-confirmation" ng-show="searchResultState.savedResultIndices[index]">
            saved
          </span>
        </div>
      </div>
      <div ng-if="ed['photo_urls'] && ed['photo_urls'].length" class="photo-carousel">
        <span class="vertical-spacer"></span><!--
        --><span tc-image-carousel urls="ed['photo_urls']" class="carousel-content">
        </span>
      </div>
       <div class="metadata">
        <div class="address">
          [[ed['address'] ]]
        </div>
        <div class="source-info" ng-show="ed['source_url']">
          <a ng-href="[[ed['source_url'] ]]" target="_blank">
            From <span class="source-text">[[ed['source_url'] | hostname ]]</span>
          </a>
        </div>
      </div>
      <div class="description"><span ng-bind-html="ed['description'] | linky:'_blank'"></span></div>
      <tc-search-result-marker ng-if="!searchResultState.savedResultIndices[index]"
        marker="markerState.marker" position="position" map="map"
        precise="ed['address_precision'] == 'Precise'" result-letter="resultLetter()"
        selected="isSelected()"
        on-click="markerClicked($event)">
      </tc-search-result-marker>
    </div>
  </script>

  <script type="text/ng-template" id="web-search-panel-template">
    <div class="web-search-panel" ng-controller="WebSearchPanelCtrl"
      tc-scroll-to-selector scroll-on-changes-to="searchResultState.selectedIndex"
      scroll-dest-selector=".one-entity-search-result[tc-entity-result-id='[[searchResultState.selectedIndex]]']">
      <div>
        Not sure where to go? Browse places rated highly by users and writers on trop travel websites.
      </div>
      <div class="sample-site-selector-row">
        Browse
        <span class="inline-dropdown-parent dropdown">
          <button class="btn btn-default dropdown-toggle">
            <img ng-src="[[selectedSite['icon_url'] ]]" class="site-icon"/>
            [[selectedSite['display_name'] ]]
          </button>
          <ul class="dropdown-menu">
            <li ng-repeat="site in sampleSites">
              <a ng-click="selectSite(site)" href="javascript:void(0)">
                <img ng-src="[[site['icon_url'] ]]" class="site-icon"/>
                [[site['display_name'] ]]
              </a>
            </li>
          </ul>
        </span>
        &nbsp;&nbsp;for&nbsp;&nbsp;
        <span class="inline-dropdown-parent" dropdown is-open="queryDropdownState.isopen">
          <button class="btn btn-default dropdown-toggle" ng-disabled="!querySelectEnabled()">
            [[selectedQuery]]
          </button>
          <ul class="dropdown-menu">
            <li ng-repeat="query in selectedSite['sample_queries']">
              <a ng-click="selectQuery(query)" href="javascript:void(0)">
                [[query]]
              </a>
            </li>
            <li ng-click="$event.stopPropagation()"
              ng-if="selectedSite['custom_queries_allowed']">
              <a ng-click="openCustomQuery()"
                ng-show="!customQueryState.active"
                href="javascript:void(0)">
                <span class="custom-search-link" >
                  custom search
                </span>
              </a>
              <span ng-show="customQueryState.active" class="custom-query-row">
                <form ng-submit="selectCustomQuery()">
                  <input type="text" class="form-control custom-query-input" ng-model="customQueryState.input"
                  tc-focus-on="customQueryState.focus"/>
                  <button class="btn ok-button">
                    ok
                  </button>
                </form>
              </span>
            </li>
          </ul>
        </span>
        <button ng-click="submitSearch()" class="btn btn-primary">
          Go
        </button>
      </div>
      <div ng-show="searching" class="search-spinner">
        <img ng-src="/static/img/spinner-small.gif"/>
      </div>
      <div class="search-results" ng-if="searchComplete && searchResults && searchResults.length">
        <h4>Results from [[selectedSite['display_name'] ]]</h4>
        <div ng-repeat="result in searchResults"
          tc-entity-search-result index="$index" entity-data="result"
          search-result-state="searchResultState">
        </div>
      </div>
      <div ng-if="searchComplete && (!searchResults || !searchResults.length)">
        <h4>No places found</h4>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="travel-guides-panel-template">
    <div class="travel-guides-panel" ng-controller="TravelGuidesPanelCtrl">
      <div>
        See full itineraries from well-known sources and from travelers like you.
      </div>
      <div class="guides-listings" ng-show="!selectedTripPlan">
        <h4>Popular travel guides for [[locationName]]:</h4>
        <div ng-show="loading">
          Loading... <img ng-src="/static/img/spinner-small.gif"/>
        </div>
        <div ng-show="!loading && (!tripPlans || !tripPlans.length)">
          <h4>There are no featured trip plans for this area</h4>
        </div>
        <div ng-show="tripPlans && tripPlans.length">
          <div ng-repeat="tripPlan in tripPlans"
            class="featured-trip-plan-header featured-trip-plan-preview"
            ng-style="{'background-image': tripPlan['cover_image_url']}"
            ng-click="selectTripPlan(tripPlan)">
            <div class="text">
              <div class="name">[[tripPlan['name'] ]]</div>
              <div class="creator">[[tripPlan['creator'] ]]</div>
            </div>
          </div>
        </div>
      </div>
      <div class="one-guide-panel" ng-show="selectedTripPlan">
        <div>
          <a ng-click="backToListings()" href="javascript:void(0)">
            &laquo; back to guides
          </a>
        </div>
        <div class="featured-trip-plan-header"
          ng-style="{'background-image': selectedTripPlan['cover_image_url']}">
          <div class="text">
            <div class="name">[[selectedTripPlan['name'] ]]</div>
            <div class="creator">[[selectedTripPlan['creator'] ]]</div>
          </div>
        </div>
        <div ng-repeat="entity in selectedTripPlan['entities']"
          tc-entity-search-result index="$index" entity-data="entity"
          search-result-state="searchResultState">
        </div>
      </div>
    </div>
  </script>
  {% endif %}

  {% if allow_editing %}
  <script type="text/ng-template" id="trip-plan-settings-editor-template">
    <div class="trip-plan-settings-editor" ng-controller="TripPlanSettingsEditorCtrl">
      <div class="header">
        <div class="title">Trip Plan Settings</div>
        <div class="button-panel">
          <button class="btn btn-primary" ng-click="saveSettings()">
            Save
          </button>
          <button class="btn btn-default" ng-click="$close()">
            Cancel
          </button>
        </div>
      </div>
      <div class="editor-body container-fluid">
        <div class="row">
          <div class="col-sm-6">
            <h4>Name</h4>
            <input type="text" class="form-control" ng-model="tpd['name']"/>
            <h4>Description</h4>
            <textarea class="form-control description-input" ng-model="tpd['description']"></textarea>
          </div>
          <div class="col-sm-6">
            <h4>Cover Image</h4>
            <div class="cover-img-container" ng-if="tpd['cover_image_url'] && !editingImage">
              <img ng-src="[[tpd['cover_image_url'] ]]"/>
              <div class="img-control top-control">
                <a ng-click="changeImage()" href="javascript:void(0)">
                  Change image
                  <span class="glyphicon glyphicon-picture"></span>
                </a>
              </div>
              <div class="img-control bottom-control">
                <a ng-click="removeImage()" href="javascript:void(0)">
                  Remove image
                  <span class="glyphicon glyphicon-trash"></span>
                </a>
              </div>
            </div>
            <div class="cover-img-editor" ng-if="editingImage">
              <textarea class="cover-img-drop-target" placeholder="Drag and drop an image or paste an image url"
                ng-model="coverImgUrlInput.text" ng-change="coverImgUrlChanged()" ng-paste="coverImgUrlPasted()"
                tc-dragenter="coverImgDragenter()" tc-dragover="$event.preventDefault()" tc-drop="coverImgUrlDropped($event)"
                ng-class="{'dragactive': coverImgDragActive}">
              </textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
  </script>
  {% endif %}

  <script type="text/ng-template" id="bulk-clip-modal-template">
    <div class="bulk-clip-modal" ng-controller="BulkClipCtrl">
      <h2>Clip Places</h2>
      <div>
        Select one or more places to clip to one of your trips
      </div>
      <div class="container-fluid full-height clipper-body">
        <div class="row full-height">
          <div class="col-sm-6 entity-list">
            <div class="select-controls">
              Select:
              <a ng-click="selectAll()" href="javascript:void(0)">All</a>
              <a ng-click="selectNone()" href="javsacript:void(0)">None</a>
            </div>
            <div ng-repeat="entity in allEntities">
              <tc-entity-listing entity-data="entity" on-select="entity.selected = !entity.selected"
                is-selected="entity.selected">
              </tc-entity-listing>
            </div>
          </div>
          <div class="col-sm-6">
            <div class="save-panel" ng-show="!(saving || saved)">
              <div class="save-summary">
                <span ng-show="selectedEntities().length == 0">
                  Select a place to save to
                </span>
                <span ng-show="selectedEntities().length == 1">
                  Save 1 place to
                </span>
                <span ng-show="selectedEntities().length > 1">
                  Save [[selectedEntities().length]] places to
                </span>
              </div>
              <div tc-trip-plan-select-dropdown select-trip-plan-to="selectionState.selectedTripPlan">
              </div>
              <div class="button-panel" ng-show="!selectionState.selectedTripPlan.createNew">
                <button ng-click="save()" class="btn btn-primary" ng-disabled="!selectedEntities().length">
                  Save
                </button>
              </div>
            </div>
            <div class="confirmation-panel" ng-show="saving || saved">
              <div class="saving-msg" ng-show="saving">
                Saving...
                <br/>
                <img src="/static/img/spinner2.gif"/>
              </div>
              <div class="confirmation" ng-show="saved">
                Successfully saved
                <span ng-show="selectedEntities().length == 1">
                  1 place
                </span>
                <span ng-show="selectedEntities().length > 1">
                  [[selectedEntities().length]] places
                </span>
                to
                <a ng-href="/trip_plan/[[selectionState.selectedTripPlan['trip_plan_id'] ]]"
                  target="_blank">
                  [[selectionState.selectedTripPlan['name'] ]]
                </a>
                <div class="close-button">
                  <button class="btn btn-default" ng-click="$close()">
                    Close
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </script>

  {% if needs_tutorial %}
  <script type="text/ng-template" id="tutorial-left-panel-template">
    <div class="tutorial-left-panel">
      <div ng-repeat="ignored in [1, 2, 3]" class="entity-placeholder">
        <span class="img-placeholder">
        </span>
        <span class="details-placeholder">
        </span>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="tutorial-map-panel-template">
    <div class="tutorial-map-panel" ng-controller="TutorialCtrl">
      <div class="backdrop">
      </div>
      <div class="content">
        <div class="content-scroll-container"
          ng-class="{'needs-min-height': pageStateModel.tutorialState != TutorialState.START}">
          <div ng-if="pageStateModel.tutorialState == TutorialState.START">
            <div class="awesome">Awesome! You're planning your first trip.</div>
            <div class="where-are-you-going">Where do you want to go?</div>
            <div class="just-exploring">Just exploring? Try these popular locations - Paris, London, or Sydney.</div>
            <div tc-start-new-trip-input
              on-select-place="placeSelected($tripPlanDetails)"
              hide-prompt="true" placeholder="''">
            </div>
          </div>
          <div ng-if="pageStateModel.tutorialState == TutorialState.ADD_INITIAL_PLACES
            || pageStateModel.tutorialState == TutorialState.ADD_MORE_PLACES">
            <div class="text-lg">
              Great! Let's add a few places to your trip.
            </div>
            <div class="directions">
              TravelClipper can organize and map places from other websites. Try searching for restaurants, lodging, and attractions from these sample sites.
            </div>
            <div class="site-select">
              <span class="site-select-inner dropdown">
                <button class="btn btn-default dropdown-toggle selected-site-button">
                  [[selectedSiteState.site['prompt_text'] ]]
                  <img class="site-logo-img" ng-src="[[selectedSiteState.site['icon_url'] ]]"/>
                  <span class="caret"></span>
                </button>
                <ul class="dropdown-menu site-select-dropdown">
                  <li ng-repeat="site in sampleSites">
                    <a ng-click="selectedSiteState.site = site" href="javascript:void(0)">
                      [[site['prompt_text'] ]]
                      <img class="site-logo-img" ng-src="[[site['icon_url'] ]]"/>
                      <span class="glyphicon glyphicon-ok" ng-show="selectedSiteState.site == site"></span>
                    </a>
                  </li>
                </ul>
                <button ng-click="searchSite()" class="btn btn-primary">
                  Go
                </button>
              </span>
            </div>
            <div class="searching-msg" ng-show="searching">
              <img ng-src="[[selectedSiteState.site['icon_url'] ]]" class="site-logo-img"/>
              Searching [[selectedSiteState.site['display_name'] ]] for results in
              [[tripPlanModel.tripPlanData['location_name'] ]]
              <img ng-src="/static/img/spinner2.gif"/>
            </div>
            <div class="search-results" ng-if="searchResults && searchResults.length">
              <div class="directions search-add-prompt">
                Click on places to add them to your trip. You can easily change your mind later.
              </div>
              <div>
                <span ng-repeat="entity in searchResults" class="search-result">
                  <tc-entity-listing entity-data="entity" on-select="selectResult($entityData)">
                  </tc-entity-listing>
                  <span ng-show="entity.saving" class="saving">saving...</span>
                  <span ng-show="entity.saved" class="saved">saved</span>
                </span>
              </div>
              <div class="button-panel">
                <button class="btn btn-primary" ng-click="doneAddingPlaces()"
                  ng-disabled="!savedEntities().length">
                  Done adding places
                </button>
              </div>
            </div>
            <div ng-if="searchComplete && (!searchResults || !searchResults.length)">
              <div class="no-results-msg">
                Uh oh. No results found.
              </div>
              <div class="no-results-expl">
                This site doesn't have places for where you are going. Please try searching another site.
              </div>
            </div>
          </div>
          <div ng-if="pageStateModel.tutorialState == TutorialState.ENTER_EMAIL">
            <div class="text-lg">
              Your trip is starting to look good!
            </div>
            <div>
              Now might be a good time to save this trip.  Enter you email so that you can
              easily come back to this trip any time you want.
            </div>
            <form class="email-form form-inline" role="form" ng-submit="submitEmail()">
              <input type="text" class="form-control email-input"
                ng-model="emailState.email" tc-focus-on="pageStateModel.tutorialState"
                placeholder="Enter your email address"/>
              <button class="btn btn-primary" ng-disabled="!emailState.email">
                Submit
              </button>
            </form>
            <div class="email-skip-link">
              I'll sign up later.
              <a ng-click="skipEmail()" href="javascript:void">
                Skip this step.
              </a>
            </div>
          </div>
          <div ng-if="pageStateModel.tutorialState == TutorialState.CONCLUSION">
            <div class="text-md last-thing">
              Last thing and you're done!
            </div>
            <div class="text-lg">
              There are 3 ways you can add places to your trip.
            </div>
            <div class="text-with-image-section">
              <div class="text-section">
                <div class="text-md">
                  Add places by searching
                </div>
                <div>
                  Click the 'Add Places' button to search Google Places or browse recommendations from popular travel websites.
                </div>
              </div>
              <div class="image-section">
                <button class="btn add-place-fake-button" disabled="true">
                  Add Place
                </button>
              </div>
            </div>
            <div class="text-with-image-section">
              <div class="text-section">
                <div class="text-md">
                  Add places by clipping from other trips
                </div>
                <div>
                  Browse trips from friends and travel experts.  When you see a place that looks interesting, look for the Clip button to instantly add it to your trip.
                </div>
              </div>
              <div class="image-section">
                <span class="glyphicon glyphicon-paperclip clip-icon"></span>
              </div>
            </div>
            <div class="text-section">
              <div class="text-md">
                Add places while browsing the web
              </div>
              <div>
                While exploring other websites, use TravelClipper to import places of interest with a single click.
                <a ng-click="showClipperDetails = !showClipperDetails" href="javascript:void(0)" class="color-link">
                  <span ng-show="!showClipperDetails">
                    Learn&nbsp;more&nbsp;&raquo;
                  </span>
                  <span ng-show="showClipperDetails">
                    Learn&nbsp;more&nbsp;&laquo;
                  </span>
                </a>
              </div>
              <div class="expanded-details" ng-show="showClipperDetails">
                <div>
                  The TravelClipper bookmark lets you add places while browsing other websites.  It can pull place names, locations, images, and other information from dozens of travel websites and blogs with a single click.  For all other websites it allows you to quickly pull together the information and images you care about.
                </div>
                <div class="bookmarklet">
                  <a href="javascript:(function(){c=document.createElement('script');c.type='text/javascript';c.src='{{bookmarklet_url}}'+'?'+Math.floor(Math.random()*99999999);document.body.appendChild(c);})();"
                  onclick="event.stopPropagation(); event.preventDefault()">
                    <span class="bookmarklet-link">
                      <span class="glyphicon glyphicon-paperclip"></span> Travel Clipper
                    </span>
                  </a>
                  <span class="glyphicon glyphicon-arrow-left"></span>
                  Drag me to your bookmarks bar
                </div>
                <div class="sample-sites">
                  Sample supported sites:
                  <a ng-repeat="site in sampleSupportedSites" target="_blank"
                    ng-href="[[site.url]]" tooltip="[[site.name]]">
                    <img ng-src="[[site.iconUrl]]" class="site-logo-img"/>
                  </a>
                </div>
                <div class="bookmarklet-help-text">
                  Don't see your bookmarks bar? Press Cmd+Shift+B (Mac) or Ctrl+Shift+B (PC)
                </div>
              </div>
            </div>
            <div class="button-panel">
              <button class="btn btn-primary" ng-click="closeTutorial()">
                Finish
              </button>
            </div>
          </div>
          <div class="skip-link" ng-show="pageStateModel.tutorialState != TutorialState.START && pageStateModel.tutorialState != TutorialState.CONCLUSION">
            <a ng-click="closeTutorial()" href="javascript:void(0)">
              Skip tutorial
            </a>
          </div>
        </div>
      </div>
    </div>
  </script>
  {% endif %}

  <script type="text/ng-template" id="compass-icon-template">
    <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Layer_1" x="0px" y="0px" width="100.5px" height="93.846px" viewBox="0 0 100.5 93.846" enable-background="new 0 0 100.5 93.846" xml:space="preserve">
      <g id="BLOCK_x5F_RECORD">
        <g id="ARC_3_">
          <g id="XMLID_1_">
            <g>
              <path d="M63.67,39.313c2.28,3.92,2.28,10.29,0,14.209L49.75,80.793L35.83,53.523c-2.28-3.92-2.28-10.29,0-14.209l13.92-27.27      L63.67,39.313z M56,46.423c0-3.45-2.8-6.25-6.25-6.25s-6.25,2.8-6.25,6.25s2.8,6.25,6.25,6.25S56,49.873,56,46.423z"/>
              <path d="M49.75-3.577c27.61,0,50,22.38,50,50c0,27.61-22.39,50-50,50c-27.62,0-50-22.39-50-50      C-0.25,18.803,22.13-3.577,49.75-3.577z M93.5,46.423c0-24.16-19.59-43.75-43.75-43.75S6,22.263,6,46.423      s19.59,43.75,43.75,43.75S93.5,70.583,93.5,46.423z"/>
            </g>
            <g>
            </g>
          </g>
        </g>
      </g>
    </svg>
  </script>

  {% include 'widgets.html' %}
  {% include 'map_markers.html' %}

  <script>
    initApp(
      {{plan.to_json_str()|safe}},
      {{entities_json|safe}},
      {{notes_json|safe}},
      {{all_trip_plans_json|safe}},
      {{account_info.to_json_str()|safe}},
      {{all_datatype_values.to_json_str()|safe}},
      {{allow_editing|jsbool}},
      {{sample_sites_json|safe}},
      {{initial_state.to_json_str()|safe}});
  </script>
</body>
</html>
