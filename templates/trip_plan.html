<!doctype html>
<html>
<head>
  <title>{{plan.name}}</title>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="//maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>
  <script src="//cdn.jsdelivr.net/underscorejs/1.6.0/underscore-min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular-sanitize.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular-animate.min.js"></script>
  <script src="/static/js/ui-bootstrap-tpls-0.11.0.min.js"></script>
  <script src="/static/js/services.js"></script>
  <script src="/static/js/script.js"></script>
  <link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Raleway:300">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="shortcut icon" href="/static/img/globe.png">
  {% include 'analytics.html' %}
</head>
<body ng-controller="RootCtrl">
  <tc-nav account-info="accountInfo" active-trip-plan="activeTripPlanState.tripPlan"
    num-entities="activeTripPlanState.numEntities" all-trip-plans="allTripPlans"
    shopping-cart-mode="!{{allow_editing | jsbool}}">
  </tc-nav>
  <div tc-include-and-replace="flashed-messages-template"></div>

  <div id="summary-panel" ng-if="{{allow_editing | jsbool}}">
    <div ng-include="'trip-plan-header-template'">
    </div>

    <div id="entity-container"
      ng-class="{'expanded': pageStateModel.summaryPanelExpanded}"
      tc-scroll-to-selector scroll-on-changes-to="pageStateModel.selectedEntity"
      skip-scroll-when-in-view="true"
      scroll-dest-selector=".one-entity-summary[tc-entity-id='[[pageStateModel.selectedEntity['entity_id'] ]]'] .scroll-anchor">
      <div ng-repeat="entity in planModel.entities()">
        <div ng-include="'one-entity-summary-template'">
        </div>
      </div>

      <div ng-if="!planModel.hasEntities()" class="no-entities-message">
        <p>
          A summary of your places will show up here.
        </p>
        <p>
          Drag and drop places to order them.
        </p>
      </div>
    </div>
  </div>

  <div id="info-panel" ng-show="!pageStateModel.inNewTripPlanModal"
    ng-class="{'closed': !pageStateModel.infoPanelExpanded}">
    {% if allow_editing %}
    <div ng-include="'info-panel-nav-template'">
    </div>
    {% endif %}
    <div class="info-panel-content {% if allow_editing %}with-nav{% endif %}">
      <div ng-include="'details-panel-template'"
        class="full-width full-height"
        ng-show="pageStateModel.infoPanelMode == InfoPanelMode.DETAILS">
      </div>
      {% if allow_editing %}
      <div ng-include="'guides-panel-template'"
        class="full-width full-height"
        ng-if="pageStateModel.infoPanelMode == InfoPanelMode.GUIDES">
      </div>
      <div ng-include="'add-your-own-panel-template'"
        class="full-width full-height"
        ng-if="pageStateModel.infoPanelMode == InfoPanelMode.ADD_YOUR_OWN">
      </div>
      <div ng-include="'export-panel-template'"
        class="full-width full-height"
        ng-if="pageStateModel.infoPanelMode == InfoPanelMode.EXPORT">
      </div>
      <div ng-include="'sharing-panel-template'"
        class="full-width full-height"
        ng-if="pageStateModel.infoPanelMode == InfoPanelMode.SHARING">
      </div>
      <div ng-include="'settings-panel-template'"
        class="full-width full-height"
        ng-if="pageStateModel.infoPanelMode == InfoPanelMode.SETTINGS">
      </div>
      {% endif %}
    </div>
  </div>

  <div id="map-panel" tc-animate-on-bool="!pageStateModel.infoPanelExpanded"
    tc-transitionend="updateMap()"
    class-when-true="info-panel-closed" after-complete="updateMap()"
    ng-class="{'full-screen': pageStateModel.isMapFullScreen()}">
    <div id="map-container">
      <div id="map">
      </div>
    </div>
    <div ng-include="'control-buttons-template'">
    </div>
  </div>

  {% if not allow_editing %}
  <tc-after-new-trip-plan-panel
    ng-if="pageStateModel.showAfterNewTripPlanPanel"
    align-connector-to="#place-count"
    on-close="pageStateModel.showAfterNewTripPlanPanel = false">
  </tc-after-new-trip-plan-panel>
  {% endif %}

  <script type="text/ng-template" id="info-panel-nav-template">
    <div class="info-panel-nav">
      <div class="info-panel-nav-main-controls">
        <span ng-show="!pageStateModel.infoPanelShowExtendedNavItems">
          <span class="info-nav-item"
            ng-class="{'selected': pageStateModel.infoPanelMode == InfoPanelMode.DETAILS}">
            <a class="black-link" ng-click="goToInfoPanel(InfoPanelMode.DETAILS)" href="javascript:void(0)">
              <span class="info-nav-item-icon"><span tc-icon="trip-plan"></span></span> View Details
            </a>
          </span>
          <span class="info-nav-item"
            ng-class="{'selected': pageStateModel.infoPanelMode == InfoPanelMode.GUIDES}">
            <a class="black-link" ng-click="goToInfoPanel(InfoPanelMode.GUIDES)" href="javascript:void(0)">
              <span class="glyphicon glyphicon-book info-nav-item-icon"></span> Browse Guides
            </a>
          </span>
          <span class="info-nav-item"
            ng-class="{'selected': pageStateModel.infoPanelMode == InfoPanelMode.ADD_YOUR_OWN}">
            <a class="black-link" ng-click="goToInfoPanel(InfoPanelMode.ADD_YOUR_OWN)"  href="javascript:void(0)">
              <span class="glyphicon glyphicon-plus info-nav-item-icon"></span> Add Your Own
            </a>
          </span>
          <span class="info-nav-item"
            ng-class="{'selected': pageStateModel.infoPanelMode == InfoPanelMode.EXPORT}">
            <a class="black-link" ng-click="goToInfoPanel(InfoPanelMode.EXPORT)" href="javascript:void(0)">
              <span class="glyphicon glyphicon-share info-nav-item-icon"></span> Export
            </a>
          </span>
        </span>
        <span ng-show="pageStateModel.infoPanelShowExtendedNavItems">
          <span class="info-nav-item"
            ng-class="{'selected': pageStateModel.infoPanelMode == InfoPanelMode.SHARING}">
            <a class="black-link" ng-click="goToInfoPanel(InfoPanelMode.SHARING)" href="javascript:void(0)">
              <span class="glyphicon glyphicon-share-alt info-nav-item-icon"></span> Share
            </a>
          </span>
          <span class="info-nav-item"
            ng-class="{'selected': pageStateModel.infoPanelMode == InfoPanelMode.SETTINGS}">
            <a class="black-link" ng-click="goToInfoPanel(InfoPanelMode.SETTINGS)" href="javascript:void(0)">
              <span class="glyphicon glyphicon-cog info-nav-item-icon"></span> Settings
            </a>
          </span>
        </span>
      </div>
      <div class="info-panel-nav-more-items">
        <a class="black-link" ng-click="pageStateModel.infoPanelShowExtendedNavItems = !pageStateModel.infoPanelShowExtendedNavItems"
        href="javascript:void(0)">
          &hellip;
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="control-buttons-template">
    <div id="map-buttons" ng-class="{'info-panel-open': pageStateModel.infoPanelExpanded}">
      <button class="btn btn-default btn-slide-info-panel" ng-click="openDetailsPanel()"
        ng-show="!pageStateModel.infoPanelExpanded">
        <span class="glyphicon glyphicon-plus"></span>
      </button>
      <button class="btn btn-default btn-slide-info-panel" ng-click="closeInfoPanel()"
        ng-show="pageStateModel.infoPanelExpanded">
        <span class="glyphicon glyphicon-minus"></span>
      </button>
    </div>
  </script>

  <script type="text/ng-template" id="infowindow-template">
    <div class="infowindow" ng-controller="InfowindowCtrl">
      <div class="infowindow-internal">
        <div class="info-section">
          <span class="name">
            [[ed['name'] ]]
          </span>
          <span class="metadata">
            <span ng-show="ed['address_precision'] == 'Imprecise'"
              class="glyphicon glyphicon-exclamation-sign"
              tooltip="Location is approximate">
            </span>
            <span tc-icon="comment" ng-show="em.hasComments()"
              tooltip="[[ed['comments'].length ]] comments">
            </span>
            {% if allow_editing %}
            <a ng-click="saveStarState(true)" ng-show="!ed['starred']" class="white-link"
              href="javascript:void(0)" tooltip="Favorite">
              <span class="glyphicon glyphicon-star-empty"></span>
            </a>
            <a ng-click="saveStarState(false)" ng-show="ed['starred']" href="javascript:void(0)" tooltip="Un-favorite">
              <span class="glyphicon glyphicon-star favorite-star"></span>
            </a>
            {% else %}
            <span ng-show="ed['starred']" class="glyphicon glyphicon-star favorite-star">
            </span>
            {% endif %}
          </span>
        </div>
        <div class="comments-section" ng-if="ed['comments'] && ed['comments'].length">
          <div ng-repeat="comment in ed['comments']" class="one-comment">
            <div>
              <span class="comment-sidebar">
                <span tc-user-icon user="comment['user']">
                </span>
              </span>
              <span class="comment-details">
                <div>
                  <span ng-bind-html="comment['text'] | linky:'_blank'" class="text"></span>
                </div>
                <div class="comment-timestamp">
                  [[comment['last_modified'] | date: 'short']]
                </div>
              </span>
            </div>
          </div>
        </div>
        <div class="workspace-section" ng-if="workspaceActive()">
          <div ng-if="inlineEditMode == InlineEditMode.TAGS" class="inline-tags-editor">
            <label>Enter tags, separated by commas</label>
            <form ng-submit="saveTags()">
              <input type="text" class="form-control" ng-model="tagState.rawInput"
                placeholder="e.g. greek food, day 1, recommended by Bob"
                tc-focus-on="inlineEditMode"/>
            </form>
            <a ng-click="saveTags()" href="javascript:void(0)" class="cta-link">
              Save
            </a>
            <a ng-click="closeTagsEditor()" href="javascript:void(0)" class="black-link">
              Cancel
            </a>
          </div>
          <div ng-if="inlineEditMode == InlineEditMode.COMMENTS" class="inline-comment-editor">
            <div class="author-name">
              <span tc-user-icon user="accountInfo['user']">
              </span>
            </div>
            <textarea class="form-control" placeholder="Add a comment"
              tc-focus-on="inlineEditMode"
              ng-model="newComment['text']">
            </textarea>
            <div>
              <a ng-click="saveNewComment()" href="javascript:void(0)" class="cta-link">Save</a>
              <a ng-click="closeNewComment()" href="javascript:void(0)" class="cancel-link">Cancel</a>
            </div>
          </div>
          <div ng-if="inlineEditMode == InlineEditMode.DIRECTIONS" class="directions-planner">
            Get directions
            <a ng-click="directionsHelper.toggleDirection()" href="javascript:void(0)">
              [[directionsHelper.direction == 'to' ? 'to' : 'from' ]]
            </a>
            <select class="form-control"
              ng-options="e['name'] for e in directionsHelper.entities"
              ng-model="directionsHelper.destination">
              <option value="">Select destination</option>
            </select>
            <button class="btn btn-primary go-button"
              ng-click="directionsHelper.getDirections(ed)"
              ng-disabled="!directionsHelper.destination">
              Go
            </button>
          </div>
        </div>
        <div class="tool-section" ng-include="'map-marker-tools-template'"
          ng-show="!pageStateModel.inAddPlacePanel()">
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="map-marker-tools-template">
    <div class="marker-tools">
      {% if allow_editing %}
      <span ng-show="showPrimaryControls">
        <a ng-click="toggleTagsEdit()" href="javascript:void(0)"
          class="black-link"
          tooltip="Add Tags" tooltip-placement="bottom">
          <span class="glyphicon glyphicon-tag"></span>
        </a>
        <a ng-click="toggleDirectionsEdit()" href="javascript:void(0)"
          tooltip="Get directions" tooltip-placement="bottom">
          <span tc-icon="compass"></span>
        </a>
        <a ng-click="toggleCommentsEdit()" href="javascript:void(0)"
          tooltip="Comment" tooltip-placement="bottom">
          <span tc-icon="comment"></span>
        </a>
      </span>
      <span ng-show="showSecondaryControls">
        <a ng-click="openEditPlaceModal()" href="javascript:void(0)" class="black-link"
          tooltip="Edit" tooltip-placement="bottom">
          <span class="glyphicon glyphicon-pencil"></span>
        </a>
        <a ng-click="deleteEntity()" href="javascript:void(0)" class="black-link"
          tooltip="Delete" tooltip-placement="bottom">
          <span class="glyphicon glyphicon-trash"></span>
        </a>
      </span>
      <span class="control-toggle">
        <a ng-click="toggleControls()" href="javascript:void(0)" class="black-link"
          tooltip="More controls" tooltip-placement="bottom">
          &hellip;
        </a>
      </span>
      {% else %}
      <a ng-show="!isAlreadySaved()" ng-click="clipEntity()"
        class="add-to-trip-cta" href="javascript:void(0)">
        Add to My Trip
      </a>
      <span ng-show="isAlreadySaved()" class="already-saved">
        Saved
      </span>
      <a ng-click="toggleDirectionsEdit()" href="javascript:void(0)"
        class="non-editor-control-icon"
        tooltip="Get directions" tooltip-placement="bottom">
        <span tc-icon="compass"></span>
      </a>
      {% endif %}
    </div>
  </script>

  {% if allow_editing %}
  <script type="text/ng-template" id="results-infowindow-template">
    <div class="infowindow results-infowindow">
      <div class="infowindow-internal">
        <div class="info-section">
          <div class="name">
            [[ed['name'] ]]
          </div>
        </div>
        <div class="tools-section">
          <a ng-click="clipEntity()" href="javascript:void(0)"
            ng-show="!resultAlreadySaved()">
            <span class="glyphicon glyphicon-plus"></span> Add to trip
          </a>
          <div class="save-confirmation" ng-show="resultAlreadySaved()">
            saved
          </div>
        </div>
      </div>
    </div>
  </script>
  {% endif %}

  <script type="text/ng-template" id="day-select-dropdown-template">
    <select class="form-control"
      ng-options="option.createNew ? 'Add a new day' : 'Day ' + option.dayNumber for option in getDaySelectOptions()"
      ng-model="selectedDayState.dayModel"
      ng-change="organizeIntoDay()">
      <option value="" ng-if="!ed['day']">--Add to day--</option>
    </select>
  </script>

  <script type="text/ng-template" id="reclip-confirmation-template">
    <div ng-controller="ReclipConfirmationCtrl" class="reclip-confirmation-modal">
      <div ng-show="!reclipSucceeded">
        <div>Reclip <b>[[ed['name'] ]]</b> to:</div>
        <div tc-trip-plan-select-dropdown select-trip-plan-to="selectionState.selectedTripPlan" class="reclip-confirmation-trip-plan-dropdown"></div>
        <div ng-show="showSaveButtons()">
          <button class="btn btn-primary" ng-click="reclipEntity()">
            Save
          </button>
          <button class="btn" ng-click="dismissReclipConfirmation()">
            Cancel
          </button>
        </div>
      </div>

      <div ng-show="reclipSucceeded">
        <div class="clip-success-checkmark">
          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" width="40px" height="40px" viewBox="0 0 95.453 100" enable-background="new 0 0 95.453 100" xml:space="preserve">
          <g>
            <g>
              <polygon points="94.587,27.48 31.657,86.15 31.217,85.68 18.847,72.41 0.566,52.81 14.106,40.19 32.387,59.79 81.776,13.74"/>
            </g>
          </g>
          </svg>
        </div>
        Successfully clipped <b>[[ed['name'] ]]</b> to
        <a href="/trip_plan/[[selectionState.selectedTripPlan['trip_plan_id'] ]]" target="_blank">
          [[selectionState.selectedTripPlan['name'] ]]
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="edit-place-modal-template">
    <div class="edit-place" ng-controller="EditPlaceCtrl">
      <div class="edit-header">
        <span class="editor-title">Editor</span>
        <select ng-options="e['name'] for e in allEntities track by e['entity_id']"
          ng-model="selectedEntity" ng-change="selectedEntityChanged()">
        </select>
        <div class="button-panel">
          <button class="btn btn-primary" ng-click="saveEntity()">
            Save
          </button>
          <button class="btn btn-default" ng-click="$close()">
            Cancel
          </button>
        </div>
      </div>
      <div class="container-fluid editor-body">
        <div class="row">
          <div class="col-sm-6">
            <input type="text" class="form-control" ng-model="ed['name']" placeholder="Place name"/>
            <textarea class="form-control description-input" ng-model="ed['description']"
              placeholder="Description"></textarea>
            <div class="editable-carousel" ng-if="ed['photo_urls'] && ed['photo_urls'].length">
              <div tc-image-carousel urls="ed['photo_urls']" current-index="selectedPhoto.index">
              </div>
              <div class="photo-top-control">
                <a ng-click="setPhotoAsPrimary()" href="javascript:void(0)">
                  Set as Primary <span class="glyphicon glyphicon-picture"></span>
                </a>
              </div>
              <div class="photo-bottom-control">
                <a ng-click="deletePhoto()" href="javascript:void(0)">
                  Delete Photo <span class="glyphicon glyphicon-trash"></span>
                </a>
              </div>
            </div>
          </div>
          <div class="col-sm-6">
            <input type="text" class="form-control" ng-model="ed['address']" placeholder="Search for an address"
              tc-google-place-autocomplete search-bounds-json="locationBounds"
              location-types="geocode" on-place-change="addressChanged($newPlace)"/>
            <div class="map-container">
              <div tc-google-map class="map" map="mapState.map" map-options="mapOptions" after-creation="setupMap($map)">
              </div>
            </div>
            <tc-entity-marker map="mapState.map" marker="markerState.marker"
              position="markerState.position"
              category-name="ed['category'] && ed['category']['name']"
              icon-template-name="iconTemplateName()"
              precise="ed['address_precision'] == 'Precise'"
              draggable="true" on-drag-end="markerDragged($position)">
            </tc-entity-marker>
            <form class="form-inline precision-and-star-strip" role="form">
              <input type="radio" class="form-control" value="Precise" ng-model="ed['address_precision']" id="precise-radio"/>
              <label for="precise-radio">Exact location</label>
              <input type="radio" class="form-control" value="Imprecise" ng-model="ed['address_precision']" id="imprecise-radio"/>
              <label for="imprecise-radio">Approximate location</label>
              <a ng-click="ed['starred'] = !ed['starred']" href="javascript:void(0)" class="star-control">
                <span class="glyphicon glyphicon-star"
                  ng-class="{'glyphicon-star': ed['starred'], 'glyphicon-star-empty': !ed['starred'], 'favorite-star': ed['starred']}">
                </span>
              </a>
            </form>
            <select class="form-control" ng-model="ed['category']"
              ng-options="c['display_name'] for c in categories track by c['category_id']"
              ng-change="categoryChanged()">
            </select>
            <select class="form-control" ng-model="ed['sub_category']"
              ng-options="s['display_name'] for s in getSubCategories(ed['category']['category_id']) track by s['sub_category_id']">
            </select>
          </div>
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="day-planner-template">
    <div ng-controller="DayPlannerCtrl" class="day-planner-modal">
      <div class="day-planner-header">
        <div class="day-planner-header-text">Plan Itinerary</div>
        <div class="day-planner-persistent-controls">
          <button class="btn btn-cta" ng-click="saveOrderings()">
            Save
          </button>
          <button class="btn" ng-click="$close()">
            Cancel
          </button>
        </div>
      </div>
      <div class="container-fluid day-planner-body">
        <div class="row-fluid">
          <div class="col-md-5 day-planner-left-panel">
            <div class="day-planner-left-panel-drag-area"
              ng-class="{'dragactive': showLeftPanelDragActive(), 'dragover': showLeftPanelDragover()}"
              tc-dragenter="onLeftPanelDragenter($event)"
              tc-dragleave="leftPanelDragover = false"
              tc-dragover="onLeftPanelDragover($event)"
              tc-dragend="onDragend(); leftPanelDragover = false"
              tc-drop="handleLeftPanelDrop($event)"
            >
              <h4 class="day-planner-panel-header">Not Planned By Day</h4>
              <div ng-repeat="item in dpm.unorderedItems" class="day-planner-unsorted-item">
                <tc-draggable-entity item="item" drag-item="dragItem"
                on-dragstart="onDragstart($event, item)" on-dragend="onDragend()">
                </tc-draggable-entity>
              </div>
            </div>
          </div>
          <div class="col-md-7 day-planner-right-panel">
            <div ng-repeat="dayModel in dpm.dayModels">
              <div class="day-planner-one-day" ng-controller="DayPlannerOneDayCtrl"
                ng-class="{'dragover': dayDragover && isValidDayForDrop()}"
                tc-dragenter="onDayDragenter($event)"
                tc-dragleave="dayDragover = false"
                tc-dragover="onDayDragover($event)"
                tc-dragend="onDragend(); dayDragover = false"
                tc-drop="handleDayDrop($event, dayModel); dayDrover = false;"
              >
                <h4 class="day-planner-day-heading">
                  Day [[dayModel.dayNumber]]
                  <span class="day-planner-edit-note-control" ng-show="!editingNote">
                    <a ng-click="openNoteEditor()" href="javascript:void(0)"
                      tooltip="Add a note" tooltip-placement="bottom">
                      <span class="glyphicon glyphicon-pencil"></span>
                    </a>
                  </span>
                </h4>

                <div class="day-planner-one-day-controls dropdown">
                  <a href="javascript:void(0)" class="dropdown-toggle">
                    <span class="glyphicon glyphicon-cog"></span>
                  </a>
                  <ul class="dropdown-menu right-top-dropdown-menu">
                    <li>
                      <a ng-click="dpm.clearDay(dayModel)" href="javascript:void(0)">
                        <span class="glyphicon glyphicon-remove"></span> Clear day
                      </a>
                      <a ng-click="dpm.deleteDay(dayModel)" href="javascript:void(0)">
                        <span class="glyphicon glyphicon-trash"></span> Remove day from trip
                      </a>
                    </li>
                  </ul>
                </div>

                <div ng-show="!editingNote" class="day-planner-one-day-note">[[dayModel.noteItem.data['text'] ]]</div>
                <div ng-show="editingNote">
                  <textarea class="form-control" ng-model="dayModel.noteItem.data['text']"
                    tc-focus-on="editingNote" ng-blur="closeNoteEditor()"
                    placeholder="Enter a note about this day">
                  </textarea>
                </div>
                <div ng-show="!dayModel.hasItems()" class="day-planner-day-cta">
                  Drag and drop places here to plan by day
                </div>
                <div tc-item-drop-target day="dayModel.dayNumber" position="0"
                  drag-item="dragItem" on-drop="handleDrop(dayModel.dayNumber, 0)">
                </div>
                <div ng-repeat="itemModel in dayModel.getItems()">
                  <tc-draggable-entity item="itemModel" drag-item="dragItem"
                    on-dragstart="onDragstart($event, itemModel)" on-dragend="onDragend()"
                    on-clear="clearItem(itemModel)">
                  </tc-draggable-entity>
                  <div tc-item-drop-target day="dayModel.dayNumber" position="itemModel.position() + 1"
                    drag-item="dragItem" on-drop="handleDrop(dayModel.dayNumber, itemModel.position() + 1)">
                  </div>
                </div>
              </div>
            </div>

            <div class="day-planner-controls">
              <button class="btn btn-default day-planner-add-day-button" ng-click="addNewDay()">
                <span class="glyphicon glyphicon-plus"></span> Add a day
              </button>
            </div>

          </div>
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="day-planner-drop-target-template">
    <div class="day-planner-drop-target"
      ng-class="{'dragactive': isDragActive(), 'dragover': dragover}"
      tc-dragenter="onDragenter($event)"
      tc-dragleave="onDragleave($event)"
      tc-dragover="onDragover($event)"
      tc-drop="onDrop(); dropDone($event)"
    >
      <div class="day-planner-drop-target-inner"
        tc-dragenter="onInnerDragenter()"
        tc-dragleave="onInnerDragleave()">
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="day-planner-entity-item-template">
    <div draggable="true" class="day-planner-draggable-entity"
      ng-class="{'existing-item-dragactive': activeItemIsThis(item)}"
      tc-dragstart="onDragstart({$event: $event})" tc-dragend="onDragend()">
      <tc-entity-listing entity-data="item.data">
      </tc-entity-listing>
      <div class="draggable-entity-controls">
        <a ng-click="onClear()" href="javascript:void(0)" tooltip="Remove from day">
          <span class="glyphicon glyphicon-remove"></span>
        </a>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="one-entity-summary-template">
    <div ng-controller="EntitySummaryCtrl" class="one-entity-summary"
      tc-entity-id="[[ed['entity_id'] ]]"
      ng-class="{'selected': pageStateModel.entityIsSelected(ed['entity_id']),
        'controls-open': controlState.open}"
      ng-click="selectEntity()">
      <a class="scroll-anchor"></a>
      <span class="entity-circle-img">
        <img ng-src="[[em.getBackgroundImageUrl(planModel.locationLatlng())]]"/>
      </span>
      <span class="entity-info" ng-show="!controlState.open">
        <div class="name">
          [[ed['name'] ]]
        </div>
        <div class="details">
          <span ng-show="em.hasCategory()"
            ng-class="'text-' + ed['category']['name']">
            [[em.categoryDisplayText()]]
          </span>
          <span ng-show="ed['comments'] && ed['comments'].length" class="quickinfo-icon" tc-icon="comment">
          </span>
          </span>
          <span class="glyphicon glyphicon-star favorite-star quickinfo-icon" ng-show="ed['starred']">
          </span>
        </div>
      </span>
      <span class="controls" ng-show="controlState.open" ng-click="$event.stopPropagation()">
        <span ng-show="!controlState.showSecondaryControls">
          <a class="black-link" ng-click="openInlineEdit(InlineEditMode.TAGS)" href="javascript:void(0)"
            tooltip="Add Tags" tooltip-placement="bottom" tooltip-append-to-body="true">
            <span class="glyphicon glyphicon-tag"></span>
          </a>
          <a class="black-link" ng-click="openInlineEdit(InlineEditMode.DIRECTIONS); closeControls()"
            href="javascript:void(0)"
            tooltip="Get directions" tooltip-placement="bottom" tooltip-append-to-body="true">
            <span tc-icon="compass"></span>
          </a>
          <a class="black-link" ng-click="openInlineEdit(InlineEditMode.COMMENTS); closeControls()"
            href="javascript:void(0)"
            tooltip="Comment" tooltip-placement="bottom" tooltip-append-to-body="true">
            <span tc-icon="comment"></span>
          </a>
        </span>
        <span ng-show="controlState.showSecondaryControls">
          <a class="black-link" ng-click="saveStarState(true)"
            ng-show="!ed['starred']" href="javascript:void(0)"
            tooltip="Favorite" tooltip-placement="bottom" tooltip-append-to-body="true">
            <span class="glyphicon glyphicon-star-empty"></span>
          </a>
          <a class="black-link" ng-click="saveStarState(false)"
            ng-show="ed['starred']" href="javascript:void(0)"
            tooltip="Un-favorite" tooltip-placement="bottom" tooltip-append-to-body="true">
            <span class="glyphicon glyphicon-star favorite-star"></span>
          </a>
          <a class="black-link" ng-click="openEditPlaceModal(); closeControls()"
            href="javascript:void(0)"
            tooltip="Edit" tooltip-placement="bottom" tooltip-append-to-body="true">
            <span class="glyphicon glyphicon-pencil"></span>
          </a>
          <a class="black-link" ng-click="deleteEntity()"
            href="javascript:void(0)"
            tooltip="Delete" tooltip-placement="bottom" tooltip-append-to-body="true">
            <span class="glyphicon glyphicon-trash"></span>
          </a>
        </span>
        <span class="control-toggle">
          <a class="black-link" ng-click="controlState.showSecondaryControls = !controlState.showSecondaryControls"
            href="javascript:void(0)"
            tooltip="More controls" tooltip-placement="bottom" tooltip-append-to-body="true">
            &hellip;
          </a>
        </span>
      </span>
      {% if allow_editing %}
      <div class="control-cog-section" ng-click="$event.stopPropagation()">
        <span class="control-cog">
          <a class="black-link" ng-click="openControls()" href="javascript:void(0)" ng-show="!controlState.open">
            <span class="glyphicon glyphicon-cog"></span>
          </a>
          <a ng-click="closeControls()" href="javascript:void(0)" class="white-link"
            ng-show="controlState.open">
            <span class="glyphicon glyphicon-remove"></span>
          </a>
        </span>
      </div>
      {% endif %}
      <XXtc-entity-marker ng-if="position"
        map="map" marker="markerState.marker" position="position"
        category-name="ed['category'] && ed['category']['name']"
        icon-template-name="markerState.iconTemplateName"
        selected="pageStateModel.entityIsSelected(ed['entity_id'])"
        precise="ed['address_precision'] == 'Precise'"
        starred="ed['starred']" has-comments="ed['comments'] && ed['comments'].length"
        emphasized="markerState.emphasized" deemphasized="markerState.deemphasized"
        on-click="markerClicked($event)">
      </XXtc-entity-marker>
    </div>
  </script>

  <script type="text/ng-template" id="one-entity-listing-template">
    <div class="one-entity-listing"
      tc-entity-id="[[ed['entity_id'] ]]"
      ng-class="{'selected': isSelected({$entityData: ed})}"
      ng-click="onSelect({$entityData: ed})">
      <span class="entity-circle-img">
        <img ng-src="[[im.getBackgroundImageUrl()]]" draggable="false"/>
      </span>
      <span class="entity-info">
        <div class="name">
          [[ed['name'] ]]
        </div>
        <div class="details">
          <span ng-show="im.hasCategory()"
            ng-class="'text-' + ed['category']['name']">
            [[im.categoryDisplayText()]]
          </span>
          <span ng-show="im.day() && shouldShowDay" ng-class="day">
            Day [[im.day()]]
          </span>
          <span class="glyphicon glyphicon-star favorite-star" ng-show="ed['starred']">
          </span>
        </div>
      </span>
    </div>
  </script>

  <script type="text/ng-template" id="details-panel-template">
    <div class="details-panel one-info-panel"
      tc-scroll-to-selector scroll-on-changes-to="pageStateModel.selectedEntity"
      scroll-dest-selector=".one-entity-details[tc-entity-id='[[pageStateModel.selectedEntity['entity_id'] ]]']">
      <tc-trip-plan-details-header trip-plan="planModel.tripPlanData"
        num-entities="planModel.numEntities()" for-guide="false" full-bleed="true" include-details="true">
      </tc-trip-plan-details-header>
      <tc-entity-details ng-repeat="entity in planModel.entities()"
        entity="entity" is-editable="{{allow_editing | jsbool}}" for-results="false"
        trip-plan-id="planModel.tripPlanId()">
      </tc-entity-details>
      <div class="back-to-top" ng-show="planModel.hasEntities()">
        <a tc-scroll-on-click scroll-parent=".details-panel" scroll-target=".details-panel"
          href="javascript:void(0)">
          Back to top
          <span class="glyphicon glyphicon-chevron-up"></span>
        </a>
      </div>
      {% if allow_editing %}
      <div ng-if="!planModel.hasEntities()" class="no-entities-message">
        <p>
          Details about your places go here.
        </p>
        <p>
          Get started by choosing<br/>
          <span class="sample-link">
            <span class="glyphicon glyphicon-book"></span>
            Browse Guides
          </span>
          or
          <span class="sample-link">
            <span class="glyphicon glyphicon-plus"></span>
            Add Your Own
          </span>
          <br/>
          from the menu above to add places to your trip.
        </p>
      </div>
      {% endif %}
    </div>
  </script>

  <script type="text/ng-template" id="trip-plan-header-template">
    <div class="trip-plan-header">
      <span class="trip-plan-name">
        [[planModel.tripPlanData['name'] ]]
      </span>
      <span class="place-count">
        [[planModel.numEntities()]]
      </span>
      <span class="minimize-link">
        <a class="black-link" ng-click="pageStateModel.summaryPanelExpanded = false"
          ng-show="pageStateModel.summaryPanelExpanded"
          href="javascript:void(0)">
          <span class="glyphicon glyphicon-minus"></span>
        </a>
        <a class="black-link" ng-click="pageStateModel.summaryPanelExpanded = true"
          ng-show="!pageStateModel.summaryPanelExpanded"
          href="javascript:void(0)">
          <span class="glyphicon glyphicon-plus"></span>
        </a>
      </span>
    </div>
  </script>

  <script type="text/ng-template" id="one-entity-details-template">
    <div class="one-entity-details"
      tc-entity-id="[[forResults ? null : ed['entity_id'] ]]"
      tc-entity-result-id="[[forResults ? resultIndex : null]]"
      ng-mouseenter="highlightMarker()">
      <div class="name-and-photos">
        <div ng-if="ed['photo_urls'] && ed['photo_urls'].length" class="photo-carousel">
          <div tc-image-carousel urls="ed['photo_urls']" full-bleed="true" class="carousel-content">
          </div>
        </div>
        <div class="name-section">
          <span class="entity-icon">
            <tc-entity-icon precise="ed['address_precision'] == 'Precise'"
              category-name="ed['category'] && ed['category']['name']"
              icon-template-name="iconTemplateName()">>
            </tc-entity-icon>
          </span>
          <span class="entity-name">
            [[ed['name'] ]]
          </span>
          <span class="star-section">
            <span ng-if="isEditable">
              <a ng-click="saveStarState(true)"
                ng-show="!ed['starred']" href="javascript:void(0)" tooltip="Favorite" tooltip-placement="left">
                <span class="glyphicon glyphicon-star-empty"></span>
              </a>
              <a ng-click="saveStarState(false)"
                ng-show="ed['starred']" href="javascript:void(0)" tooltip="Un-favorite" tooltip-placement="left">
                <span class="glyphicon glyphicon-star favorite-star"></span>
              </a>
            </span>
            <span ng-if="!isEditable">
              <span class="glyphicon glyphicon-star favorite-star"
                ng-show="ed['starred']">
              </span>
            </span>
          </span>
        </div>
      </div>
      <div class="one-entity-content">
        <div class="info-tabs">
          <span class="info-tab" ng-class="{'selected': infoTab == InfoTab.ABOUT}"
            ng-show="showAboutTab()">
            <a class="black-link" ng-click="selectInfoTab(InfoTab.ABOUT)" href="javascript:void(0)">
              About
            </a>
          </span>
          <span class="info-tab" ng-class="{'selected': infoTab == InfoTab.DETAILS}">
            <a class="black-link" ng-click="selectInfoTab(InfoTab.DETAILS)" href="javascript:void(0)">
              Details
            </a>
          </span>
          <span class="info-tab" ng-class="{'selected': infoTab == InfoTab.COMMENTS}"
            ng-show="showCommentsTab()">
            <a class="black-link" ng-click="selectInfoTab(InfoTab.COMMENTS)"
              href="javascript:void(0)">
              Comments
              <span ng-show="em.hasComments()">([[em.numComments()]])<span>
            </a>
          </span>
          <span class="add-to-trip-cta" ng-show="!isEditable">
            <a ng-click="clipEntity()" ng-show="!isAlreadySaved()" class="add-to-trip-link"
              href="javascript:void(0)">
              Add to My Trip
            </a>
            <span ng-show="isAlreadySaved()" class="saved-status">
              Saved
            </span>
          </span>
        </div>
        <div class="tab-content">
          <div ng-show="infoTab == InfoTab.ABOUT">
            <div ng-show="ed['origin_trip_plan_name']" class="origin-trip-name">
              Originally from
              <a ng-href="/trip_plan/[[ed['origin_trip_plan_id'] ]]" target="_blank"
                class="underline-link">
                [[ed['origin_trip_plan_name'] ]]
              </a>
            </div>
            <div class="description" ng-if="ed['description']">
              <tc-expandable-content text-content="ed['description']"
                expand-link-text="Read more" collapse-link-text="Read less"
                max-lines="5">
              </tc-expandable-content>
            </div>
            <div ng-show="showAddDescriptionPrompt()">
              <a ng-click="openDescriptionEditor()" class="cta-link" href="javascript:void(0)">
                Add a description
              </a>
            </div>
            <div ng-if="inlineEditMode == InlineEditMode.DESCRIPTION" class="inline-editor">
              <textarea class="form-control" ng-model="descriptionState.rawInput"
                placeholder="Description" tc-focus-on="inlineEditMode">
              </textarea>
              <a ng-click="saveDescription()" href="javascript:void(0)" class="cta-link">
                Save
              </a>
              <a ng-click="closeDescriptionEditor()" href="javascript:void(0)">
                Cancel
              </a>
            </div>
            <div class="tags" ng-show="showTags()">
              Tags: 
              <span ng-repeat="tag in ed['tags']" class="one-tag">
                [[tag['text'] ]]
              </span>
              <a ng-show="!em.hasTags()" ng-click="openTagsEditor()"
                class="cta-link" href="javascript:void(0)">
                Add tags
              </a>
            </div>
            <div class="inline-editor tags-editor" ng-show="inlineEditMode == InlineEditMode.TAGS">
              <label>Enter tags, separated by commas</label>
              <form ng-submit="saveTags()">
                <input type="text" class="form-control" ng-model="tagState.rawInput"
                  placeholder="e.g. greek food, day 1, recommended by Bob"
                  tc-focus-on="inlineEditMode"/>
              </form>
              <a ng-click="saveTags()" href="javascript:void(0)" class="cta-link">
                Save
              </a>
              <a ng-click="closeTagsEditor()" href="javascript:void(0)">
                Cancel
              </a>
            </div>
          </div>
          <div ng-show="infoTab == InfoTab.DETAILS">
            <div class="source-attribution" ng-show="ed['source_url']">
              Place info from
              <a ng-href="[[ed['source_url'] ]]" target="_blank">[[ed['source_display_name'] ]]</a>
            </div>
            <div ng-show="ed['address']" class="detail-item">
              Address: [[ed['address'] ]]
            </div>
            <div ng-show="em.hasOpeningHours()" class="detail-item">
              Hours: <span class="opening-hours">[[em.openingHoursStr()]]</span>
            </div>
            <div ng-show="ed['phone_number']" class="detail-item">
              Phone: [[ed['phone_number'] ]]
            </div>
            <div ng-show="ed['website']" class="detail-item">
              Website:
              <a ng-href="[[ed['website'] ]]" target="_blank" class="cta-link">
                [[ed['website'] ]]
              </a>
            </div>
            <div class="reputation-section"
              ng-show="em.hasReputationInfo() && ed['source_is_trusted_for_reputation']">
              <div ng-show="ed['source_url']">
                Ratings and Reviews from
                <a ng-href="[[ed['source_url'] ]]" target="_blank" class="underline-link">
                  [[ed['source_display_name'] ]]
                </a>
              </div>
              <div>
                <span class="star-rating" ng-if="ed['rating']">
                  <tc-star-rating value="ed['rating']" max="ed['rating_max'] || 5">
                  </tc-star-rating>
                </span>
                <span class="num-reviews" ng-if="ed['review_count']">
                  [[ed['review_count'] ]] reviews
                </span>
              </div>
            </div>
            <div ng-if="inlineEditMode == InlineEditMode.DIRECTIONS" class="inline-editor">
              Get directions
              <a ng-click="directionsHelper.toggleDirection()"
                href="javascript:void(0)" class="cta-link">
                [[directionsHelper.direction == 'to' ? 'to' : 'from' ]]
              </a>
              <select class="form-control directions-select"
                ng-options="e['name'] for e in directionsHelper.entities"
                ng-model="directionsHelper.destination">
                <option value="">Select destination</option>
              </select>
              <button class="btn btn-cta"
                ng-click="directionsHelper.getDirections(ed)"
                ng-disabled="!directionsHelper.destination">
                Go
              </button>
              <a ng-click="closeDirections()" href="javascript:void(0)">
                Cancel
              </a>
            </div>
          </div>
          <div ng-show="infoTab == InfoTab.COMMENTS">
            <div ng-repeat="comment in ed['comments']" class="one-comment">
              <div>
                <span class="comment-sidebar">
                  <span tc-user-icon user="comment['user']">
                  </span>
                </span>
                <span class="comment-details">
                  <div ng-show="!editingComment || editingComment['comment_id'] != comment['comment_id']">
                    <div>
                      <span ng-bind-html="comment['text'] | linky:'_blank'" class="text"></span>
                      <a ng-click="openCommentEdit(comment)" ng-if="comment['user']['public_id'] == accountInfo['user']['public_id']"
                        href="javascript:void(0)" class="cta-link comment-edit-link">
                        <span class="glyphicon glyphicon-pencil"></span>
                      </a>
                      <a ng-click="deleteComment(comment)" ng-if="comment['user']['public_id'] == accountInfo['user']['public_id']"
                        href="javascript:void(0)" class="cta-link comment-edit-link">
                        <span class="glyphicon glyphicon-trash"></span>
                      </a>
                    </div>
                    <div class="comment-timestamp">
                      [[comment['last_modified'] | date: 'short']]
                    </div>
                  </div>
                  <div ng-show="editingComment && editingComment['comment_id'] == comment['comment_id']">
                    <textarea class="form-control" ng-model="editingComment['text']"
                      tc-focus-on="editingComment">
                    </textarea>
                    <div>
                      <a ng-click="saveCommentEdit()" href="javascript:void(0)" class="cta-link">Save</a>
                      <a ng-click="closeCommentEdit()" href="javascript:void(0)">Cancel</a>
                    </div>
                  </div>
                </span>
              </div>
            </div>
            <div ng-show="isEditable && !em.hasComments() && !inlineEditMode == InlineEditMode.COMMENTS">
              <a ng-click="openNewComment()" class="cta-link" href="javascript:void(0)">
                Add a comment
              </a>
            </div>
            <div ng-if="inlineEditMode == InlineEditMode.COMMENTS"
              class="inline-editor comment-editor">
              <div class="author-name">
                <span tc-user-icon user="accountInfo['user']">
                </span>
              </div>
              <textarea class="form-control" placeholder="Add a comment"
                tc-focus-on="inlineEditMode"
                ng-model="newComment['text']">
              </textarea>
              <div>
                <a ng-click="saveNewComment()" href="javascript:void(0)" class="cta-link">Save</a>
                <a ng-click="closeNewComment()" href="javascript:void(0)" class="cancel-link">Cancel</a>
              </div>
            </div>
          </div>
        </div>
        <div class="editing-controls" ng-if="isEditable">
          <span class="left-controls">
            <a class="black-link" ng-click="openTagsEditor()" href="javascript:void(0)">
              <span class="glyphicon glyphicon-tag"></span>
            </a>
            <a class="black-link" ng-click="openDirections()" href="javascript:void(0)">
              <span tc-icon="compass"></span>
            </a>
            <a class="black-link" ng-click="openNewComment()" href="javascript:void(0)">
              <span tc-icon="comment"></span>
            </a>
          </span>
          <span class="right-controls">
            <a class="black-link" ng-click="openEditPlaceModal()" href="javascript:void(0)">
              <span class="glyphicon glyphicon-pencil"></span>
            </a>
            <a class="black-link" ng-click="deleteEntity()" href="javascript:void(0)">
              <span class="glyphicon glyphicon-trash"></span>
            </a>
          </span>
        </div>
      </div>
      <tc-entity-marker ng-if="markerState.position"
        map="markerState.map" marker="markerState.marker" position="markerState.position"
        category-name="ed['category'] && ed['category']['name']"
        icon-template-name="iconTemplateName()"
        selected="entityIsSelected()"
        precise="ed['address_precision'] == 'Precise'"
        starred="ed['starred']" has-comments="em.hasComments()"
        emphasized="markerState.emphasized" deemphasized="markerState.deemphasized"
        on-click="markerClicked($event)">
      </tc-entity-marker>
    </div>
  </script>

  {% if allow_editing %}
  <script type="text/ng-template" id="gmaps-importer-template">
    <div class="gmaps-importer-modal" ng-controller="GmapsImporterCtrl">
      <h3>Import a Google custom map</h3>
      <div ng-show="!pendingTripPlan && !newTripPlan">
        <div class="paste-prompt-text">
          Paste a Google Maps Engine or My Maps url
        </div>
        <input type="text" class="form-control" placeholder="Paste a url"
          ng-model="url" ng-paste="urlPasted()" ng-disabled="importing"
          tc-focus-on="ready"/>
        <div ng-show="importing" class="search-spinner">
          <img src="/static/img/spinner-small.gif"/>
        </div>
        <div ng-show="urlInvalid" class="text-danger">
          That's not a vaid Google custom maps url.
        </div>
      </div>
      <div ng-if="saving" class="save-spinner">
        <img src="/static/img/spinner2.gif"/>
      </div>
      <div ng-show="pendingTripPlan && !newTripPlan && !saving">
        <div class="import-success-text">
          Successfully imported [[pendingTripPlan['entities'].length ]] places
          from the map
          <span class="map-name">[[pendingTripPlan['name'] ]]</span>
        </div>
        <form class="form-inline" role="form">
          <input type="radio" class="form-control" value="new" ng-model="importAction" id="new-action"/>
          <label for="new-action">
            Create a new trip plan
          </label>
          <br/>
          <input type="radio" class="form-control" value="import" ng-model="importAction" id="import-action"/>
          <label for="import-action">
            Add all [[pendingTripPlan['entities'].length ]] places to the current trip plan (<span class="map-name">[[currentTripPlanName]]</span>)
          </label>
        </form>
        <div class="buttons">
          <button class="btn btn-primary" ng-click="save()">
            Save
          </button>
          <button class="btn" ng-click="$close()">
            Cancel
          </button>
        </div>
      </div>
      <div ng-show="newTripPlan">
        <div class="import-success-text" ng-show="importAction == 'new'">
          Successfully created the new trip plan
          <a ng-href="/trip_plan/[[newTripPlan['trip_plan_id'] ]]">
            [[newTripPlan['name'] ]]
          </a>
        </div>
        <div class="buttons">
          <button class="btn" ng-click="$close()">
            Close
          </button>
        </div>
      </div>
    </div>
  </script>
  {% endif %}

  {% if allow_editing %}
  <script type="text/ng-template" id="guides-panel-template">
    <div class="guides-panel one-info-panel" ng-controller="GuidesPanelCtrl"
      tc-scroll-to-selector scroll-on-changes-to="searchResultState.selectedIndex"
      scroll-dest-selector=".one-entity-details[tc-entity-result-id='[[searchResultState.selectedIndex]]']"
      tc-reset-scroll-top-on="selectedGuide">
      <div ng-show="!selectedGuide">
        <div class="header">
          Browse popular guides for <i>[[planModel.tripPlanData['location_name'] ]]</i>
          to add to your trip
        </div>
        <div ng-show="loading">
          Loading... <img ng-src="/static/img/spinner-small.gif"/>
        </div>
        <div ng-show="!loading && (!guides || !guides.length)" class="no-guides-msg">
          There aren't any featured guides for this area yet.
          <a href="javascript:void(0)">Create your own.</a>
        </div>
        <div ng-show="guides && guides.length">
          <tc-trip-plan-details-header ng-repeat="guide in guides" trip-plan="guide"
            num-entities="guide['entities'].length" for-guide="true"
            clickable="true" on-click="selectGuide(guide)">
          </tc-trip-plan-details-header>
        </div>
      </div>
      <div ng-show="selectedGuide">
        <div class="guide-breadcrumb">
          <a ng-click="backToListings()" href="javascript:void(0)">
            [[planModel.tripPlanData['location_name'] ]] Guides
          </a>
          &gt;
          [[selectedGuide['name'] ]]
        </div>
        <tc-trip-plan-details-header trip-plan="selectedGuide"
          num-entities="selectedGuide['entities'].length" for-guide="true" full-bleed="true" include-details="true">
        </tc-trip-plan-details-header>
        <tc-entity-details ng-repeat="entity in selectedGuide['entities']"
          entity="entity" is-editable="false" for-results="true"
          trip-plan-id="selectedGuide['trip_plan_id']" result-index="$index">
        </tc-entity-details>

        <div class="back-to-top">
          <a tc-scroll-on-click scroll-parent=".guides-panel" scroll-target=".guides-panel"
            href="javascript:void(0)" class="cta-link">
            Back to top
            <span class="glyphicon glyphicon-chevron-up"></span>
          </a>
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="add-your-own-panel-template">
    <div class="add-your-own-panel one-info-panel" ng-controller="AddYourOwnPanelCtrl">
      <div class="sub-nav btn-group">
        <button type="button" class="btn btn-default"
          ng-class="{'active': tab == AddYourOwnTab.SEARCH}"
          ng-click="selectTab(AddYourOwnTab.SEARCH)">
          <span class="glyphicon glyphicon-search"></span>
        </button>
        <button type="button" class="btn btn-default"
          ng-class="{'active': tab == AddYourOwnTab.CLIPPER}"
          ng-click="selectTab(AddYourOwnTab.CLIPPER)">
          <span class="glyphicon glyphicon-paperclip"></span>
        </button>
        <button type="button" class="btn btn-default"
          ng-class="{'active': tab == AddYourOwnTab.PASTE_LINK}"
          ng-click="selectTab(AddYourOwnTab.PASTE_LINK)">
          <span class="glyphicon glyphicon-link"></span>
        </button>
      </div>

      <div ng-if="tab == AddYourOwnTab.SEARCH" class="search-panel">
        <div class="header">
          Search for places by name, address, or category in
          <i>[[planModel.tripPlanData['location_name'] ]]</i>
        </div>
        <div class="search-input">
          <input type="text" class="form-control" ng-model="searchState.rawInput"
            tc-focus-on="tab"
            tc-google-place-autocomplete
            search-bounds-json="planModel.tripPlanData['location_bounds']"
            on-place-change="googlePlaceSelected($newPlace)"
            placeholder="e.g. 'cafe', '123 Main St', or 'Eiffel Tower'"/>
          <div class="search-spinner" ng-show="searchState.searching">
            <img src="/static/img/spinner-small.gif"/>
          </div>
        </div>
        <div ng-show="hasNoSearchResults()" class="no-search-results">
          No results found
        </div>

        <div class="search-results">
          <div ng-show="searchState.resultType == ResultType.SEARCH"
            class="results-header">
            Results from Google for <span class="results-query">[[searchState.rawInput]]</span>
            near <i>[[planModel.tripPlanData['location_name'] ]]</i>
          </div>
          <div ng-show="searchState.resultType == ResultType.ENTITY_LOOKUP"
            class="results-header">
            Place details from Google
          </div>
          <tc-entity-details ng-repeat="entity in searchState.results"
            entity="entity" is-editable="false" for-results="true"
            trip-plan-id="planModel.tripPlanId()" result-index="$index">
          </tc-entity-details>
        </div>
      </div>

      <div ng-if="tab == AddYourOwnTab.CLIPPER" class="clipper-panel">
        <div class="header">
          Clip places from travel websites to your trip
        </div>

        <div class="bookmarklet-section">
          <span class="bookmarklet">
            <a href="javascript:(function(){c=document.createElement('script');c.type='text/javascript';c.src='{{bookmarklet_url}}'+'?'+Math.floor(Math.random()*99999999);document.body.appendChild(c);})();"
            onclick="event.stopPropagation(); event.preventDefault()">
              <span class="bookmarklet-link">
                <span class="glyphicon glyphicon-paperclip"></span> Clipper
              </span>
            </a>
          </span>
          <span>
            Drag the Clipper to your bookmarks bar
          </span>
        </div>

        <div class="info-text">
          After adding the Clipper to your bookmarks bar, try it out on
          these sites by clicking the Clipper whenever you want to add a place
          to your trip.
        </div>

        <div class="help-section info-text">
          <a ng-click="toggleHelp()" href="javascript:void(0)">
            Help with installing the Clipper
          </a>
          <div ng-show="showClipperHelp" ng-include="'clipper-help-template'">
          </div>
        </div>

        <div class="sample-sites container-fluid">
          <div class="row">
            <div ng-repeat="site in sampleSupportedSites" class="col-md-6 sample-site">
              <img ng-src="[[site.iconUrl]]" class="site-icon"/>
              <span><a ng-href="[[site.url]]" target="_blank">[[site.name]]</a></span>
            </div>
          </div>
        </div>
      </div>

      <div ng-if="tab == AddYourOwnTab.PASTE_LINK" class="paste-link-panel">
        <div class="header">
          Copy and paste URLs from select websites to add places
        </div>
        <div class="paste-input">
          <form ng-submit="linkPasted()">
            <input type="text" class="form-control" ng-model="linkState.rawInput"
              placeholder="http://..." tc-focus-on="tab"
              ng-paste="linkPasted()"/>
            </form>
          <div class="search-spinner" ng-show="linkState.loading">
            <img src="/static/img/spinner-small.gif"/>
          </div>
        </div>

        <div ng-show="!(linkState.loading || linkState.loadingComplete)">
          <div class="info-text">
            Try it out by pasting place pages from these websites:
          </div>

          <div class="sample-sites container-fluid">
            <div class="row">
              <div ng-repeat="site in sampleSupportedSites" class="col-md-6 sample-site">
                <img ng-src="[[site.iconUrl]]" class="site-icon"/>
                <span><a ng-href="[[site.url]]" target="_blank">[[site.name]]</a></span>
              </div>
            </div>
          </div>
        </div>

        <div ng-show="noLinkResults()">
          <div class="no-search-results">No results found</div>
          <div class="info-text no-places">
            TravelClipper couldn't automatically find places on that page.
            <br/>
            <br/>
            Try installing the
            <a ng-click="selectTab(AddYourOwnTab.CLIPPER)"
              class="cta-link" href="javascript:void(0)">clipper bookmark</a>,
            then
            <a ng-href="[[linkState.formattedUrl]]" target="_blank" class="cta-link">
              visit the website
            </a>
             to quickly clip information and images.
           </div>
        </div>

        <div class="text-danger info-text" ng-show="linkState.invalidUrl">
          Oops, that doesn't look like a valid url
        </div>

        <div class="link-results" ng-if="linkState.results && linkState.results.length">
          <div class="results-header">
            Results from [[linkState.siteDomain]]
          </div>
          <tc-entity-details ng-repeat="entity in linkState.results"
            entity="entity" is-editable="false" for-results="true"
            trip-plan-id="planModel.tripPlanId()" result-index="$index">
          </tc-entity-details>
        </div>

      </div>

    </div>
  </script>

  <script type="text/ng-template" id="clipper-help-template">
    <div class="clipper-help-details">
      <div ng-if="browserInfo.platform == BrowserPlatform.WINDOWS">
        <div ng-if="browserInfo.app == BrowserApp.CHROME">
          For Chrome/Windows: First make sure your bookmarks bar is shown, by pressing
          control-shift-B or View -> Always Show Bookmarks Bar.
          Then click and drag the clipper bookmark above into the bookmarks bar
          and release it to create a new bookmark item.
        </div>
        <div ng-if="browserInfo.app == BrowserApp.FIREFOX">
          For Firefox/Windows: First make sure your bookmarks bar is shown, clicking
          View -> Toolbars -> Bookmarks Toolbar.
          Then click and drag the clipper bookmark above into the bookmarks bar
          and release it to create a new bookmark item.
        </div>
        <div ng-if="browserInfo.app == BrowserApp.SAFARI">
          For Safari/Windows: First make sure your bookmarks bar is shown, by pressing
          control-shift-B or View -> Show Favorites Bar.
          Then click and drag the clipper bookmark above into the bookmarks bar
          and release it to create a new bookmark item.
        </div>
      </div>
      <div ng-if="browserInfo.platform == BrowserPlatform.MAC">
        <div ng-if="browserInfo.app == BrowserApp.CHROME">
          For Chrome/Mac: First make sure your bookmarks bar is shown, by pressing
          command-shift-B or View -> Always Show Bookmarks Bar.
          Then click and drag the clipper bookmark above into the bookmarks bar
          and release it to create a new bookmark item.
        </div>
        <div ng-if="browserInfo.app == BrowserApp.FIREFOX">
          For Firefox/Mac: First make sure your bookmarks bar is shown, clicking
          View -> Toolbars -> Bookmarks Toolbar.
          Then click and drag the clipper bookmark above into the bookmarks bar
          and release it to create a new bookmark item.
        </div>
        <div ng-if="browserInfo.app == BrowserApp.SAFARI">
          For Safari/Mac: First make sure your bookmarks bar is shown, by pressing
          command-shift-B or View -> Show Favorites Bar.
          Then click and drag the clipper bookmark above into the bookmarks bar
          and release it to create a new bookmark item.
        </div>
      </div>
      <div ng-if="!browserInfo.platform || !browserInfo.app">
        First make sure your browser's bookmarks bar is shown.
        This is typically done by going to the 'View' menu in your
        browser and looking for an option like 'Show bookmarks bar'.
        Then click and drag the clipper bookmark above into the bookmarks
        bar and release the mouse, which should create a new item in the bookmarks bar.
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="export-panel-template">
    <div class="export-panel one-info-panel">
      <div class="header">
        Take your trip plan with you on the road
      </div>

      <div>
        Export your trip in your preferred format. Offline mobile support for iOS and Android coming soon!
      </div>
      <div class="export-buttons">
        <btn class="btn btn-export btn-default">
          <a class="export-button" target="_blank"
            ng-href="/trip_plan/[[planModel.tripPlanId()]]/print">
            Print
          </a>
        </btn>
        <btn class="btn btn-export btn-default">
          <a class="export-button" ng-href="/trip_plan/[[planModel.tripPlanId()]]/csv">
            Spreadsheet
          </a>
        </btn>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="sharing-panel-template">
    <div class="sharing-panel one-info-panel" ng-controller="SharingSettingsCtrl">
      <div class="header">
        Share your trip with collaborators and viewers
      </div>

      <div class="section">
        <div class="section-header">
          Collaborators
        </div>
        <div class="info-text">
          Collaborators can edit and comment on this trip and invite other collaborators.
        </div>
        <p class="collaborator">
          <span tc-user-icon user="creator" no-tooltip="true"></span>
          [[creator['display_name'] ]]
          <span ng-show="isCurrentUser(creator)">(you)</span>
          - creator
        </p>
        <p ng-repeat="editor in editors()" class="collaborator">
          <span tc-user-icon user="editor" no-tooltip="true"></span>
          [[editor['display_name'] ]]
          <span ng-show="isCurrentUser(editor)">
            (you)
          </span>
          <a ng-click="removeEditor(editor)"
            ng-show="!isCurrentUser(editor)"
            href="javascript:void(0)" class="remove-link cta-link">
            <span class="glyphicon glyphicon-trash"></span>
          </a>
        </p>
        <p ng-repeat="inviteeEmail in inviteeEmails()" class="collaborator">
          <span>
            [[inviteeEmail]] (invited)
            <a ng-click="removeInvitee(inviteeEmail)"
              href="javascript:void(0)" class="remove-link cta-link">
              <span class="glyphicon glyphicon-trash"></span>
            </a>
          </span>
        </p>

        <form class="form-inline" role="form" ng-submit="addCollaborator()">
          <div class="form-group full-width">
            <input type="text" class="form-control email-input"
              placeholder="Enter an email address"
              ng-model="formState.email"/>
            <button class="btn btn-cta add-btn">
              Add
            </button>
          </div>
        </form>
      </div>

      <div class="section">
        <div class="section-header">
          Viewers
        </div>
        <div>
          Viewers who are not collaborators cannot edit and comment on the trip or invite collaborators.
          Anyone with the following link can view your trip.
        </div>
        <input type="text" class="form-control share-url" disabled="true" ng-model="shareUrl"/>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="settings-panel-template">
    <div class="settings-panel one-info-panel" ng-controller="TripPlanSettingsEditorCtrl">
      <div class="header">
        Settings
      </div>

      <div class="settings-panel-body">

        <div class="delete-trip-link">
          <a ng-click="deleteTripPlan()" href="javascript:void(0)" class="warning-link">
            <span class="glyphicon glyphicon-trash"></span>
            Delete Trip
          </a>
        </div>

        <div class="input-section">
          <label>Trip Name</label>
          <input type="text" class="form-control" ng-model="tpd['name']"
            placeholder="e.g. April in Paris"/>
        </div>

        <div class="input-section">
          <label>Cover Image</label>
          <div ng-if="editingImage">
            <textarea class="cover-img-drop-target"
              placeholder="Drag and drop an image or paste an image url"
              ng-model="coverImgUrlInput.text" ng-change="coverImgUrlChanged()" ng-paste="coverImgUrlPasted()"
              tc-dragenter="coverImgDragenter()" tc-dragover="$event.preventDefault()" tc-drop="coverImgUrlDropped($event)"
              ng-class="{'dragactive': coverImgDragActive}">
            </textarea>
          </div>
          <div class="cover-img-container"
            ng-if="tpd['cover_image_url'] && !editingImage">
            <img ng-src="[[tpd['cover_image_url'] ]]"/>
            <div class="img-control top-control">
              <a ng-click="changeImage()" href="javascript:void(0)">
                Change image
                <span class="glyphicon glyphicon-picture"></span>
              </a>
            </div>
            <div class="img-control bottom-control">
              <a ng-click="removeImage()" href="javascript:void(0)">
                Remove image
                <span class="glyphicon glyphicon-trash"></span>
              </a>
            </div>
          </div>
        </div>

        <div class="input-section">
          <label>Description</label>
          <textarea class="form-control description-input" ng-model="tpd['description']">
          </textarea>
        </div>

        <div class="input-section">
          <label>Tags</label> (separated by commas)
          <input type="text" class="form-control" ng-model="tagState.rawInput"
            ng-change="tagsChanged()"
            placeholder="e.g. fine dining, history, adventure"/>
        </div>

        <div class="save-confirmation" ng-show="saveComplete">
          Settings saved          
        </div>

        <div class="buttons">
          <button ng-click="saveSettings()" class="btn btn-cta">
            Save
          </button>
        </div>
      </div>
    </div>
  </script>
  {% endif %}

  <script type="text/ng-template" id="user-icon-template">
    <a href="javascript:void(0)" tooltip="[[noTooltip ? null : user['display_name'] ]]"
      tooltip-append-to-body="true">
      <span class="user-icon"
        ng-class="'user-' + userStyleIdentifier()">
        [[user['display_name'].substring(0, 1) ]]
      </span>
    </a>
  </script>

  <script type="text/ng-template" id="after-new-trip-plan-panel-template">
    <div class="after-new-trip-plan-panel" id="after-new-trip-plan-panel">
      <div class="connector">
      </div>
      <div class="panel-body">
        <div class="close-button">
        <a ng-click="onClose()" href="javascript:void(0)">
            <span class="glyphicon glyphicon-remove"></span>
          </a>
        </div>
        <div class="header">Created a new trip!</div>
        <div>
          <p>
            <i>[[activeTripPlanState.lastClippedEntity['name'] ]]</i> was added to this trip.
          </p>
          <p ng-show="activeTripPlanState.numEntities == 1">
            You have 1 place in this trip.
          </p>
          <p ng-show="activeTripPlanState.numEntities > 1">
            You have [[activeTripPlanState.numEntities]] places in this trip.
          </p>
        </div>
        <div>
          Go to your trip plan or add more places while browsing guides.
        </div>
        <div class="button-panel">
          <button ng-click="goToTripPlan()" class="btn btn-primary">
            View Trip Plan
          </button>
          <span class="button-separator"></span>
          <button class="btn btn-cta" ng-click="onClose()">
            Keep Browsing
          </button>
        </div>
      </div>
    </div>
  </script>

  {% include 'nav.html' %}
  {% include 'widgets.html' %}
  {% include 'map_markers.html' %}
  {% include 'icons.html' %}
  {% include 'trip_plan_common.html' %}


  <script>
    initApp(
      {{plan.to_json_str()|safe}},
      {{entities_json|safe}},
      {{notes_json|safe}},
      {{to_json_str(all_trip_plans)|safe}},
      {{to_json_str(active_trip_plan)|safe}},
      {{active_trip_plan_entity_count}},
      {{account_info.to_json_str()|safe}},
      {{all_datatype_values.to_json_str()|safe}},
      {{allow_editing|jsbool}},
      {{sample_sites_json|safe}},
      {{to_json_str(flashed_messages)|safe}});
  </script>
</body>
</html>
