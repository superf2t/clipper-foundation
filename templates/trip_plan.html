<!doctype html>
<html>
<head>
  <title>{{plan.name}}</title>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="//maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>
  <script src="/static/js/imagesloaded.pkgd.min.js"></script>
  <script src="/static/js/masonry.pkgd.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular.min.js"></script>
  <script src="/static/js/ui-bootstrap-tpls-0.10.9.js"></script>
  <script src="/static/js/angular-masonry.min.js"></script>
  <script src="/static/js/script.js"></script>
  <link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400|Raleway:400">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="shortcut icon" href="/static/img/globe.png">
</head>
<body ng-controller="RootCtrl">
  <nav class="navbar navbar-default navbar-fixed-top" id="upper-navbar">
    <div class="upper-nav container">
      <div class="row">
        <div class="col-md-3" id="logo"><a href="/">Travel Clipper</a></div>
        <div class="col-md-6" id="trip-plan-title">
          <span ng-show="!editingTripPlanSettings">[[editableTripPlanSettings['name'] ]]</span>
          <form class="form-inline" role="form" onsubmit="return false" ng-show="editingTripPlanSettings">
            <input class="form-control" id="trip-plan-title-input" type="text" ng-model="editableTripPlanSettings.name"/>
            <button class="btn btn-save-changes" ng-click="saveTripPlanSettings()">Save</button>
          </form>
          <a href="javascript:void(0)" id="edit-title-link" ng-click="editTripPlanSettings()" ng-show="!editingTripPlanSettings">
            <span class="glyphicon glyphicon-pencil"></span>
          </a>
        </div>
        <div class="col-md-3" id="my-account-link">
          <a href="javascript:void(0)" ng-click="toggleAccountDropdown()">
            <span class="glyphicon glyphicon-user"></span>
          </a>
        </div>
      </div>
    </div>
  </nav> 
  <nav class="navbar navbar-fixed-top" id="lower-navbar">
    <div class="lower-nav container" ng-controller="NavigationCtrl">
      <div class="row">
        <div class="entity-nav">
          <a href="javascript:void(0)" tc-scroll-to-on-click="navAnchor('lodging')">
            <div class="col-md-1 navigation-link">
              LODGING
            </div>
          </a>
          <a href="javascript:void(0)" tc-scroll-to-on-click="navAnchor('food_and_drink')">
            <div class="col-md-1 navigation-link">
              FOOD &amp; DRINK
            </div>
          </a>
          <a href="javascript:void(0)" tc-scroll-to-on-click="navAnchor('attractions')">
            <div class="col-md-1 navigation-link">
              ATTRACTIONS
            </div>
          </a>
        </div>
        <div class="col-md-6" id="url-box">
          {% if allow_editing %}
          <input type="text" class="form-control"
            placeholder="Paste a URL to add to your trip plan"
            ng-model="clipState.url"
            ng-disabled="clipState.clipping"
            ng-paste="clipUrlChanged()"/>
          {% endif %}
        </div>
        <div class="col-me-3" id="list-map-links">
          <a href="javascript:void(0)" ng-click="showMapView()"
            ng-class="{'active-view-mode': pageStateModel.inMapView()}">
            <div id="map-view-link">
              <span class="glyphicon glyphicon-globe"></span>
            </div>
          </a>
          <a href="javascript:void(0)" ng-click="showGuideView()"
            ng-class="{'active-view-mode': pageStateModel.inGuideView()}">
            <div id="guide-view-link">
              <span class="glyphicon glyphicon-picture"></span>
            </div>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <div ng-show="pageStateModel.inMapView()">

    <div id="entity-container">

      {% if admin_mode and allow_editing %}
      <div class="add-place-button">
        <button class="btn btn-info" ng-click="openAddPlaceModal()">Add a place manually</button>
      </div>
      {% endif %}

      <div ng-repeat="category in orderedCategories">
        <div ng-controller="CategoryCtrl">
          <div ng-if="hasEntities()">
            <div class="one-entity-type">
              <a id="mapview-[[category['name'] ]]" class="offset-anchor"></a>
              <h3 ng-click="toggleSection()" class="entity-type-header">
                <a href="javascript:void(0)">[[category['display_name'] ]]
                  <span ng-show="show" class="glyphicon glyphicon-chevron-down toggle-chevron"></span>
                  <span ng-show="!show" class="glyphicon glyphicon-chevron-up toggle-chevron"></span>
                </a>
              </h3>
              <div class="columns" ng-show="show">
                <div ng-repeat="entityModel in entityModels">
                  <div class="one-entity" ng-mouseenter="openInfowindow(entityModel.data['name'])" ng-controller="EntityCtrl">
                    <div class="one-entity-title">
                      [[entityModel.data['name'] ]]
                    </div>
                    <div ng-include="'carousel-template'">
                    </div>
                    <div class="one-entity-rating">
                      <tc-star-rating value="[[entityModel.data['rating'] ]]">
                      </tc-star-rating>
                    </div>
                    <div class="entity-description"
                      ng-show="entityModel.hasDescription() && !editing">
                      <div style="white-space:pre-wrap">[[entityModel.data['description'] ]]</div>
                    </div>
                    <div ng-if="entityModel.hasLocation() && !entityModel.isPreciseLocation()" class="text-warning entity-info-text">
                      Location on map is approximate
                    </div>
                    <div ng-if="!entityModel.hasLocation()" class="text-warning entity-info-text">
                      Unable to get a location for this item
                    </div>
                    <div ng-show="editing">
                      <textarea ng-model="entityModel.data['description']" class="form-control entity-description-input"></textarea>
                    </div>
                    <div class="one-entity-source">
                      From <a ng-href="[[entityModel.data['source_url'] ]]" target="_blank">[[entityModel.data['source_url'] | hostname ]]</a>
                    </div>
                    {% if allow_editing %}
                      <div class="entity-edit-controls">
                        <a href="javascript:void(0)"
                          ng-click="deleteEntity()"
                          ng-show="!editing">
                          <span class="glyphicon glyphicon-trash"></span>
                        </a>
                        <a href="javascript:void(0)"
                          ng-click="openEditEntity()"
                          ng-show="!editing">
                          <span class="glyphicon glyphicon-pencil"></span>
                        </a>
                        <button class="btn btn-save-changes" ng-click="saveEntityEdit()" ng-show="editing">Save</button>
                        <a href="javascript:void(0)" ng-click="cancelEditing()" ng-show="editing">
                          Cancel
                        </a>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div ng-if="planModel.hasClippedPages()" ng-controller="ClippedPagesCtrl" class="clipped-pages-section">
        <h3 class="clipped-pages-header">Clipped Pages</h3>
        <div class="clipped-pages">
          <div>
            We didn't recognize these clips. We're adding support to these pages soon.
          </div>
          <div ng-repeat="clippedPage in planModel.data['clipped_pages']">
            <a href="javascript:void(0)"
              ng-click="openPageForClipping(clippedPage['source_url'])">
              [[clippedPage['title'] ]]
            </a>
          </div>
          <iframe ng-src="[[clippingPageUrl]]" ng-show="clippingActive" class="clipping-iframe">
          </iframe>
        </div>
      </div>
      <div ng-if="planModel.isEmpty()">
        <div class="getting-started-directions">
          <div class="welcome">
            Welcome to your New Trip Plan
          </div>
          <a href="javascript:(function(){c=document.createElement('script');c.type='text/javascript';c.src='{{bookmarklet_url}}'+'?'+Math.floor(Math.random()*99999999);document.body.appendChild(c);})();">
            <button class="btn btn-info" id="btn-bookmarklet">
              Travel Clipper
            </button>
          </a> <-- If you haven't already, drag me to your Bookmarks Bar
          <div class="step">
            Step 1
          </div>
          <p>
            Pick a travel destination then browse popular travel websites for hotel, restaurant, and attraction options
          </p>
          <p>
            Try these supported sites - 
            <a href="http://www.hotels.com/hotel/details.html?pa=5&pn=1&ps=5&tab=description&destinationId=504261&searchDestination=Paris&hotelId=218097&rooms[0].numberOfAdults=2&roomno=1&validate=false&previousDateful=false&reviewOrder=date_newest_first" target="_blank">Hotels.com</a>, 
            <a href="https://www.airbnb.com/rooms/2095577?s=6yRc" target="_blank">Airbnb</a>, 
            <a href="http://www.tripadvisor.com/Attraction_Review-g187147-d188150-Reviews-Musee_d_Orsay-Paris_Ile_de_France.html" target="_blank">TripAdvisor</a>, 
            <a href="http://www.yelp.com/biz/la-compagnie-des-vins-surnaturels-paris" target="_blank">Yelp</a>
          </p>
          <div class="step">
            Step 2
          </div>
          <p>
            Clip to this Trip Plan by using the clipper or by pasting the URL of the website you want to save in the URL input above
          </p>
          <div class="step">
            Step 3
          </div>
          <p>
            Come back to this Trip Plan and your bookmarked points of interest will instantly be ready for you to browse and manage
          </p>
        </div>
      </div>

      <div class="mapview-footer">
        Copyright 2014 Unicycle Labs
      </div>

    </div>

    <div id="map-container">
      <div id="map">
      </div>
    </div>

  </div>  {# end map view #}

  <div ng-show="pageStateModel.inGuideView()" ng-controller="GuideViewCtrl">

    <div class="guideview-container">
      <div ng-repeat="category in orderedCategories">
        <div ng-controller="GuideViewCategoryCtrl">
          <div ng-if="hasEntities()">
            <a id="guideview-[[category['name'] ]]" class="offset-anchor"></a>
            <div class="header-img" id="[[category['name'] ]]-header-img">
              <div class="guideview-entity-type-header">[[category['display_name'] ]]</div>
            </div>
            <div ng-repeat="entityModel in entityModels">
              <div class="guideview-one-entity" ng-controller="EntityCtrl"
                ng-class="{'guideview-entity-even': $even, 'guideview-entity-odd': $odd}">
                <div class="guideview-one-entity-title">
                  <a ng-href="[[entityModel.data['source_url'] ]]" target="_blank">[[entityModel.data['name'] ]]</a>
                </div>
                <div tc-star-rating value="[[entityModel.data['rating'] ]]" class="guideview-star-rating">
                </div tc-star-rating>
                <div ng-controller="GuideViewCarouselCtrl" class="guideview-imgs-showcase">
                  <div masonry="{ transitionDuration: 0, gutter: 6 }">
                    <a class="left carousel-control" ng-show="hasPrevImgs()" ng-click="prevImgs()" style="z-index: 1000">
                      <span class="icon-prev"></span>
                    </a>
                    <div class="masonry-brick guideview-img-masonry-brick" ng-repeat="imgUrl in activeImgUrls()">
                      <img bn-lazy-src="[[imgUrl]]" class="guideview-masonry-img"/>
                    </div>
                    <a class="right carousel-control guideview-carousel-control" ng-show="hasNextImgs()" ng-click="nextImgs()">
                      <span class="icon-next"></span>
                    </a>
                  </div>
                </div>

                <div class="guideview-entity-info">
                  <div class="guideview-entity-description"
                    ng-show="entityModel.hasDescription() && !editing">
                    <div style="white-space:pre-wrap">[[entityModel.data['description'] ]]</div>
                  </div>
                  <div ng-show="editing">
                    <textarea ng-model="entityModel.data['description']"
                      class="form-control guideview-entity-description-input">
                    </textarea>
                  </div>
                  {% if allow_editing %}
                    <div class="guideview-entity-edit-controls">
                      <a href="javascript:void(0)"
                        ng-click="deleteEntity()"
                        ng-show="!editing">
                        <span class="glyphicon glyphicon-trash"></span>
                      </a>
                      <a href="javascript:void(0)"
                        ng-click="openEditEntity()"
                        ng-show="!editing">
                        <span class="glyphicon glyphicon-pencil"></span>
                      </a>
                      <button class="btn btn-save-changes" ng-click="saveEntityEdit()" ng-show="editing">Save</button>
                      <a href="javascript:void(0)" ng-click="cancelEditing()" ng-show="editing">
                        Cancel
                      </a>
                    </div>
                  {% endif %}
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="guideview-footer">
        Copyright 2014 Unicycle Labs
      </div>
    </div>

  </div> {# end guide view #}

  {# This is below the map in the DOM so that it appears visually on top #}
  <ul ng-show="accountDropdownOpen" class="account-dropdown" ng-controller="AccountDropdownCtrl">
    <li class="account-dropdown-login-info">
      <div ng-show="accountInfo.loggedIn && !showLoginForm">
        <span class="logged-in-email">[[accountInfo['email'] ]]</span>
        <span class="logout-link">
          <a href="javascript:void(0)" ng-click="showLoginForm = true">Logout</a>
        </span>
      </div>
      <div ng-show="showLoginForm">
        <form role="form" ng-submit="doLogin()">
          <input type="text" class="form-control email-entry-input"
            ng-model="accountInfo['email']"
            placeholder="Enter your email to login"/>
          <button type="submit()" class="btn btn-primary btn-login">Login</button>
        </form>
      </div>
    </li>
    <li ng-show="allTripPlansSettings">
      <div class="my-trip-plans-heading">
        My Trip Plans
      </div>
    </li>
    <li ng-repeat="tripPlanSettings in allTripPlansSettings">
      <span ng-if="tripPlanSettings['trip_plan_id_str'] == currentTripPlanSettings['trip_plan_id_str']">
        {# Use the name from the shared settings container so it will auto update 
           if the user edits it inline. #}
        [[currentTripPlanSettings['name'] ]]
      </span>
      <span ng-if="tripPlanSettings['trip_plan_id_str'] != currentTripPlanSettings['trip_plan_id_str']">
          <a href="javascript:void(0)" ng-click="loadTripPlan(tripPlanSettings['trip_plan_id_str'])">
            [[tripPlanSettings['name'] ]]
          </a>
        </span>
    </li>
    <li class="create-new-trip-dropdown-link">
      <a href="javascript:void(0)" ng-click="createNewTripPlan()">Create New Trip Plan</a>
    </li>
  </ul>

  <script type="text/ng-template" id="clipping-modal-template">
    <div class="clipping-status-modal">
      <div ng-show="clipState.clipping">
        Clipping to your trip plan...
        <div>
          <img src="/static/img/spinner.gif"/>
        </div>
      </div>
      <div ng-show="!clipState.clipping">
        <div ng-if="clipState.statusCode == 0">
          An error occurred during clipping.  Please try again.
        </div>
        <div ng-if="clipState.statusCode == 1">
          Successfully clipped "[[clipState.entity['name'] ]]""
        </div>
        <div ng-if="clipState.statusCode == 2">
          We don't recognize this website so we've saved this URL for you to clip manually.
        </div>
        <div ng-if="clipState.statusCode == 3">
          You've already clipped this page to your trip plan.
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="carousel-template">
    <div ng-controller="CarouselCtrl" class="carousel">
      <a class="left carousel-control" ng-show="hasPrevImg()" ng-click="prevImg()">
        <span class="icon-prev"></span>
      </a>
      <img bn-lazy-src="[[currentImgUrl]]" class="entity-img"/>
      <a class="right carousel-control" ng-show="hasNextImg()" ng-click="nextImg()">
        <span class="icon-next"></span>
      </a>
    </div>
  </script>

  <script type="text/ng-template" id="star-rating-template">
    <div>
      <span ng-repeat="star in [1, 2, 3, 4, 5]">
        <img ng-src="/static/img/star-[[ value >= star ? 'full' : ((star - value >= 1) ? 'empty' : 'half') ]].png"/>
      </span>
    </div>
  </script>

  <script type="text/ng-template" id="infowindow-template">
    <div>
      <div>
        <b>[[entity.data['name'] ]]</b>
      </div>
      <div ng-if="!entity.isPreciseLocation()" class="text-warning infowindow-warning-text">
        Location on map is approximate
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="add-place-modal-template">
    <div ng-controller="AddPlaceModalCtrl" class="add-place-modal">
      <div ng-show="showPlaceSearchInput()">
        <input type="text" class="form-control" placeholder="Search for a place name or address"
          tc-google-place-autocomplete on-place-change="placeChanged($newPlace)"/>
      </div>
      <div ng-show="!showPlaceSearchInput()">
        <a ng-click="forceShowSearchInput()" href="javascript:void(0)">
          <span class="glyphicon glyphicon-chevron-up"></span>
          Search for a different place
        </a>
      </div>
      <div ng-show="!entityModel && !searching" class="add-place-manual-link">
        <a ng-click="forceShowEditInputs()" href="javascript:void(0)">
          Or manually fill in fields
        </a>
      </div>
      <div ng-show="searching">
        <img src="/static/img/spinner.gif"/>
      </div>
      <div ng-show="entityModel">
        Name
        <input type="text" class="form-control" ng-model="entityModel.data['name']"/>
        Address
        <input type="text" class="form-control" ng-model="entityModel.data['address']"/>
        Rating
        <input type="number" class="form-control" ng-model="entityModel.data['rating']"/>
        Source url
        <input type="text" class="form-control" ng-model="entityModel.data['source_url']"/>
        Photo urls (one per line)
        <textarea class="form-control" ng-model="entityModel.rawPhotoUrlText">
        </textarea>
        Description
        <textarea class="form-control" ng-model="entityModel.data['description']">
        </textarea>
        Category
        <select class="form-control" ng-model="entityModel.data['category']"
          ng-options="c['display_name'] for c in categories track by c['category_id']"
          ng-change="categoryChanged()">
        </select>
        SubCategory
        <select class="form-control" ng-model="entityModel.data['sub_category']"
          ng-options="s['display_name'] for s in subCategories track by s['sub_category_id']"
          ng-change="updateMarkerIcon()">
        </select>
        <div class="add-place-modal-map-header">
          Drag the marker to change the location
        </div>
        <div id="add-place-modal-map-container">
          <div id="add-place-modal-map"></div>
        </div>
        <form class="form-inline" role="form">
          Location precision
          <input type="radio" class="form-control" value="Precise" ng-model="entityModel.data['address_precision']" ng-change="updateMarkerIcon()"/>
          Precise
          <input type="radio" class="form-control" value="Imprecise" ng-model="entityModel.data['address_precision']" ng-change="updateMarkerIcon()"/>
          Imprecise
        </form>
        <div class="add-place-save-button">
          <button class="btn btn-info" ng-click="saveNewEntity()">Save</button>
        </div>
      </div>
    </div>
  </script>

  <script>
    initApp({{plan.to_json_str()|safe}},
      {{plan.settings_json()|safe}},
      {{all_trip_plans_settings_json|safe}},
      {{account_info.to_json_str()|safe}},
      {{all_datatype_values.to_json_str()|safe}},
      {{allow_editing|jsbool}});
  </script>
</body>
</html>
