<!doctype html>
<html>
<head>
  <title>{{plan.name}}</title>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="//maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>
  <script src="/static/js/imagesloaded.pkgd.min.js"></script>
  <script src="/static/js/masonry.pkgd.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular.min.js"></script>
  <script src="/static/js/ui-bootstrap-tpls-0.10.9.js"></script>
  <script src="/static/js/angular-masonry.min.js"></script>
  <script src="/static/js/services.js"></script>  
  <script src="/static/js/script.js"></script>
  <link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Roboto:400|Raleway:400">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="shortcut icon" href="/static/img/globe.png">
</head>
<body ng-controller="RootCtrl">
  <nav class="navbar navbar-default navbar-fixed-top" role="navigation" id="travel-clip-navbar">
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="header-navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" id="logo" href="#">TravelClip</a>
      </div>
      <div class="collapse navbar-collapse" id="header-navbar-collapse">
        <ul class="nav navbar-nav" id="header-plan-navigation">
          <li id="trip-plan-title">
            <a href="javascript:void(0)" id="edit-title-link" ng-click="allowEditing && editTripPlanSettings()" ng-show="!editingTripPlanSettings" 
            {% if allow_editing %}
              tooltip="Edit Trip Title" tooltip-placement="bottom"
            {% endif %}
            >
              <span ng-show="!editingTripPlanSettings">[[planModel.tripPlanData['name'] ]]</span>
            </a>
            <form class="form-inline" role="form" ng-submit="saveTripPlanSettings()" ng-show="editingTripPlanSettings">
              <input class="form-control" type="text"
                tc-focus-on="editingTripPlanSettings"
                ng-model="editableTripPlanSettings.name"
                ng-blur="saveTripPlanSettings()"/>
            </form>
          </li>
          <li>
            <ul class="nav nav-pills">
              <li class="view-mode-pill" tooltip="Map" tooltip-placement="bottom">
                <a href="javascript:void(0)" ng-click="showMapView()" 
                ng-class="{'active-view-mode': pageStateModel.inMapView()}">
                  <span class="glyphicon glyphicon-globe" id="header-globe"></span>
                </a>
              </li>
              <li class="view-mode-pill" tooltip="Guide" tooltip-placement="bottom">
                <a href="javascript:void(0)" ng-click="showGuideView()" 
                ng-class="{'active-view-mode': pageStateModel.inGuideView()}">
                  <span class="glyphicon glyphicon-picture" id="header-picture"></span>
                </a>
              </li>
            </ul>
          </li>
          {% if allow_editing %}
            <li>
              <button type="button" class="btn btn-default navbar-btn"
                id="add-place-to-trip-btn" ng-click="toggleOmnibox()">
                Add Place to Trip
              </button>
            </li>
          {% endif %}
        </ul>
        <ul class="nav navbar-nav navbar-right" id="header-site">
          <li>
            <ul class="nav nav-pills">
              <li class="view-mode-pill">
                <a href="javascript:void(0)" ng-click="toggleAccountDropdown()">
                  <span class="glyphicon glyphicon-user" id="header-user"></span>
                </a>
              </li>
            <ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  {% if allow_editing %}
    <div ng-show="omniboxState.visible">
      <div ng-controller="AddPlaceCtrl" class="omnibox-container">
        <div ng-show="!loadingData">
          <div>
            <input type="text" class="form-control" placeholder="Search for a place OR paste a website URL"
            tc-google-place-autocomplete
            tc-focus-on="omniboxState.visible"
            ng-model="rawInputText"
            on-place-change="placeChanged($newPlace)"
            ng-paste="textPasted()"/>
<!--             <div class="add-place-manually-link">
              <a href="javascript:void(0)">Or enter fields manually</a>
            </div> -->
          </div>
        </div>
        <div ng-show="loadingData" id="search-spinner">
          <img src="/static/img/spinner-small.gif"/>
        </div>
      </div>
    </div>
  {% endif %}

  <div ng-show="pageStateModel.inMapView()">
    <div id="entity-container">
      <div ng-repeat="category in orderedCategories">
        <div ng-controller="CategoryCtrl">
          <div ng-if="hasEntities()">
            <div class="one-entity-type">
              <a id="mapview-[[category['name'] ]]" class="offset-anchor"></a>
              <h4 ng-click="toggleSection()" class="entity-type-header">
                <a href="javascript:void(0)">[[category['display_name'] ]]
                  <span ng-show="show" class="glyphicon glyphicon-chevron-down toggle-chevron"></span>
                  <span ng-show="!show" class="glyphicon glyphicon-chevron-up toggle-chevron"></span>
                </a>
              </h4>
              <div class="columns" ng-show="show">
                <div ng-repeat="entityModel in entityModels">
                  <div class="one-entity" ng-mouseenter="openInfowindow(entityModel.data['name'])" ng-controller="EntityCtrl">
                    <div class="one-entity-title">
                      [[entityModel.data['name'] ]]
                    </div>
                    <div ng-include="'carousel-template'">
                    </div>
                    <div class="one-entity-rating">
                      <tc-star-rating value="[[entityModel.data['rating'] ]]">
                      </tc-star-rating>
                    </div>
                    <div class="entity-description"
                      ng-show="entityModel.hasDescription() && !editing">
                      <div style="white-space:pre-wrap">[[entityModel.data['description'] ]]</div>
                    </div>
                    <div ng-if="entityModel.hasLocation() && !entityModel.isPreciseLocation()" class="text-warning entity-info-text">
                      Location approximate
                    </div>
                    <div ng-if="!entityModel.hasLocation()" class="text-warning entity-info-text">
                      Location unavailable
                    </div>
                    <div ng-show="editing">
                      <textarea ng-model="entityModel.data['description']" class="form-control entity-description-input"
                        tc-focus-on="editing">
                      </textarea>
                    </div>
                    <div class="one-entity-source">
                      From <a ng-href="[[entityModel.data['source_url'] ]]" target="_blank">[[entityModel.data['source_url'] | hostname ]]</a>
                    </div>
                    {% if allow_editing %}
                      <div class="entity-edit-controls">
                        <a href="javascript:void(0)"
                          ng-click="openEditEntity()"
                          ng-show="!editing">
                          <span class="glyphicon glyphicon-pencil"></span>
                        </a>
                        <a href="javascript:void(0)"
                          ng-click="openEditPlaceModal()"
                          ng-show="!editing">
                          <span class="glyphicon glyphicon-cog"></span>
                        </a>
                        <a href="javascript:void(0)"
                          ng-click="deleteEntity()"
                          ng-show="!editing">
                          <span class="glyphicon glyphicon-trash"></span>
                        </a>
                        <button class="btn btn-default btn-save-changes" ng-click="saveEntityEdit()" ng-show="editing">Save</button>
                        <a href="javascript:void(0)" ng-click="cancelEditing()" ng-show="editing">
                          Cancel
                        </a>
                      </div>
                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div ng-if="planModel.isEmpty()">
        <div class="getting-started-directions">
          <div class="welcome">
            Welcome to your New Trip Plan
          </div>
          <a href="javascript:(function(){c=document.createElement('script');c.type='text/javascript';c.src='{{bookmarklet_url}}'+'?'+Math.floor(Math.random()*99999999);document.body.appendChild(c);})();">
            <button class="btn btn-info" id="btn-bookmarklet">
              Travel Clipper
            </button>
          </a> <-- If you haven't already, drag me to your Bookmarks Bar
          <div class="step">
            Step 1
          </div>
          <p>
            Pick a travel destination then browse popular travel websites for hotel, restaurant, and attraction options
          </p>
          <p>
            Try these supported sites - 
            <a href="http://www.hotels.com/hotel/details.html?pa=5&pn=1&ps=5&tab=description&destinationId=504261&searchDestination=Paris&hotelId=218097&rooms[0].numberOfAdults=2&roomno=1&validate=false&previousDateful=false&reviewOrder=date_newest_first" target="_blank">Hotels.com</a>, 
            <a href="https://www.airbnb.com/rooms/2095577?s=6yRc" target="_blank">Airbnb</a>, 
            <a href="http://www.tripadvisor.com/Attraction_Review-g187147-d188150-Reviews-Musee_d_Orsay-Paris_Ile_de_France.html" target="_blank">TripAdvisor</a>, 
            <a href="http://www.yelp.com/biz/la-compagnie-des-vins-surnaturels-paris" target="_blank">Yelp</a>
          </p>
          <div class="step">
            Step 2
          </div>
          <p>
            Clip to this Trip Plan by using the clipper or by pasting the URL of the website you want to save in the URL input above
          </p>
          <div class="step">
            Step 3
          </div>
          <p>
            Come back to this Trip Plan and your bookmarked points of interest will instantly be ready for you to browse and manage
          </p>
        </div>
      </div>

      <div class="mapview-footer">
        Copyright 2014 Unicycle Labs
      </div>

    </div>

    <div id="map-container">
      <div id="map">
      </div>
    </div>

  </div>  {# end map view #}

  <div ng-if="pageStateModel.inGuideView()">

    <div class="guideview-container">
      <div ng-repeat="category in orderedCategories">
        <div ng-controller="GuideViewCategoryCtrl">
          <div ng-if="hasEntities()">
            <a id="guideview-[[category['name'] ]]" class="offset-anchor"></a>
            <div class="header-img" id="[[category['name'] ]]-header-img">
              <div class="guideview-entity-type-header">[[category['display_name'] ]]</div>
            </div>
            <div ng-repeat="entityModel in entityModels">
              <div class="guideview-one-entity" ng-controller="EntityCtrl"
                ng-class="{'guideview-entity-even': $even, 'guideview-entity-odd': $odd}">
                <div class="guideview-one-entity-title">
                  <a ng-href="[[entityModel.data['source_url'] ]]" target="_blank">[[entityModel.data['name'] ]]</a>
                </div>
                <div tc-star-rating value="[[entityModel.data['rating'] ]]" class="guideview-star-rating">
                </div tc-star-rating>
                <div ng-controller="GuideViewCarouselCtrl" class="guideview-imgs-showcase">
                  <div masonry="{ transitionDuration: 0, gutter: 6 }">
                    <a class="left carousel-control" ng-show="hasPrevImgs()" ng-click="prevImgs()" style="z-index: 1000">
                      <span class="icon-prev"></span>
                    </a>
                    <div class="masonry-brick guideview-img-masonry-brick" ng-repeat="imgUrl in activeImgUrls()">
                      <img bn-lazy-src="[[imgUrl]]" class="guideview-masonry-img"/>
                    </div>
                    <a class="right carousel-control guideview-carousel-control" ng-show="hasNextImgs()" ng-click="nextImgs()">
                      <span class="icon-next"></span>
                    </a>
                  </div>
                </div>

                <div class="guideview-entity-info">
                  <div class="guideview-entity-description"
                    ng-show="entityModel.hasDescription() && !editing">
                    <div style="white-space:pre-wrap">[[entityModel.data['description'] ]]</div>
                  </div>
                  <div ng-show="editing">
                    <textarea ng-model="entityModel.data['description']"
                      class="form-control guideview-entity-description-input">
                    </textarea>
                  </div>
                  {% if allow_editing %}
                    <div class="guideview-entity-edit-controls">
                      <a href="javascript:void(0)"
                        ng-click="deleteEntity()"
                        ng-show="!editing">
                        <span class="glyphicon glyphicon-trash"></span>
                      </a>
                      <a href="javascript:void(0)"
                        ng-click="openEditEntity()"
                        ng-show="!editing">
                        <span class="glyphicon glyphicon-pencil"></span>
                      </a>
                      <button class="btn btn-save-changes" ng-click="saveEntityEdit()" ng-show="editing">Save</button>
                      <a href="javascript:void(0)" ng-click="cancelEditing()" ng-show="editing">
                        Cancel
                      </a>
                    </div>
                  {% endif %}
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="guideview-footer">
        Copyright 2014 Unicycle Labs
      </div>
    </div>

  </div> {# end guide view #}

  {# This is below the map in the DOM so that it appears visually on top #}
  <ul ng-show="accountDropdownOpen" class="account-dropdown" ng-controller="AccountDropdownCtrl">
    <li class="account-dropdown-login-info">
      <div ng-show="accountInfo.loggedIn && !showLoginForm">
        <span class="logged-in-email">[[accountInfo['email'] ]]</span>
        <span class="logout-link">
          <a href="javascript:void(0)" ng-click="showLoginForm = true">Logout</a>
        </span>
      </div>
      <div ng-show="showLoginForm">
        <form role="form" ng-submit="doLogin()">
          <input type="text" class="form-control email-entry-input"
            ng-model="accountInfo['email']"
            placeholder="Enter your email to login"/>
          <button type="submit()" class="btn btn-default btn-login">Login</button>
        </form>
      </div>
    </li>
    <li ng-show="allTripPlans">
      <div class="my-trip-plans-heading">
        My Trip Plans
      </div>
    </li>
    <li ng-repeat="tripPlan in allTripPlans">
      <span ng-if="tripPlan['trip_plan_id'] == currentTripPlan['trip_plan_id']">
        {# Use the name from the shared info container so it will auto update 
           if the user edits it inline. #}
        [[currentTripPlan['name'] ]]
      </span>
      <span ng-if="tripPlan['trip_plan_id'] != currentTripPlan['trip_plan_id']">
          <a href="javascript:void(0)" ng-click="loadTripPlan(tripPlan['trip_plan_id'])">
            [[tripPlan['name'] ]]
          </a>
        </span>
    </li>
    <li class="create-new-trip-dropdown-link">
      <a href="javascript:void(0)" ng-click="createNewTripPlan()">Create New Trip Plan</a>
    </li>
  </ul>

  <script type="text/ng-template" id="clipping-modal-template">
    <div class="clipping-status-modal">
      <div ng-show="clipState.clipping">
        Clipping to your trip plan...
        <div>
          <img src="/static/img/spinner.gif"/>
        </div>
      </div>
      <div ng-show="!clipState.clipping">
        <div ng-if="clipState.statusCode == 0">
          An error occurred during clipping.  Please try again.
        </div>
        <div ng-if="clipState.statusCode == 1">
          Successfully clipped "[[clipState.entity['name'] ]]""
        </div>
        <div ng-if="clipState.statusCode == 2">
          We don't recognize this website so we've saved this URL for you to clip manually.
        </div>
        <div ng-if="clipState.statusCode == 3">
          You've already clipped this page to your trip plan.
        </div>
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="infowindow-template">
    <div>
      <div>
        <b>[[entity.data['name'] ]]</b>
      </div>
      <div ng-if="!entity.isPreciseLocation()" class="text-warning infowindow-warning-text">
        Location approximate
      </div>
    </div>
  </script>

  <script type="text/ng-template" id="add-place-confirmation-template">
    <div ng-controller="AddPlaceConfirmationCtrl" class="add-place-confirmation">
      <div ng-show="!editingFields">
        <div class="apc-place-name">
          [[ed['name'] ]]
        </div>
        <div class="apc-address">
          [[ed['address'] ]]
        </div>

        <div class="container-fluid">
          <div class="row-fluid">
            <div class="col-md-6 flush-left">
              <div class="apc-photo-container">
                <div ng-include="'carousel-template'">
                </div>
              </div>
              <div class="apc-place-details">
                <div class="apc-rating">
                  <tc-star-rating value="[[ed['rating'] ]]">
                  </tc-star-rating>
                </div>
                <div class="apc-category">
                  Category: [[ed['category']['display_name'] ]]
                </div>
                <div class="apc-sub-category">
                  SubCategory: [[ed['sub_category']['display_name'] ]]
                </div>
              </div>
            </div>
            <div class="col-md-6 flush-right">
              <div ng-show="entityModel.hasLocation()">
                <div id="apc-static-map-container">
                  <div id="apc-static-map"></div>
                </div>
                <div ng-if="!entityModel.isPreciseLocation()" class="text-warning">
                  Location is approximate
                </div>
              </div>
              <div ng-if="!entityModel.hasLocation()" class="text-warning">
                Location unknown
              </div>                
            </div>            
          </div>
        </div>
      </div>

      <div ng-show="editingFields" class="apc-edit-mode">
        <div class="apc-place-name-edit">
          <label>Name</label>
          <input id="apc-edit-name-input" type="text" ng-model="ed['name']" class="form-control apc-edit-input"/>
        </div>
        <div class="apc-address-edit">
          <label>Address</label>
          <input id="apc-edit-address-input" type="text" ng-model="ed['address']" class="form-control apc-edit-input"/>
        </div>
        <div class="container-fluid">
          <div class="row">
            <div class="col-md-6 flush-left">
              <div class="apc-photo-container-edit" ng-controller="EditImagesCtrl">
                <label>Images</label>
                <div class="carousel">
                  <a class="left carousel-control" ng-show="hasPrevImg()" ng-click="prevImg()">
                    <span class="icon-prev"></span>
                  </a>
                  <a class="apc-img-trash-control" ng-click="removeActiveImg()" href="javascript:void(0)">
                    Delete Image<span class="glyphicon glyphicon-trash"></span>
                  </a>
                  <img ng-src="[[currentImgUrl]]" class="entity-img"/>
                  <a class="right carousel-control" ng-show="hasNextImg()" ng-click="nextImg()">
                    <span class="icon-next"></span>
                  </a>
                </div>
                <div class="apc-image-edit-container">
                  <textarea type="text" placeholder="Drag images or paste image Urls to add"
                    class="apc-image-drop-target apc-edit-input"
                    ng-model="photoUrlInputText"
                    ng-paste="photoUrlPasted()"
                    ng-change="photoUrlChanged()"
                    ng-class="{'apc-img-drag-active': imgDragActive}"
                    tc-drag-enter="photoUrlDragEnter($event)"
                    tc-drop="photoUrlDropped($event)"
                    />
                  </textarea>
                </div>                
              </div>
              <div class="apc-place-details-edit">
                <div class="apc-description-edit">
                  <label>Description</label>
                  <textarea class="form-control apc-edit-input" ng-model="ed['description']">
                  </textarea>
                </div>
                <div class="apc-rating-edit">
                  <form class="form-inline" role="form">
                    <label>Rating</label>
                    <input type="number" ng-model="ed['rating']" class="form-control apc-edit-input"/>
                  </form>
                </div>
                <div class="apc-category-edit">
                  <form class="form-inline" role="form">
                    <label>Category</label>
                    <select class="form-control" ng-model="ed['category']"
                      ng-options="c['display_name'] for c in categories track by c['category_id']"
                      ng-change="categoryChanged()">
                    </select>
                  </form>
                </div>
                <div class="apc-sub-category-edit">
                  <form class="form-inline" role="form">
                    <label>SubCategory</label>
                    <select class="form-control" ng-model="entityModel.data['sub_category']"
                      ng-options="s['display_name'] for s in subCategories track by s['sub_category_id']"
                      ng-change="updateMarkerIcon()">
                    </select>
                  </form>
                </div>
              </div>
            </div>
            <div class="col-md-6 flush-right">
              <div class="apc-editable-map">
                <label>Map</label>
                <div id="apc-editable-map-container">
                  <div id="apc-editable-map"></div>
                </div>
                <div class="apc-editable-map-header" ng-show="entityModel.hasLocation()">
                  Drag the marker to change the location
                </div>
                <div ng-if="!entityModel.hasLocation()">
                  <button class="btn btn-info">Add a marker to the map</button>
                </div>
              </div>
              <div class="apc-map-precision-edit">
                <label>Location precision</label>
                <form class="form-inline" role="form">
                  <input type="radio" class="form-control" value="Precise" ng-model="ed['address_precision']" ng-change="updateMarkerIcon()" id="precise-radio"/>
                  <label for="precise-radio" class="light-label">Exact location</label>
                  <input type="radio" class="form-control" value="Imprecise" ng-model="ed['address_precision']" ng-change="updateMarkerIcon()" id="imprecise-radio"/>
                  <label for="imprecise-radio" class="light-label">Approximate location</label>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="apc-controls">
        <div class="apc-control-edit-link">
          <a ng-click="openEditFields()" ng-show="!editingFields" href="javascript:void(0)">Edit</a>
        </div>
        <div class="apc-control-buttons">
          <button class="btn btn-primary" ng-click="saveNewEntity()" ng-show="!isEditOfExistingEntity">
            Add to Trip Plan
          </button>
          <button class="btn btn-primary" ng-click="saveChangesToExistingEntity()" ng-show="isEditOfExistingEntity">
            Save Changes
          </button>          
          <button class="btn btn-default" ng-click="cancelConfirmation()">
            Cancel
          </button>
        </div>
      </div>

    </div>
  </script>

  {% include 'widgets.html' %}

  <script>
    initApp(
      {{plan.to_json_str()|safe}},
      {{entities_json|safe}},
      {{all_trip_plans_json|safe}},
      {{account_info.to_json_str()|safe}},
      {{all_datatype_values.to_json_str()|safe}},
      {{allow_editing|jsbool}});
  </script>
</body>
</html>
