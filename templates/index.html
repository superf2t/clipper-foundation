<!doctype html>
<html>
<head>
  <title>TravelClipper</title>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="//maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>
  <script src="//cdn.jsdelivr.net/underscorejs/1.6.0/underscore-min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular.min.js"></script>
  <script src="/static/js/script.js"></script>
  <link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Raleway:300">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="shortcut icon" href="/static/img/globe.png">
  {% include 'analytics.html' %}

  <style type="text/css">
    .splash-section {
      width: 100%;
      height: 85%;
      position: relative;
      background-size: cover;
      background-repeat: no-repeat;
      background-position: 50% 50%;
      background-image: url('https://lh5.googleusercontent.com/-XFHga-H4op4/UspHQuuPT3I/AAAAAAAAmKQ/tX5v3FY1kwk/w1272-h848-no/IMG_3144.jpg')
    }

    .site-header {
      position: absolute;
      top: 0%;
      width: 100%;
    }

    .logo {
      font: 'Raleway';
      background-color: #000000;
      padding: 6px 10px;
      color: #FFFFFF;
      font-size: 1.3em;
      position: absolute;
      top: 5px;
      left: 5px;
    }

    .login {
      position: absolute;
      top: 5px;
      right: 5px;
    }

    .search-section {
      position: absolute;
      top: 80%;
      left: 0;
      width: 100%;
      z-index: 1;
    }

    .search-input-section {
      width: 500px;
      margin: auto;
    }

    .search-results {
      background-color: #fff;
      max-height: 300px;
      overflow-y: scroll;
    }

    .one-search-result {
      padding: 10px;
      cursor: pointer;
    }

    .one-search-result:hover {
      color: #D0021B;
    }

    .result-icon {
      max-width: 24px;
    }

    .btn-search {
      color: #FFFFFF;
      background-color: #4A90E2;
      padding: 6px 20px;
    }
  </style>

  <script>
    function IndexCtrl($scope, $http, $window) {
      var me = this;
      $scope.searchState = {
        rawInput: null
      };

      {# TODO: Much of this functionality is copied from StartNewTripInputCtrl,
        figure out how to share this instead. #}

      $scope.placeChanged = function($place) {
        if (!$place) {
          return;
        }
        if (!$place['geometry']) {
          return me.searchForPlace($place['name']);
        }
        $scope.selectResult($place);
      };

      $scope.searchButtonClicked = function() {
        if ($scope.searchState.rawInput) {
          me.searchForPlace($scope.searchState.rawInput);
        }
      };

      $scope.selectResult = function(place) {
        var tripPlanDetails = me.placeToTripPlanDetails(place);
        me.saveNewTripPlan(tripPlanDetails)
          .success(function(response) {
            var tripPlanId = response['trip_plans'][0]['trip_plan_id'];
            $window.location.href = '/trip_plan/' + tripPlanId;
          });
      };

      this.searchForPlace = function(query) {
        $scope.searchResults = null;
        $scope.searching = true;
        var request = {
          query: query
        };
        var dummyMap = new google.maps.Map($('<div>')[0], {
          center: new google.maps.LatLng(0, 0)
        });
        var searchService = new google.maps.places.PlacesService(dummyMap);
        searchService.textSearch(request, function(results, status) {
          $scope.$apply(function() {
            $scope.searching = false;
            if (status != google.maps.places.PlacesServiceStatus.OK) {
              alert('Search failed, please try again.');
              return;
            }
            $.each(results, function(i, result) {
              if (result['icon'].indexOf('geocode') >= 0) {
                result['icon'] = '/static/img/place-proximity.svg';
              }
            });
            $scope.searchResults = results;
          });
        });
      };

      this.placeToTripPlanDetails = function(place) {
        var geometry = place['geometry'];
        var location = geometry && geometry['location'];
        var viewport = geometry && geometry['viewport'];
        var tripPlanDetails = {
          'name': place['name'],
          'location_name': place['formatted_address']
        };
        if (location) {
          tripPlanDetails['location_latlng'] = {
            'lat': location.lat(),
            'lng': location.lng()
          };
        }
        if (viewport) {
          tripPlanDetails['location_bounds'] = {
            'southwest': {
              'lat': viewport.getSouthWest().lat(),
              'lng': viewport.getSouthWest().lng()
            },
            'northeast': {
              'lat': viewport.getNorthEast().lat(),
              'lng': viewport.getNorthEast().lng()
            }
          }
        }
        return tripPlanDetails;
      };

      this.saveNewTripPlan = function(tripPlanDetails) {
        var request = {
          'operations': [{
            'operator': 'ADD',
            'trip_plan': tripPlanDetails
          }]
        };
        return $http.post('/tripplanservice/mutate', request)
      };
    }

    angular.module('indexAppModule', [], interpolator)
      .controller('IndexCtrl', IndexCtrl)
      .directive('tcGooglePlaceAutocomplete', tcGooglePlaceAutocomplete)
      .directive('tcTripPlanDetailsHeader', tcTripPlanDetailsHeader);

    angular.element(document).ready(function() {
      angular.bootstrap(document, ['indexAppModule']);
      angular.element('#main-input').focus();
    });
  </script>
</head>
<body ng-controller="IndexCtrl">
  <div class="splash-section">

    <div class="site-header">
      <div class="logo">
        TravelClipper
      </div>
      <div class="login">
        {% if account_info.logged_in %}
        <a href="/profile/{{account_info.user.public_id}}">
          My Trips
        </a>
        {% else %}
        <a href="{{url_for('user.login', next='/trip_plan')}}">
          Login
        </a>
        {% endif %}
      </div>
    </div>

    <div class="search-section">
      <div class="search-input-section">
        <div class="input-group">
          <input type="text" class="form-control search-input" id="main-input"
            ng-model="searchState.rawInput"
            placeholder="Where do you want to go?"
            tc-google-place-autocomplete on-place-change="placeChanged($newPlace)">
          <span class="input-group-btn">
            <button class="btn btn-search" type="button" ng-click="searchButtonClicked()">
              <span class="glyphicon glyphicon-search"></span>
            </button>
          </span>
        </div>
        <div ng-include="'search-results-template'">
        </div>
      </div>
    </div>
  </div>

  <div class="featured-regions-section">
    <div>Browse TOP REGIONS</div>
    <div class="city-container container-fluid">
      <div class="top-cities row">
        {% for config in featured_guide_configs %}
        <a href="/guides/{{config.city_name_url_token}}">
          <div class="top-city col-md-3">
            <div class="city"
              style="background-image: url(&quot;/static/img/index/{{config.city_name_url_token}}.jpg&quot;);">
              <div class="city-metadata">
                <span class="city-name">
                  {{config.city_name}}
                </span>
                <span class="city-guides-number">
                  {{config.trip_plan_ids | length}} Guides
                </span>
              </div>
            </div>
          </div>
        </a>
        {% endfor %}
      </div>
    </div>
  </div>

  <script type="text/ng-template" id="search-results-template">
    <div class="search-results" ng-if="searchResults && searchResults.length">
      <div ng-repeat="result in searchResults" class="one-search-result" ng-click="selectResult(result)">
        <img ng-src="[[result['icon'] ]]" class="result-icon"/>
        [[result['formatted_address'] ]]
      </div>
    </div>
  </script>
</body>
</html>
