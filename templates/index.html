<!doctype html>
<html>
<head>
  <title>TravelClipper</title>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="//maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>
  <script src="//cdn.jsdelivr.net/underscorejs/1.6.0/underscore-min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular.min.js"></script>
  <script src="/static/js/ui-bootstrap-tpls-0.11.0.min.js"></script>
  <script src="/static/js/services.js"></script>
  <script src="/static/js/script.js"></script>
  <link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Raleway:300">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="shortcut icon" href="/static/img/globe.png">
  {% include 'analytics.html' %}

  <style type="text/css">

    html, body {
      width: 100%;
      height: 100%;
      padding: 0;
      margin: 0;
      font-family: 'Avenir', Helvetica, Arial, sans-serif;
    }

    a:hover {
      text-decoration: none;
    }

    a.white-link {
      color: #FFFFFF;
    }

    a.white-link:hover {
      color: #FFFFFF;
    }

    .section-header {
      padding: 30px 0px;
      text-align: center;
      font-size: 1.0em;
      font-weight: 600;
    }

    .lg-text {
      font-size: 1.8em;
    }

    .splash-section {
      background: url('https://lh3.googleusercontent.com/-diOm3evODHI/UspG8vGt9fI/AAAAAAAAmKQ/sb1Cmjy8ZrQ/w1272-h848-no/IMG_5735.jpg') 50% 700px repeat fixed;
      background-size: cover;
      min-height: 60%;
      height: 60%;
      margin: 0 auto;
      width: 100%;
      max-width: 1920px;
      position: relative;
    }

    .site-header {
      position: absolute;
      top: 0%;
      width: 100%;
    }

    .logo {
      font-family: 'Raleway';
      background-color: #000000;
      padding: 4px 6px;
      color: #FFFFFF;
      font-size: 1.2em;
      line-height: 1.0;
      position: absolute;
      top: 5px;
      left: 5px;
    }

    .login {
      position: absolute;
      top: 5px;
      right: 10px;
    }

    .tagline {
      position: absolute;
      margin: 0 auto;
      text-align: center;
      height: 60px;
      top: calc(50% - 30px);
      width: 100%;
      color: #FFFFFF;
      background-color: rgba(0,0,0,0.75);
      font-size: 2.0em;
      line-height: 2.0;
      font-weight: 500;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      -webkit-box-shadow: 0 0 10px rgba(0,0,0,0.3);
      box-shadow: 0 0 5px rgba(255,255,255,0.2);
    }

    .featured-cities-section {
      position: relative;
      margin: 0 auto;
      width: 100%;
      background-color: #FFFFFF;
      -webkit-box-shadow: 0 0 20px rgba(0,0,0,0.7);
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      z-index: 1;
    }

    .featured-cities-section .city-metadata {
      position: relative;
      top: 220px;
      height: 40px;
      margin-bottom: -40px;
      background-color: rgba(0,0,0,0.5);
      color: #FFFFFF;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .featured-cities-section .city {
      width: 100%;
      height: 260px;
      background-repeat: no-repeat;
      background-position: 50% 50%;
      background-size: cover !important;
      -webkit-background-size: cover !important;
      -moz-background-size: cover !important;
      margin-bottom: 30px;
      -webkit-box-shadow: 0 0 3px rgba(0,0,0,0.3);
      box-shadow: 0 0 3px rgba(0,0,0,0.3);
      border-radius: 2px;
    }

    .featured-cities-section .city-name {
      float: left;
      font-size: 1.4em;
      font-weight: 500;
      padding: 6px 10px;
    }

    .featured-cities-section .city-guides-number {
      float: right;
      font-size: 1.1em;
      font-weight: 500;
      padding: 10px;    
    }

    .featured-cities-section .featured-city:hover .city-metadata {
      background-color: rgba(0,0,0,0.25);
    }

    .search-section {
      background: url('https://lh5.googleusercontent.com/-XFHga-H4op4/UspHQuuPT3I/AAAAAAAAmKQ/tX5v3FY1kwk/w1272-h848-no/IMG_3144.jpg') 50% 0px repeat fixed;
      width: 100%;
      max-width: 1920px;
      min-height: 400px;
      height: 400px;
      background-size: cover;
      position: relative;
    }

    .search-section .section-header {
      color: #FFFFFF;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .search-input-section {
      width: 500px;
      margin: auto;
      margin-top: 50px;
      font-size: 1.1em;
    }

    .search-input-section .search-input {
      height: 46px;
    }

    .search-input-section .btn-search {
      color: #FFFFFF;
      height: 46px;
      background-color: #4A90E2;
      padding: 6px 20px;
    }

    .search-results {
      background-color: #FFFFFF;
      max-height: 175px;
      overflow-y: scroll;
    }

    .one-search-result {
      padding: 10px;
      cursor: pointer;
    }

    .one-search-result:hover {
      color: #D0021B;
    }

    .result-icon {
      max-width: 24px;
    }

    .featured-sources-section {
      position: relative;
      width: 100%;
      background-color: #EAEAEA;
      text-align: center;
      -webkit-box-shadow: 0 0 20px rgba(0,0,0,0.7);
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      z-index: 2;
    }

    .featured-source .source-metadata {
      position: relative;
      top: 180px;
      height: 40px;
      margin-bottom: -40px;
      background-color: rgba(0,0,0,0.5);
      color: #FFFFFF;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .featured-source .source {
      width: 100%;
      height: 220px;
      background-repeat: no-repeat;
      background-position: 50% 50%;
      background-size: cover !important;
      -webkit-background-size: cover !important;
      -moz-background-size: cover !important;
      margin-bottom: 30px;
      -webkit-box-shadow: 0 0 3px rgba(0,0,0,0.3);
      box-shadow: 0 0 3px rgba(0,0,0,0.3);
      border-radius: 2px;
    }

    .featured-source .source-name {
      float: left;
      font-size: 1.4em;
      font-weight: 500;
      padding: 6px 10px;
    }

    .featured-source .source-guides-number {
      float: right;
      font-size: 1.1em;
      font-weight: 500;
      padding: 10px;    
    }

    .featured-source:hover .source-metadata {
      background-color: rgba(0,0,0,0.25);
    }

    .more-cities-section {
      background: url('https://lh4.googleusercontent.com/-4hnsKTgPsTo/UspJ9d5jTvI/AAAAAAAAmKQ/C3LqRLrMLVI/w1274-h848-no/IMG_1405.jpg') 50% 0px no-repeat fixed;
      width: 100%;
      max-width: 1920px;
      min-height: 300px;
      height: 400px;
      background-size: cover;
      position: relative;
      color: #FFFFFF;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    a.city-link {
      color: #FFFFFF;
      font-size: 1.2em;
    }

    a.city-link:hover {
      color: #FFFFFF;
      font-weight: 500;
    }

    .footer-section {
      position: relative;
      width: 100%;
      z-index: 3;
      text-align: center;
      -webkit-box-shadow: 0 0 20px rgba(0,0,0,0.7);
      box-shadow: 0 0 20px rgba(0,0,0,0.7);
      height: 200px;
      background-color: #FFFFFF;
      text-align: center;
    }

    .copyright {
      position: relative;
      height: 16px;
      top: calc(50% - 8px);
      color: #777;
      font-size: 1.1em;
    }

  </style>

  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>

  <script>
    function IndexCtrl($scope, $flashedMessages, $eventTracker, $http, $window) {
      var me = this;
      $scope.flashedMessages = $flashedMessages;
      $scope.searchState = {
        rawInput: null,
        // Prevent double-submits
        searchInProgress: false
      };

      {# TODO: Much of this functionality is copied from StartNewTripInputCtrl,
        figure out how to share this instead. #}

      $scope.placeChanged = function($place) {
        if (!$place || $scope.searchState.searchInProgress) {
          return;
        }
        $scope.searchState.searchInProgress = true;
        if (!$place['geometry']) {
          return me.searchForPlace($place['name']);
        }
        $scope.selectResult($place);
        $eventTracker.track({name: 'new-trip-location-autocomplete',
          location: 'homepage', value: $place['name']});
      };

      $scope.searchButtonClicked = function() {
        if ($scope.searchState.rawInput) {
          me.searchForPlace($scope.searchState.rawInput);
        }
      };

      $scope.selectResult = function(place) {
        var tripPlanDetails = me.placeToTripPlanDetails(place);
        me.saveNewTripPlan(tripPlanDetails)
          .success(function(response) {
            var tripPlanId = response['trip_plans'][0]['trip_plan_id'];
            $scope.searchState.searchInProgress = false;
            $window.location.href = '/trip_plan/' + tripPlanId;
          });
        $eventTracker.track({name: 'new-trip-location-result-selected',
          location: 'homepage', value: place['name']});
      };

      this.searchForPlace = function(query) {
        $scope.searchResults = null;
        $scope.searching = true;
        var request = {
          query: query
        };
        var dummyMap = new google.maps.Map($('<div>')[0], {
          center: new google.maps.LatLng(0, 0)
        });
        var searchService = new google.maps.places.PlacesService(dummyMap);
        searchService.textSearch(request, function(results, status) {
          $scope.$apply(function() {
            $scope.searching = false;
            if (status != google.maps.places.PlacesServiceStatus.OK) {
              alert('Search failed, please try again.');
              return;
            }
            $.each(results, function(i, result) {
              if (result['icon'].indexOf('geocode') >= 0) {
                result['icon'] = '/static/img/place-proximity.svg';
              }
            });
            $scope.searchResults = results;
          $scope.searchState.searchInProgress = false;
          });
        });
        $eventTracker.track({name: 'new-trip-location-search',
          location: 'homepage', value: query});
      };

      this.placeToTripPlanDetails = function(place) {
        var geometry = place['geometry'];
        var location = geometry && geometry['location'];
        var viewport = geometry && geometry['viewport'];
        var tripPlanDetails = {
          'name': place['name'],
          'location_name': place['formatted_address']
        };
        if (location) {
          tripPlanDetails['location_latlng'] = {
            'lat': location.lat(),
            'lng': location.lng()
          };
        }
        if (viewport) {
          tripPlanDetails['location_bounds'] = {
            'southwest': {
              'lat': viewport.getSouthWest().lat(),
              'lng': viewport.getSouthWest().lng()
            },
            'northeast': {
              'lat': viewport.getNorthEast().lat(),
              'lng': viewport.getNorthEast().lng()
            }
          }
        }
        return tripPlanDetails;
      };

      this.saveNewTripPlan = function(tripPlanDetails) {
        var request = {
          'operations': [{
            'operator': 'ADD',
            'trip_plan': tripPlanDetails
          }]
        };
        return $http.post('/tripplanservice/mutate', request)
      };
    }

    window['initIndexApp'] = function(flashedMessages) {
      angular.module('indexAppModule', ['navModule'], interpolator)
        .controller('IndexCtrl', IndexCtrl)
        .directive('tcGooglePlaceAutocomplete', tcGooglePlaceAutocomplete)
        .directive('tcTripPlanDetailsHeader', tcTripPlanDetailsHeader)
        .value('$flashedMessages', flashedMessages);

      angular.element(document).ready(function() {
        angular.bootstrap(document, ['indexAppModule']);
      });      
    }

    $(document).ready(function() {
      $window = $(window);

      $('div[data-type="background"]').each(function() {
        var backgroundObject = $(this);
        var currentbackgroundPosition = backgroundObject.css('backgroundPosition').split(" ");
        var currentXPos = currentbackgroundPosition[0];
        var currentYPos = currentbackgroundPosition[1];
        currentYPos = parseInt(currentYPos, 10);

        $(window).scroll(function() {
          var yOffset = -($window.scrollTop() / backgroundObject.data('speed'));
          var backgroundCoordinates = currentXPos + (yOffset + currentYPos)+'px';
          backgroundObject.css({ backgroundPosition: backgroundCoordinates});
        });
      });
    });
  </script>
</head>
<body ng-controller="IndexCtrl">

  <tc-flashed-messages messages="flashedMessages">
  </tc-flashed-messages>

  <div class="splash-section" data-type="background" data-speed="5">
    <div class="site-header">
      <div class="logo">
        TravelClipper
      </div>
      <div class="login">
        {% if account_info.logged_in %}
        <a class="white-link" href="/profile/{{account_info.user.public_id}}">
          My Trips
        </a>
        {% else %}
        <a class="white-link" href="{{url_for('user.login', next='/trip_plan')}}">
          Log In
        </a>
        {% endif %}
      </div>
    </div>
    <div class="tagline">
      Travel guides with interactive maps from reputable sources
    </div>
  </div>

  <div class="featured-cities-section">
    <div class="section-header">
      Browse <span class="lg-text">FEATURED DESTINATIONS</span>
    </div>
    <div class="cities-container container">
      <div class="featured-cities row">
        {% for config in featured_guide_configs %}
        <a href="/guides/{{config.city_name_url_token}}">
          <div class="featured-city col-md-4">
            <div class="city"
              style="background-image: url(&quot;/static/img/index/{{config.city_name_url_token}}.jpg&quot;);">
              <div class="city-metadata">
                <span class="city-name">
                  {{config.city_name}}
                </span>
                <span class="city-guides-number">
                  {{config.trip_plan_ids | length}} Guides
                </span>
              </div>
            </div>
          </div>
        </a>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="search-section" data-type="background" data-speed="10">
    <div class="section-header">
      Plan your <span class="lg-text">NEW TRIP</span>
    </div>
    <div class="search-input-section">
      <div class="input-group">
        <input type="text" class="form-control search-input" id="main-input"
          ng-model="searchState.rawInput"
          placeholder="Where do you want to go?"
          tc-google-place-autocomplete on-place-change="placeChanged($newPlace)">
        <span class="input-group-btn">
          <button class="btn btn-search" type="button" ng-click="searchButtonClicked()">
            New Trip
          </button>
        </span>
      </div>
      <div ng-include="'search-results-template'">
      </div>
    </div>
  </div>

  <div class="featured-sources-section">
    <div class="section-header">
      Browse <span class="lg-text">FEATURED SOURCES</span>
    </div>
    <div class="sources-container container">
      <div class="top-sources row">
        {% for config in featured_profile_configs %}
        <a href="/profile/{{config.profile_name_token}}">
          <div class="featured-source col-md-4">
            <div class="source"
              style="background-image: url(&quot;{{config.icon_url}}&quot;);">
              <div class="source-metadata">
                <span class="source-name">
                  {{config.display_name}}
                </span>
                <span class="source-guides-number">
                  {{config.trip_plan_ids | length}} Guides
                </span>
              </div>
            </div>
          </div>
        </a>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="more-cities-section" data-type="background" data-speed="20">
    <div class="section-header">
      <span class="lg-text">MORE DESTINATIONS</span>
    </div>
    <div class="more-cities-container container">
      <div class="more-cities row">
        {% for config in all_guide_configs %}
        <a class="city-link" href="/guides/{{config.city_name_url_token}}">
          <div class="col-md-3">
            {{config.city_name}}
          </div>
        </a>
        {% endfor %}
      </div>
    </div>    
  </div>
  <div class="footer-section">
    <div class="copyright">
      © Unicycle Labs Inc. All rights reserved.
    </div>
  </div>

  <script type="text/ng-template" id="search-results-template">
    <div class="search-results" ng-if="searchResults && searchResults.length">
      <div ng-repeat="result in searchResults" class="one-search-result" ng-click="selectResult(result)">
        <img ng-src="[[result['icon'] ]]" class="result-icon"/>
        [[result['formatted_address'] ]]
      </div>
    </div>
  </script>

  {% include 'nav.html' %}

  <script>
    initIndexApp({{to_json_str(flashed_messages) | safe}});
  </script>
</body>
</html>
