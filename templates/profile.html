<!doctype html>
<html>
<head>
  <title>{{display_user.display_name}} - TravelClipper</title>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="//maps.googleapis.com/maps/api/js?libraries=places&sensor=false"></script>
  <script src="//cdn.jsdelivr.net/underscorejs/1.6.0/underscore-min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular-sanitize.min.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/1.2.14/angular-animate.min.js"></script>
  <script src="/static/js/ui-bootstrap-tpls-0.11.0.min.js"></script>
  <script src="/static/js/services.js"></script>
  <script src="/static/js/script.js"></script>
  <link type="text/css" rel="stylesheet" href="//fonts.googleapis.com/css?family=Raleway:300">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="shortcut icon" href="/static/img/globe.png">
  {% include 'analytics.html' %}

  <style>
    .main-content {
      position: fixed;
      top: 41px;
      left: 0;
      width: 100%;
      height: calc(100% - 41px);
      overflow-y: auto;
    }

    .trip-plans-container {
      margin: 0 50px;
      text-align: center;
      height: 100%;
    }

    .header {
      text-align: center;
      color: #333;
      padding: 20px 0;
    }

    .header .display-name {
      font-size: 24pt;
    }

    .header .num-trips {
      font-size: 16pt;
    }

    .one-trip-plan {
      display: inline-block;
      width: 350px;
      margin: 0 10px 20px 10px;
      vertical-align: top;
    }

    .map-container {
      width: calc(100% - 100px - 350px);
      height: calc(100% - 115px - 20px);
      float: right;
    }

    .map {
      width: 100%;
      height: 100%;
    }

    .trip-plan-infowindow {
      width: 350px;
    }

    .trip-plan-infowindow .trip-plan-details-header .trip-plan-img {
      height: 200px;
    }
  </style>

  <script>
    function ProfileCtrl($scope, $tripPlans, $allTripPlans,
        $accountInfo, $activeTripPlanState,
        $templateToStringRenderer, $window) {
      // tripPlans refers to the trip plans for the profile user being viewed
      // allTripPlans refers to those belonging to the currently logged-in user.
      // This is confusing, rename these.
      $scope.tripPlans = $tripPlans;
      $scope.allTripPlans = $allTripPlans;
      $scope.accountInfo = $accountInfo;
      $scope.activeTripPlanState = $activeTripPlanState;   

      $scope.mapState = {
        map: null,
        markers: [],
        infowindows: []
      };
      $scope.mapOptions = {
        center: new google.maps.LatLng(0, 0),
        zoom: 3,
        panControl: false,
        scaleControl: true,
        scrollwheel: false,
        streetViewControl: false,
        mapTypeControlOptions: {
          mapTypeIds: [google.maps.MapTypeId.ROADMAP, google.maps.MapTypeId.SATELLITE],
          position: google.maps.ControlPosition.BOTTOM_LEFT
        },
        zoomControlOptions: {
          style: google.maps.ZoomControlStyle.SMALL,
          position: google.maps.ControlPosition.LEFT_BOTTOM
        }
      };

      $scope.setupMap = function($map) {
        $scope.fitBoundsToTripPlans($map, $tripPlans);
        $scope.drawMarkers($map, $tripPlans);
        google.maps.event.addListener($map, 'click', function() {
          $scope.closeAllInfowindows();
        });
      };

      $scope.fitBoundsToTripPlans = function(map, tripPlans) {
        var bounds = new google.maps.LatLngBounds();
        $.each(tripPlans, function(i, tripPlan) {
          if (!_.isEmpty(tripPlan['location_latlng'])) {
            bounds.extend(gmapsLatLngFromJson(tripPlan['location_latlng']));
          }
        });
        if (!bounds.isEmpty()) {
          map.fitBounds(bounds);
        }
      };

      $scope.drawMarkers = function(map, tripPlans) {
        $.each(tripPlans, function(i, tripPlan) {
          if (tripPlan['location_latlng']) {
            $scope.drawMarker(map, tripPlan);
          }
        });
      };

      $scope.drawMarker = function(map, tripPlan) {
        var position = gmapsLatLngFromJson(tripPlan['location_latlng']);
        var marker = new google.maps.Marker({
          map: map,
          position: position
        });
        $scope.mapState.markers.push(marker);
        google.maps.event.addListener(marker, 'click', function() {
          $scope.openInfowindow(map, marker, tripPlan);
        });
      };

      $scope.openInfowindow = function(map, marker, tripPlan) {
        $scope.closeAllInfowindows();
        var scope = $scope.$new(true);
        scope.tripPlan = tripPlan;
        var contentDiv = $templateToStringRenderer.render(
          'profile-infowindow-template', scope, true);
        var infowindow = new google.maps.InfoWindow({
          content: contentDiv[0]
        });
        $scope.mapState.infowindows.push(infowindow);
        infowindow.open(map, marker);
      };

      $scope.closeAllInfowindows = function() {
        $.each($scope.mapState.infowindows, function(i, infowindow) {
          infowindow.close();
        });
        $scope.mapState.infowindows = [];
      };
    }

    window['initProfileApp'] = function(tripPlans, allTripPlans,
        accountInfo, flashedMessages) {
      angular.module('profileInitialDataModule', [])
        .value('$tripPlans', tripPlans)
        .value('$allTripPlans', allTripPlans)
        .value('$accountInfo', accountInfo)
        .value('$flashedMessages', flashedMessages)
        .value('$activeTripPlanState', new ActiveTripPlanStateModel());

      angular.module('profileAppModule',
          ['profileInitialDataModule', 'navModule', 'directivesModule'],
          interpolator)
        .controller('ProfileCtrl', ProfileCtrl)
        .controller('FlashedMessagesCtrl', FlashedMessagesCtrl)
        .service('$templateToStringRenderer', TemplateToStringRenderer)
        .directive('tcTripPlanDetailsHeader', tcTripPlanDetailsHeader);

      angular.element(document).ready(function() {
        angular.bootstrap(document, ['profileAppModule']);
      });
    }
  </script>
</head>
<body ng-controller="ProfileCtrl">
  <tc-nav account-info="accountInfo" active-trip-plan="activeTripPlanState.tripPlan"
    num-entities="activeTripPlanState.numEntities" all-trip-plans="allTripPlans"
    shopping-cart-mode="true">
  </tc-nav>
  <div tc-include-and-replace="flashed-messages-template"></div>

  <div class="main-content">
    <div class="header">
      <div class="display-name">
        {{display_user.display_name}}
      </div>
      <div class="num-trips">
        {{trip_plans|length}} trips
      </div>
    </div>

    <div class="trip-plans-container">
      <div class="map-container">
        <div tc-google-map class="map" map="mapState.map" map-options="mapOptions"
          after-creation="setupMap($map)">
        </div>
      </div>

      <span ng-repeat="tripPlan in tripPlans" class="one-trip-plan">
        <a ng-href="/trip_plan/[[tripPlan['trip_plan_id'] ]]">
          <tc-trip-plan-details-header trip-plan="tripPlan"
            num-entities="tripPlan['num_entities']" for-guide="false">
          </tc-trip-plan-details-header>
        </a>
      </span>
    </div>

  </div>

  <script type="text/ng-template" id="profile-infowindow-template">
    <div class="trip-plan-infowindow">
      <a ng-href="/trip_plan/[[tripPlan['trip_plan_id'] ]]">
        <tc-trip-plan-details-header trip-plan="tripPlan"
          num-entities="tripPlan['num_entities']" for-guide="false">
        </tc-trip-plan-details-header>
      </a>
    </div>
  </script>

  {% include 'nav.html' %}
  {% include 'widgets.html' %}
  {% include 'icons.html' %}
  {% include 'trip_plan_common.html' %}

  <script>
    initProfileApp(
      {{to_json_str(trip_plans) | safe}},
      {{to_json_str(all_user_trip_plans) | safe}},
      {{to_json_str(account_info) | safe}},
      {{to_json_str(flashed_messages) | safe}});
  </script>
</body>
</html>
